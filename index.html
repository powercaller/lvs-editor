<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVS Media Script Editor</title>
    <style>*{box-sizing:border-box}body{background:#1e1e1e;color:#fff;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;min-height:100vh;padding:20px}.container{margin:0 auto;max-width:1400px}.header{margin-bottom:30px;text-align:center}.controls{flex-wrap:wrap;gap:15px;margin-bottom:20px}.control-group,.controls{align-items:center;display:flex}.control-group{background:#2a2a2a;border-radius:6px;gap:8px;padding:8px 12px}button{background:#0078d4;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:14px;padding:8px 16px;transition:background .2s}button:hover:not(:disabled){background:#106ebe}button:disabled{background:#404040;cursor:not-allowed}button.danger{background:#d13438}button.danger:hover:not(:disabled){background:#b71c1c}input[type=file]{display:none}.file-label{background:#6b46c1;border-radius:4px;color:#fff;cursor:pointer;display:inline-block;font-size:14px;padding:8px 16px}.file-label:hover{background:#553c9a}.waveform-container{background:#2a2a2a;border-radius:8px;margin-bottom:20px;padding:12px 20px 20px;position:relative;text-align:center;z-index:1}.waveform-container:before{background:linear-gradient(45deg,rgba(255,107,53,.8) 30%,rgba(255,107,53,.8) 60%,rgba(255,107,53,.8) 100%,transparent 0);border-radius:16px;bottom:-15px;content:"";filter:blur(8px);left:-30px;opacity:0;pointer-events:none;position:absolute;right:-30px;top:45px;transform:scale(.95);transition:all .3s ease;will-change:transform,opacity,filter;z-index:-1}.waveform-header{display:flex;justify-content:space-between;margin-bottom:15px}.time-info{color:#ccc;font-family:monospace}.waveform-canvas{background:#1a1a1a;border-radius:4px;cursor:crosshair;display:block;height:300px;transition:all .2s ease;width:100%}.waveform-canvas.drag-over{background:#2a3f5f;border:2px dashed #0078d4;cursor:copy}.waveform-canvas.dragging{cursor:grabbing!important}.timeline{background:#333;border-radius:4px;cursor:pointer;height:30px;margin-top:10px;position:relative}.timeline.dragging{cursor:grabbing!important}.timeline.dragging .script-event{cursor:grabbing}.playhead{background:#f44;pointer-events:none;transform:translateX(-50%);width:2px;z-index:2}.playhead,.script-events{height:100%;position:absolute;top:0}.script-events{width:100%}.script-event{align-items:center;background:linear-gradient(45deg,#ff8935,#f7931e);border-radius:2px;color:#000;cursor:pointer;display:flex;font-size:10px;font-weight:700;height:100%;justify-content:center;min-width:3px;position:absolute;transform:translateX(-50%);transition:opacity .2s}.script-event:hover{box-shadow:0 0 5px rgba(255,107,53,.8);opacity:.8}.script-event.selected{outline:2px solid #fff;z-index:1}.script-event.grabbable{cursor:grab}.script-event.embedded{background:linear-gradient(45deg,#6b46c1,#9333ea)}.script-event.dragging{opacity:.7;z-index:3}.script-panel{display:flex;gap:20px}.event-list{background:#2a2a2a;border-radius:8px;flex:1;max-height:400px;overflow-y:auto;padding:20px}.event-item{align-items:center;background:#333;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;margin-bottom:8px;padding:12px;transition:background .2s}.event-item:hover{background:#404040}.event-item.selected{background:#0078d4}.event-details{font-family:monospace;font-size:12px}.event-actions{display:flex;gap:5px}.export-import{background:#2a2a2a;border-radius:8px;padding:20px}.export-import div{display:flex;gap:10px;justify-content:center;margin-top:10px}.script-textarea{background:#1a1a1a;border:1px solid #444;border-radius:4px;color:#fff;height:200px;padding:10px;resize:vertical;width:100%}.script-textarea,.status{font-family:monospace;font-size:12px}.status{color:#ccc}.instructions{background:#2a2a2a;border-left:4px solid #0078d4;border-radius:8px;margin-bottom:20px;overflow:hidden;transition:all .3s ease}.instructions-header{align-items:center;cursor:pointer;display:flex;justify-content:space-between;padding:15px;transition:background .2s ease;user-select:none}.instructions-header:hover{background:#333}.instructions-header h3{color:#0078d4;margin:0}.instructions-toggle{color:#0078d4;font-size:18px;font-weight:700;transition:transform .3s ease}.instructions-toggle.expanded{transform:rotate(180deg)}.instructions-content{max-height:0;overflow:hidden;transition:max-height .3s ease}.instructions-content.expanded{max-height:500px}.instructions-list{padding:0 15px 15px}.instruction-item{background:#1e1e1e;margin-bottom:8px;padding:8px 12px}.instruction-number{color:#0078d4;font-weight:700;margin-right:8px}.loading-overlay{align-items:center;backdrop-filter:blur(4px);background:rgba(0,0,0,.8);display:flex;height:100%;justify-content:center;left:0;position:fixed;top:0;width:100%;z-index:10000}.loading-content{background:#2a2a2a;border:2px solid #0078d4;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.6);min-width:300px;padding:30px;text-align:center}.loading-stage{color:#fff;font-size:18px;font-weight:600;margin-bottom:20px}.progress-container{margin-bottom:15px}.progress-bar{background:#1a1a1a;border-radius:4px;height:8px;margin-bottom:10px;overflow:hidden;position:relative;width:100%}.progress-fill{background:linear-gradient(90deg,#0078d4,#00a1f1);border-radius:4px;height:100%;transition:width .3s ease;width:0}.progress-fill.indeterminate{animation:indeterminateProgress 2s ease-in-out infinite;width:30%}@keyframes indeterminateProgress{0%{transform:translateX(-100%)}50%{transform:translateX(350%)}to{transform:translateX(-100%)}}.progress-text{color:#ccc;font-family:monospace;font-size:14px}.loading-spinner{animation:spin 1s ease-in-out infinite;border:2px solid #666;border-radius:50%;border-top-color:#0078d4;display:inline-block;height:20px;margin-left:10px;width:20px}@keyframes spin{to{transform:rotate(1turn)}}.intensity-1:before{filter:blur(6px);opacity:.15}.intensity-2:before{filter:blur(7px);opacity:.2}.intensity-3:before{filter:blur(8px);opacity:.25}.intensity-4:before{filter:blur(9px);opacity:.3}.intensity-5:before{filter:blur(10px);opacity:.35}.intensity-6:before{filter:blur(11px);opacity:.4}.intensity-7:before{filter:blur(12px);opacity:.45}.intensity-8:before{filter:blur(13px);opacity:.5}.intensity-9:before{filter:blur(14px);opacity:.55}.intensity-10:before{filter:blur(15px);opacity:.6}.intensity-11:before{filter:blur(16px);opacity:.65}.intensity-12:before{filter:blur(17px);opacity:.7}.intensity-13:before{filter:blur(18px);opacity:.75}.intensity-14:before{filter:blur(19px);opacity:.8}.intensity-15:before{filter:blur(20px);opacity:.85}.intensity-16:before{filter:blur(21px);opacity:.9}.intensity-17:before{filter:blur(22px);opacity:.95}.intensity-18:before{filter:blur(23px);opacity:1}.intensity-19:before{filter:blur(24px);opacity:1}.intensity-20:before{filter:blur(25px);opacity:1}.drag-preview{align-items:center;background:rgba(0,255,136,.6);border:2px dashed #0f8;border-radius:4px;color:#000;display:flex;font-size:11px;font-weight:700;justify-content:center}.drag-preview,.selection-box{pointer-events:none;position:absolute;z-index:100}.selection-box{background-color:rgba(0,255,136,.2);border:1px solid #0f8;display:none}.mobile-warning{backdrop-filter:blur(4px);background:rgba(0,0,0,.8);color:#fff;display:none;height:100%;left:0;padding:20px;position:fixed;text-align:center;top:0;width:100%;z-index:20000}.mobile-warning .message{background:#2a2a2a;border:2px solid #0078d4;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.6);left:50%;padding:30px;position:absolute;top:50%;transform:translate(-50%,-50%)}@media (max-width:767px){.mobile-warning{align-items:center;display:flex;justify-content:center}}.video-element{border-radius:4px;display:none;max-height:400px;object-fit:contain;width:100%}.waveform-container.video-active .waveform-canvas{height:150px}.video-container{display:inline-block;margin-bottom:10px;position:relative}.video-container:hover .video-btn{opacity:1}.video-controls{align-items:flex-end;bottom:10px;display:flex;gap:8px;position:absolute;right:10px}.video-btn{background:rgba(0,0,0,.6);border:none;border-radius:4px;color:#fff;cursor:pointer;opacity:0;padding:8px 8px 4px;transition:opacity .3s}.speed-control-container,.volume-control-container{position:relative}.speed-control,.volume-control{align-items:center;background:rgba(0,0,0,.8);border-radius:8px;bottom:30px;box-shadow:0 4px 12px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:8px;left:50%;padding:12px;position:absolute;transform:translateX(-50%)}.speed-slider,.volume-slider{-webkit-appearance:none;appearance:none;background:#555;border-radius:3px;cursor:pointer;height:5px;margin:60px -48px;outline:none;transform:rotate(-90deg);width:120px}.speed-slider::-webkit-slider-thumb,.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;background:#0078d4;border-radius:50%;cursor:pointer;height:15px;width:15px}.speed-slider::-moz-range-thumb,.volume-slider::-moz-range-thumb{background:#0078d4;border-radius:50%;cursor:pointer;height:15px;width:15px}#speedValue{background:#2a2a2a;border-radius:4px;color:#fff;font-family:monospace;font-size:12px;padding:2px 6px}.playback-options{background:#2a2a2a;border-radius:8px;padding:20px}.playback-options .option{align-items:center;display:flex;margin-bottom:10px}.playback-options label{margin-left:10px}.playlist-panel{background:#2a2a2a;border-radius:8px;display:flex;flex-direction:column;padding:20px}.playlist-panel h3{margin-top:0}.playlist-container{background:#1a1a1a;border:2px dashed transparent;border-radius:4px;flex-grow:1;max-height:260px;min-height:100px;overflow-y:auto;padding:8px;transition:border-color .3s,background-color .3s}.playlist-container.drag-over{background-color:#2a3f5f;border-color:#0078d4}.playlist-drop-target{align-items:center;color:#666;display:flex;font-style:italic;height:100%;justify-content:center;pointer-events:none}.playlist-item{align-items:center;background:#333;border-radius:4px;cursor:pointer;display:flex;font-size:14px;justify-content:space-between;margin-bottom:8px;padding:10px;transition:background-color .2s}.playlist-item:hover{background:#404040}.playlist-item.playing{background:#0078d4;font-weight:700}.playlist-item-details{align-items:center;display:flex;gap:8px}.playlist-item-icon{font-size:16px}.playlist-item.unlinked .playlist-item-details{color:#fc0}.playlist-item-remove{background:none;border:none;color:#ccc;cursor:pointer;font-size:16px;padding:4px}.playlist-item-remove:hover{color:#f44}.playlist-controls{align-items:center;display:flex;justify-content:space-between;margin-top:15px}.playlist-controls .option{align-items:center;display:flex;gap:8px}.playlist-controls label{user-select:none}#loopBtn{min-width:80px;text-align:center}.playlist-item.drag-over-item{background-color:#0078d4;outline:2px dashed #fff}</style>
</head>

<body>
    <div class="mobile-warning">
        <div class="message">
            <h1>Desktop only...</h1>
            <p>This app was tested on and built for larger screens, you can still use it, but may not work as intended!
            </p>
            <button id="continue-anyway">Yea I get it, let me in!</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>LVS Media Script Editor</h1>
            <p>Create precise haptic scripts synchronized to media</p>
        </div>

        <div class="instructions">
            <div class="instructions-header" id="instructions">
                <h3>How to Use</h3>
                <span class="instructions-toggle" id="instructionsToggle">▼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <div class="instructions-list">
                    <div class="instruction-item">
                        <span class="instruction-number">0.</span>
                        (Optional) Put your device in pairing mode, then click "Connect Device".
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">1.</span>
                        Load an audio or mp4 video file or drag and drop it onto the waveform.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">2.</span>
                        Click on the waveform to add an event. Click the timeline to seek, or hold Shift while dragging
                        for fine-grained seeking.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">3.</span>
                        Use the mouse wheel to zoom. Scroll horizontally to pan, or hold Shift and use the mouse wheel.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">4.</span>
                        Events hold their intensity until the next one.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">5.</span>
                        Press the spacebar or the play/pause button to test the media-haptic sync.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">6.</span>
                        Select events by clicking them. Use Ctrl+click for multi-select, Shift+click for range-select,
                        or drag a box over the waveform. Press Delete to remove selected events.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">7.</span>
                        Use Ctrl+C, Ctrl+X, and Ctrl+V to copy, cut, and paste.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">8.</span>
                        Undo with Ctrl+Z and redo with Ctrl+Shift+Z.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">9.</span>
                        Drag selected events on the waveform to adjust intensity, or on the timeline to adjust time.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">10.</span>
                        Download the synced MP3 or export the script for other formats.
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="loadMedia" class="file-label">Load Media File</label>
                <input type="file" id="loadMedia" accept="audio/*,video/mp4,video/x-matroska,.mkv,.lsx">
            </div>

            <div class="control-group">
                <button id="playPauseBtn" disabled>Play</button>
                <button id="stopBtn" disabled>Stop</button>
            </div>

            <div class="control-group">
                <button id="connectDeviceBtn">Connect Device</button>
                <span id="connectionStatus" style="font-size: 12px; color: #666; margin-left: 8px;">Not connected</span>
            </div>

            <div class="control-group" style="display: none;">
                <button id="zoomInBtn" disabled>Zoom In</button>
                <button id="zoomOutBtn" disabled>Zoom Out</button>
                <button id="zoomFitBtn" disabled>Zoom Fit</button>
            </div>

            <div class="control-group">
                <button id="clearScript" class="danger">Clear Script</button>
            </div>
            <div style="margin-left: auto;">
                <button id="downloadSyncedBtn" disabled>Save Synced File</button>
            </div>
        </div>
        <h3 id="media-fname">Waiting for media file...</h3>
        <div id="waveform" class="waveform-container">
            <div class="waveform-header">
                <div class="status" id="status">
                    Ready - Load a media file to begin
                </div>
                <div class="time-info" id="timeInfo">00:00 / 00:00 | Hover for intensity preview</div>
            </div>
            <div class="video-container">
                <video id="videoElement" class="video-element"></video>
                <div class="video-controls">
                    <div class="speed-control-container">
                        <div id="speedControl" class="speed-control" style="display: none;">
                            <span id="speedValue">1.00x</span>
                            <input type="range" id="speedSlider" min="0.1" max="2" step="0.01" value="1"
                                class="speed-slider">
                        </div>
                        <button id="speedBtn" class="video-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 16 16">
                                      <path d="M6.173 8.851c-0.799 0.92 -0.76 2.348 0.085 3.229 0.472 0.494 1.104 0.74 1.732 0.74 0.616 0 1.228 -0.236 1.696 -0.704 0.213 -0.213 0.38 -0.458 0.494 -0.717l3.095 -5.999c0.082 -0.17 -0.095 -0.347 -0.265 -0.265l-5.999 3.095c-0.311 0.138 -0.596 0.347 -0.838 0.622m1.094 0.845c0.2 -0.2 0.462 -0.301 0.724 -0.301s0.524 0.102 0.727 0.301c0.4 0.4 0.4 1.051 0 1.451 -0.2 0.2 -0.462 0.301 -0.727 0.301 -0.262 0 -0.524 -0.102 -0.724 -0.301 -0.403 -0.403 -0.403 -1.051 0 -1.451m7.149 1.483c0 -1.133 -0.298 -2.246 -0.865 -3.219 -0.219 -0.38 -0.092 -0.865 0.288 -1.084s0.865 -0.092 1.084 0.288c0.704 1.215 1.077 2.603 1.077 4.015 0 0.439 -0.354 0.792 -0.792 0.792 -0.436 0 -0.792 -0.354 -0.792 -0.792M0 11.18C0 6.769 3.589 3.18 8 3.18c1.025 0 2.024 0.19 2.967 0.57 0.406 0.164 0.603 0.622 0.442 1.028 -0.164 0.406 -0.622 0.603 -1.028 0.442 -0.756 -0.301 -1.559 -0.455 -2.381 -0.455 -3.537 0 -6.415 2.878 -6.415 6.415 0 0.439 -0.354 0.792 -0.792 0.792S0 11.619 0 11.18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="volume-control-container">
                        <div id="volumeControl" class="volume-control" style="display: none;">
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1"
                                class="volume-slider">
                        </div>
                        <button id="volumeBtn" class="video-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16">
                                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                                <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                                <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
                              </svg>
                        </button>
                    </div>
                    <button id="fullscreenBtn" class="video-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z" />
                        </svg>
                    </button>
                </div>
            </div>
            <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
            <div id="selectionBox" class="selection-box"></div>
            <div id="timeline" class="timeline">
                <div class="playhead" id="playhead"></div>
                <div class="script-events" id="scriptEvents"></div>
            </div>
        </div>

        <div class="script-panel">
            <div class="event-list">
                <h3>Script Events</h3>
                <div id="eventList"></div>
            </div>

            <div class="playback-options">
                <h3>Playback Options</h3>
                <div class="option">
                    <input type="checkbox" id="softModeCheckbox" name="softMode">
                    <label for="softModeCheckbox">Soft Mode (max intensity 4)</label>
                </div>
            </div>

            <div class="playlist-panel">
                <h3>Playlist</h3>
                <div id="playlist" class="playlist-container">
                    <!-- Playlist items will be added here by JavaScript -->
                    <div class="playlist-drop-target">Drag media and script files here</div>
                </div>
                <div class="playlist-controls">
                    <div class="option">
                        <input type="checkbox" id="autoplayCheckbox" name="autoplay" checked>
                        <label for="autoplayCheckbox">Autoplay</label>
                    </div>
                    <div class="control-group">
                        <button id="loopBtn" title="Looping is off">No Loop</button>
                    </div>
                </div>
            </div>

            <div class="export-import">
                <h3>Funscript Data</h3>
                <textarea id="scriptData" class="script-textarea"
                    placeholder="Script data will appear here..."></textarea>
                <div>
                    <button id="exportBtn">Export Script</button>
                    <label for="scriptFile" class="file-label">Load Script</label>
                    <input type="file" id="scriptFile" accept=".json,.funscript">
                    <button id="importBtn">Update Script</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div id="loadingStage" class="loading-stage">Loading file...</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">Preparing...</div>
                </div>
            </div>
        </div>
    </div>
    <script>(()=>{var R=function(){let f=new Int32Array(256);for(let t=0;t<256;++t){let e=t;for(let i=0;i<8;++i)e&1?e=-306674912^e>>>1:e=e>>>1;f[t]=e}return{buf:function(t,e){let i=e^-1;for(let s=0;s<t.length;++s)i=i>>>8^f[(i^t[s])&255];return(i^-1)>>>0}}}(),x=class{static async create(t,e){let i=await t.arrayBuffer(),s=await e.arrayBuffer(),n=R.buf(new Uint8Array(i)),r=R.buf(new Uint8Array(s)),a=t.name,o=e.name,d=this.createFileHeader(a,i.byteLength,n),c=this.createFileHeader(o,s.byteLength,r),l=this.createCentralDirectory(a,i.byteLength,n,0),h=d.byteLength+i.byteLength,u=this.createCentralDirectory(o,s.byteLength,r,h),m=this.createEndOfCentralDirectory(l.byteLength+u.byteLength,d.byteLength+i.byteLength+c.byteLength+s.byteLength);return new Blob([d,i,c,s,l,u,m])}static createFileHeader(t,e,i){let s=new TextEncoder().encode(t),n=new ArrayBuffer(30+s.length),r=new DataView(n);return r.setUint32(0,67324752,!0),r.setUint16(4,10,!0),r.setUint16(6,0,!0),r.setUint16(8,0,!0),r.setUint16(10,0,!0),r.setUint16(12,0,!0),r.setUint32(14,i,!0),r.setUint32(18,e,!0),r.setUint32(22,e,!0),r.setUint16(26,s.length,!0),r.setUint16(28,0,!0),new Uint8Array(n,30).set(s),n}static createCentralDirectory(t,e,i,s){let n=new TextEncoder().encode(t),r=new ArrayBuffer(46+n.length),a=new DataView(r);return a.setUint32(0,33639248,!0),a.setUint16(4,20,!0),a.setUint16(6,10,!0),a.setUint16(8,0,!0),a.setUint16(10,0,!0),a.setUint16(12,0,!0),a.setUint16(14,0,!0),a.setUint32(16,i,!0),a.setUint32(20,e,!0),a.setUint32(24,e,!0),a.setUint16(28,n.length,!0),a.setUint16(30,0,!0),a.setUint16(32,0,!0),a.setUint16(34,0,!0),a.setUint16(36,0,!0),a.setUint32(38,0,!0),a.setUint32(42,s,!0),new Uint8Array(r,46).set(n),r}static createEndOfCentralDirectory(t,e){let i=new ArrayBuffer(22),s=new DataView(i);return s.setUint32(0,101010256,!0),s.setUint16(4,0,!0),s.setUint16(6,0,!0),s.setUint16(8,2,!0),s.setUint16(10,2,!0),s.setUint32(12,t,!0),s.setUint32(16,e,!0),s.setUint16(20,0,!0),i}static async load(t){let e=await t.arrayBuffer(),i=new DataView(e),s=-1;for(let o=e.byteLength-22;o>=0;o--)if(i.getUint32(o,!0)===101010256){s=o;break}if(s===-1)throw new Error("Invalid LSX file: End of Central Directory not found.");let n=i.getUint16(s+10,!0),r=i.getUint32(s+16,!0),a={};for(let o=0;o<n;o++){let d=new DataView(e,r),c=d.getUint16(28,!0),l=d.getUint32(42,!0),h=new Uint8Array(e,r+46,c),u=new TextDecoder().decode(h),m=new DataView(e,l),p=m.getUint32(18,!0),g=m.getUint16(26,!0),v=m.getUint16(28,!0),y=l+30+g+v,S=new Uint8Array(e,y,p),w=new Blob([S]),b=new File([w],u);u.toLowerCase().endsWith(".funscript")?a.scriptFile=b:a.videoFile=b,r+=46+c}return a}};var C=class{constructor(t){this.editor=t,this.elements={instructions:document.getElementById("instructions"),instructionsContent:document.getElementById("instructionsContent"),instructionsToggle:document.getElementById("instructionsToggle"),waveformCanvas:document.getElementById("waveformCanvas"),timeline:document.getElementById("timeline"),scriptData:document.getElementById("scriptData"),waveformContainer:document.getElementById("waveform"),status:document.getElementById("status"),loadingOverlay:document.getElementById("loadingOverlay"),loadingStage:document.getElementById("loadingStage"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText"),connectDeviceBtn:document.getElementById("connectDeviceBtn"),connectionStatus:document.getElementById("connectionStatus"),playPauseBtn:document.getElementById("playPauseBtn"),stopBtn:document.getElementById("stopBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomFitBtn:document.getElementById("zoomFitBtn"),downloadSyncedBtn:document.getElementById("downloadSyncedBtn"),eventList:document.getElementById("eventList"),exportBtn:document.getElementById("exportBtn"),scriptFile:document.getElementById("scriptFile"),importBtn:document.getElementById("importBtn"),selectionBox:document.getElementById("selectionBox"),timeInfo:document.getElementById("timeInfo"),loadMediaBtn:document.getElementById("loadMedia"),playhead:document.getElementById("playhead"),clearScript:document.getElementById("clearScript"),videoElement:document.getElementById("videoElement"),fullscreenBtn:document.getElementById("fullscreenBtn"),speedBtn:document.getElementById("speedBtn"),speedControl:document.getElementById("speedControl"),speedSlider:document.getElementById("speedSlider"),speedValue:document.getElementById("speedValue"),volumeBtn:document.getElementById("volumeBtn"),volumeControl:document.getElementById("volumeControl"),volumeSlider:document.getElementById("volumeSlider"),softModeCheckbox:document.getElementById("softModeCheckbox"),playlistContainer:document.getElementById("playlist"),autoplayCheckbox:document.getElementById("autoplayCheckbox"),loopBtn:document.getElementById("loopBtn")},this.elements.playPauseBtn.addEventListener("click",()=>this.editor.media.togglePlayPause()),this.elements.stopBtn.addEventListener("click",()=>this.editor.media.stop()),this.elements.exportBtn.addEventListener("click",()=>this.editor.scriptManager.exportFunscript()),this.elements.downloadSyncedBtn.addEventListener("click",()=>this.handleDownloadSynced()),this.elements.importBtn.addEventListener("click",()=>this.editor.scriptManager.updateScriptFromTextarea()),this.elements.scriptFile.addEventListener("change",n=>this.editor.scriptManager.importScript(n.target.files[0])),this.elements.loadMediaBtn.addEventListener("change",n=>this.editor.loadFile(n.target.files[0])),this.elements.clearScript.addEventListener("click",()=>this.editor.scriptManager.clearScript()),this.elements.instructions.addEventListener("click",()=>this.toggleInstructions()),this.elements.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.elements.connectDeviceBtn.addEventListener("click",()=>this.editor.bluetooth.handleDeviceConnection()),this.elements.softModeCheckbox.addEventListener("change",()=>this.editor.canvas.drawWaveform()),this.elements.playlistContainer.addEventListener("click",n=>this.editor.playlistManager.handleClick(n)),this.elements.loopBtn.addEventListener("click",()=>this.editor.playlistManager.toggleLoopState()),this.elements.autoplayCheckbox.addEventListener("change",n=>this.editor.playlistManager.setAutoplay(n.target.checked));let e=this.elements.speedBtn.parentElement;e.addEventListener("mouseenter",()=>{this.toggleSpeedControl()}),e.addEventListener("mouseleave",()=>{this.toggleSpeedControl()}),this.elements.speedSlider.addEventListener("input",n=>this.updateSpeed(n.target.value));let i=this.elements.volumeBtn.parentElement;i.addEventListener("mouseenter",()=>{this.elements.volumeControl.style.display="block"}),i.addEventListener("mouseleave",()=>{this.elements.volumeControl.style.display="none"}),this.elements.volumeBtn.addEventListener("click",n=>{n.stopPropagation(),this.editor.media.toggleMute()}),this.elements.volumeSlider.addEventListener("input",n=>this.updateVolume(n.target.value)),document.addEventListener("click",n=>{!this.elements.speedControl.contains(n.target)&&!this.elements.speedBtn.contains(n.target)&&(this.elements.speedControl.style.display="none")});let s=document.getElementById("continue-anyway");s&&s.addEventListener("click",()=>{document.querySelector(".mobile-warning").style.display="none"})}async handleDownloadSynced(){if(!this.editor.media){alert("No media file loaded.");return}this.editor.media.downloadSynced()}updateVolume(t){this.editor.media.setVolume(t)}updateSpeed(t){this.elements.speedValue.textContent=`${parseFloat(t).toFixed(2)}x`,this.editor.media.setPlaybackRate(t)}toggleSpeedControl(){let t=this.elements.speedControl.style.display==="block";this.elements.speedControl.style.display=t?"none":"block"}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.elements.videoElement.requestFullscreen().catch(t=>{alert(`Error attempting to enable full-screen mode: ${t.message} (${t.name})`)})}toggleInstructions(){let t=this.elements.instructionsContent,e=this.elements.instructionsToggle;t.classList.contains("expanded")?(t.classList.remove("expanded"),e.classList.remove("expanded")):(t.classList.add("expanded"),e.classList.add("expanded"))}updateStatus(t){this.elements.status.textContent=t}showLoadingOverlay(){this.elements.loadingOverlay.style.display="flex"}hideLoadingOverlay(){this.elements.loadingOverlay.style.display="none"}updateLoadingStage(t,e=!1){this.elements.loadingStage.textContent=t,e?(this.elements.progressFill.classList.add("indeterminate"),this.elements.progressFill.style.width="30%"):(this.elements.progressFill.classList.remove("indeterminate"),this.elements.progressFill.style.width="0%",this.elements.progressText.textContent="0%")}updateLoadingProgress(t){this.elements.progressFill.classList.remove("indeterminate"),this.elements.progressFill.style.width=`${t}%`,this.elements.progressText.textContent=`${Math.round(t)}%`}updateConnectionStatus(t,e=""){t?(this.elements.connectDeviceBtn.textContent="Disconnect",this.elements.connectDeviceBtn.style.background="#d13438",this.elements.connectionStatus.textContent=`Connected: ${e}`,this.elements.connectionStatus.style.color="#00ff88"):(this.elements.connectDeviceBtn.textContent="Connect Device",this.elements.connectDeviceBtn.style.background="#0078d4",this.elements.connectionStatus.textContent="Not connected",this.elements.connectionStatus.style.color="#666")}updateEventList(){let t=this.elements.eventList;t.innerHTML="",this.editor.scriptManager.script.forEach((e,i)=>{let s=document.createElement("div");s.className="event-item",this.editor.scriptManager.selectedEventIndices.includes(i)&&s.classList.add("selected"),s.innerHTML=`
                <div class="event-details">
                    ${this.editor.media.formatTime(e.time)} | Intensity: ${e.intensity}
                </div>
                <div class="event-actions">
                    <button class="danger" style="padding: 4px 8px; font-size: 12px;">\xD7</button>
                </div>
            `;let n=s.querySelector(".danger");n.onclick=()=>{this.editor.scriptManager.removeScriptEvent(i)},s.onclick=r=>{r.target.matches("button")||(this.editor.input.handleEventSelection(i,r.ctrlKey||r.metaKey,r.shiftKey),this.editor.scriptManager.selectedEventIndices.length===1&&this.editor.media.seekTo(e.time))},t.appendChild(s)}),this.editor.scriptManager.script.length===0&&(t.innerHTML='<div style="color: #666; text-align: center; padding: 20px;">No events yet<br>Click on waveform to add</div>')}updateScriptData(){this.elements.scriptData.value=JSON.stringify(this.editor.scriptManager.getFunscript(),null,2)}updateTimeline(){let t=this.elements.timeline.querySelector("#scriptEvents");t.innerHTML="",this.editor.media.duration&&this.editor.scriptManager.script.forEach((e,i)=>{let s=document.createElement("div");s.className="script-event",this.editor.scriptManager.selectedEventIndices.includes(i)&&(s.classList.add("selected"),s.classList.add("grabbable")),e.embedded&&s.classList.add("embedded"),this.editor.input.isDragging&&this.editor.scriptManager.selectedEventIndices.includes(i)&&s.classList.add("dragging");let n=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,r=(e.time-this.editor.canvas.viewportStart)/n*100,a=.2;r>=0&&r<=100&&(s.style.left=`${r}%`,s.style.width=`${a}%`,s.title=`Time: ${this.editor.media.formatTime(e.time)}, Intensity: ${e.intensity}`,t.appendChild(s))})}updateVisualization(){this.editor.canvas.drawWaveform(),this.updateTimeline(),this.updatePlayhead()}updatePlayhead(){if(!this.editor.media.duration)return;let t=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,e=(this.editor.media.currentTime-this.editor.canvas.viewportStart)/t*100;e>=0&&e<=100?(this.elements.playhead.style.left=`${e}%`,this.elements.playhead.style.display="block"):this.elements.playhead.style.display="none"}updateGlow(t){let e=this.elements.waveformContainer;for(let i=0;i<=20;i++)e.classList.remove(`intensity-${i}`);t>0&&e.classList.add(`intensity-${t}`)}showHideInterpolationPanel(){let t=document.getElementById("interpolationPanel");this.editor.scriptManager.selectedEventIndices.length===2?t?t.style.display="block":this.createInterpolationPanel():t&&(t.style.display="none")}createInterpolationPanel(){let t=document.createElement("div");t.id="interpolationPanel",t.style.cssText=`
                    position: fixed;
                    top: 200px;
                    right: 30px;
                    background: #2a2a2a;
                    border: 2px solid #0078d4;
                    border-radius: 8px;
                    padding: 15px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    color: #fff;
                    min-width: 250px;
                `,t.innerHTML=`
                    <h4 style="margin: 0 0 10px 0; color: #0078d4;">Interpolation</h4>
                    <div style="margin-bottom: 15px;">
                        <label>Easing Type:</label>
                        <select id="interpolationType" style="width: 100%; padding: 4px; margin-top: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444;">
                            <option value="linear">Linear</option>
                            <option value="easeIn">Ease In</option>
                            <option value="easeOut">Ease Out</option>
                            <option value="easeInOut">Ease In/Out</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="generateInterpolation" style="flex: 1; padding: 8px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">Generate</button>
                        <button id="closeInterpolation" style="padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">\xD7</button>
                    </div>
                `,document.body.appendChild(t),document.getElementById("generateInterpolation").onclick=()=>this.editor.scriptManager.generateInterpolation(),document.getElementById("closeInterpolation").onclick=()=>this.closeInterpolationPanel(),document.getElementById("interpolationType").onchange=()=>{this.updateVisualization()}}closeInterpolationPanel(){let t=document.getElementById("interpolationPanel");t&&(t.style.display="none"),this.editor.scriptManager.selectedEventIndices=[],this.updateVisualization(),this.updateEventList()}updateTimeInfo(t,e){if(this.editor.media.duration>0){let i=t||this.editor.media.currentTime,s=this.editor.media.duration,n=`${this.editor.media.formatTime(i)} / ${this.editor.media.formatTime(s)}`;e!==void 0&&(n+=` | Intensity: ${e}`),this.elements.timeInfo.textContent=n}else this.elements.timeInfo.textContent="00:00:000 / 00:00:000 | Hover for intensity preview"}};var L=class{constructor(t){this.editor=t,this.canvas=this.editor.ui.elements.waveformCanvas,this.ctx=this.canvas.getContext("2d"),this.waveformData=null,this.canvasWidth=0,this.canvasHeight=0,this.canvasTopPadding=20,this.canvasBottomPadding=5,this.viewportStart=0,this.viewportEnd=0,this.zoomLevel=1,window.addEventListener("resize",()=>this.setupCanvas()),this.setupCanvas()}setupCanvas(){let t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1;this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.ctx.scale(e,e),this.canvasWidth=t.width,this.canvasHeight=t.height,this.editor.media&&this.editor.media.audioBuffer?this.editor.ui.updateVisualization():this.drawPlaceholder()}drawPlaceholder(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight);let t=this.canvasWidth/2,e=this.canvasHeight/2;this.ctx.fillStyle="#888",this.ctx.font="18px Arial",this.ctx.textAlign="center",this.ctx.fillText("Load or drag-and-drop a media file here",t,e-10),this.ctx.fillStyle="#666",this.ctx.font="14px Arial",this.ctx.fillText("Video: .mp4, .mkv; Audio: .mp3, .wav, .m4a, and others...",t,e+20),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="#444",this.ctx.font="10px Arial",this.ctx.textAlign="right";let i=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;for(let s=0;s<=20;s+=5){let n=this.canvasTopPadding+(1-s/20)*i;this.ctx.fillText(s.toString(),this.canvasWidth-10,n+3)}this.ctx.restore()}canvasXToTime(t){if(!this.editor.media.duration)return 0;let e=t/this.canvasWidth,i=this.viewportEnd-this.viewportStart;return this.viewportStart+e*i}timeToCanvasX(t){if(!this.editor.media.duration)return 0;let e=this.viewportEnd-this.viewportStart;return(t-this.viewportStart)/e*this.canvasWidth}canvasYToIntensity(t){let e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;if(t<=this.canvasTopPadding)return 20;if(t>=this.canvasHeight-this.canvasBottomPadding)return 0;let i=(t-this.canvasTopPadding)/e;return Math.round((1-i)*20)}intensityToCanvasY(t){let e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding,i=t/20;return this.canvasTopPadding+(1-i)*e}updateViewport(){if(!this.editor.media.duration){this.viewportStart=0,this.viewportEnd=0;return}let t=this.editor.media.duration/this.zoomLevel,e=(this.viewportStart+this.viewportEnd)/2;this.viewportStart=Math.max(0,e-t/2),this.viewportEnd=Math.min(this.editor.media.duration,this.viewportStart+t),this.viewportEnd===this.editor.media.duration&&(this.viewportStart=Math.max(0,this.editor.media.duration-t))}zoomToPoint(t,e){if(!this.editor.media.duration)return;let i=this.zoomLevel;if(this.zoomLevel=Math.max(1,Math.min(100,this.zoomLevel*t)),this.zoomLevel===i)return;let s=this.editor.media.duration/this.zoomLevel;this.viewportStart=Math.max(0,e-s/2),this.viewportEnd=Math.min(this.editor.media.duration,this.viewportStart+s),this.viewportEnd===this.editor.media.duration&&(this.viewportStart=Math.max(0,this.editor.media.duration-s)),this.viewportStart===0&&(this.viewportEnd=Math.min(this.editor.media.duration,s)),this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline();let n=Math.round(this.zoomLevel*100);this.editor.ui.updateStatus(`Zoom: ${n}% | Viewing: ${this.editor.media.formatTime(this.viewportStart)} - ${this.editor.media.formatTime(this.viewportEnd)}`)}zoomFit(){this.editor.media.duration&&(this.zoomLevel=1,this.viewportStart=0,this.viewportEnd=this.editor.media.duration,this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline(),this.editor.ui.updateStatus(`Zoom: 100% | Showing full duration: ${this.editor.media.formatTime(this.editor.media.duration)}`))}panViewportHorizontally(t){if(!this.editor.media.duration)return;let e=this.viewportEnd-this.viewportStart;this.viewportStart=Math.max(0,Math.min(this.editor.media.duration-e,this.viewportStart+t)),this.viewportEnd=this.viewportStart+e,this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline();let i=Math.round(this.zoomLevel*100);this.editor.ui.updateStatus(`Zoom: ${i}% | Viewing: ${this.editor.media.formatTime(this.viewportStart)} - ${this.editor.media.formatTime(this.viewportEnd)}`)}generateWaveformData(){let t=this.editor.media.audioBuffer.getChannelData(0),e=t.length,i=this.editor.media.audioBuffer.sampleRate,s=this.viewportEnd-this.viewportStart,n=Math.floor(this.viewportStart*i),r=Math.min(e,Math.floor(this.viewportEnd*i)),a=r-n,o=this.canvas.width/(window.devicePixelRatio||1),d=Math.max(1,Math.floor(a/o));this.waveformData=[];for(let c=0;c<o;c++){let l=n+c*d,h=Math.min(r,l+d),u=0,m=0;if(l<e&&h>l)for(let p=l;p<h;p++){let g=t[p];g<u&&(u=g),g>m&&(m=g)}this.waveformData.push({min:u,max:m})}}async generateWaveformDataChunked(){let t=this.editor.media.audioBuffer.getChannelData(0),e=t.length,i=this.editor.media.audioBuffer.sampleRate,s=this.viewportEnd-this.viewportStart,n=Math.floor(this.viewportStart*i),r=Math.min(e,Math.floor(this.viewportEnd*i)),a=r-n,o=this.canvas.width/(window.devicePixelRatio||1),d=Math.max(1,Math.floor(a/o));this.waveformData=[];let c=500,l=Math.ceil(o/c);for(let h=0;h<l;h++){let u=h*c,m=Math.min(u+c,o);for(let g=u;g<m;g++){let v=n+g*d,y=Math.min(r,v+d),S=0,w=0;if(v<e&&y>v)for(let b=v;b<y;b++){let P=t[b];P<S&&(S=P),P>w&&(w=P)}this.waveformData.push({min:S,max:w})}let p=(h+1)/l*100;this.editor.ui.updateLoadingProgress(p),h<l-1&&await new Promise(g=>requestAnimationFrame(g))}}drawWaveform(){if(this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),!this.waveformData)return;this.drawIntensityZones(),this.ctx.strokeStyle="#4a9eff",this.ctx.lineWidth=1,this.ctx.beginPath();let t=this.canvasHeight/2,e=(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding)*.35;for(let i=0;i<this.waveformData.length;i++){let{min:s,max:n}=this.waveformData[i],r=i,a=t+s*e,o=t+n*e;this.ctx.moveTo(r,a),this.ctx.lineTo(r,o)}this.ctx.stroke(),this.drawScriptEventsOnWaveform()}drawIntensityZones(){let e=(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding)/21;this.ctx.save(),this.ctx.globalAlpha=.1;for(let s=0;s<=20;s++){let n=this.intensityToCanvasY(s),r=s/20;s%2===0&&(this.ctx.fillStyle=`rgba(255, 107, 53, ${.1+r*.1})`,this.ctx.fillRect(0,n-e/2,this.canvasWidth,e)),s%5===0&&(this.ctx.fillStyle="#949494",this.ctx.font="10px Arial",this.ctx.textAlign="right",this.ctx.globalAlpha=.8,this.ctx.fillText(s.toString(),this.canvasWidth-5,n+3),this.ctx.globalAlpha=.1)}this.ctx.restore();let i=this.intensityToCanvasY(10);this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(this.canvasWidth,i),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.save(),this.ctx.globalAlpha=.05,this.ctx.fillStyle="#666",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasTopPadding),this.ctx.fillRect(0,this.canvasHeight-this.canvasBottomPadding,this.canvasWidth,this.canvasBottomPadding),this.ctx.restore()}drawScriptEventsOnWaveform(){if(!this.editor.media.duration)return;let t=this.editor.scriptManager.script,e=new Set;for(let i=0;i<t.length-1;i++)t[i+1].time-t[i].time<.04&&(e.add(i),e.add(i+1));t.forEach((i,s)=>{let n=this.timeToCanvasX(i.time),r=this.intensityToCanvasY(i.intensity),a=this.editor.scriptManager.selectedEventIndices.includes(s),o=this.editor.input.isDragging&&a,d=e.has(s),c="#d13438",l="#00ff88",m=a?l:i.embedded?"#6b46c1":"#ff8935";d&&(m=c),this.ctx.strokeStyle=m,this.ctx.lineWidth=a?4:3,this.ctx.beginPath(),this.ctx.moveTo(n,this.canvasHeight),this.ctx.lineTo(n,r),this.ctx.stroke(),this.ctx.fillStyle=m,this.ctx.beginPath(),this.ctx.arc(n,r,a?6:4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=a?l:"#fff",this.ctx.font=a?"bold 12px Arial":"12px Arial",this.ctx.textAlign="center",this.ctx.fillText(i.intensity.toString(),n,r-(a?12:10)),a&&!o&&(this.ctx.strokeStyle=l,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n,r,10,0,Math.PI*2),this.ctx.stroke()),o&&(this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=3,this.ctx.setLineDash([4,4]),this.ctx.beginPath(),this.ctx.arc(n,r,12,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]))}),this.editor.input.isDragging||this.drawInterpolationPreview()}drawInterpolationPreview(){if(this.editor.scriptManager.selectedEventIndices.length!==2)return;let[t,e]=this.editor.scriptManager.selectedEventIndices,i=this.editor.scriptManager.script[t],s=this.editor.scriptManager.script[e],n=this.timeToCanvasX(i.time),r=this.intensityToCanvasY(i.intensity),a=this.timeToCanvasX(s.time),o=this.intensityToCanvasY(s.intensity),d=document.getElementById("interpolationType"),c=d?d.value:"linear";this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([8,4]),this.ctx.beginPath();let l=50;for(let h=0;h<=l;h++){let u=h/l,m=this.editor.scriptManager.applyEasing(u,c),p=n+(a-n)*u,g=r+(o-r)*m;h===0?this.ctx.moveTo(p,g):this.ctx.lineTo(p,g)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(0, 255, 136, 0.6)";for(let h=5;h<=l-5;h+=5){let u=h/l,m=this.editor.scriptManager.applyEasing(u,c),p=n+(a-n)*u,g=r+(o-r)*m;this.ctx.beginPath(),this.ctx.arc(p,g,2,0,Math.PI*2),this.ctx.fill()}if(d){let h=(n+a)/2,u=this.editor.scriptManager.applyEasing(.5,c),m=r+(o-r)*u;this.ctx.fillStyle="rgba(0, 255, 136, 0.9)",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText(c.replace(/([A-Z])/g," $1"),h,m-15)}}};var E=class f{constructor(){if(this.constructor===f)throw new Error("Abstract classes can't be instantiated.")}execute(){throw new Error("Method 'execute()' must be implemented.")}undo(){throw new Error("Method 'undo()' must be implemented.")}},D=class extends E{constructor(t,e){super(),this.scriptManager=t,this.event=e,this.index=-1}execute(){this.scriptManager.script.push(this.event),this.scriptManager.script.sort((t,e)=>t.time-e.time),this.index=this.scriptManager.script.indexOf(this.event)}undo(){this.scriptManager.script.splice(this.index,1)}},B=class extends E{constructor(t,e){super(),this.scriptManager=t,this.events=e}execute(){this.events.forEach(t=>{let e=this.scriptManager.script.indexOf(t);e!==-1&&this.scriptManager.script.splice(e,1)})}undo(){this.events.forEach(t=>{this.scriptManager.script.push(t)}),this.scriptManager.script.sort((t,e)=>t.time-e.time)}},F=class extends E{constructor(t,e,i,s){super(),this.scriptManager=t,this.events=e,this.timeDelta=i,this.intensityDelta=s}execute(){this.scriptManager.script.sort((t,e)=>t.time-e.time)}undo(){this.events.forEach(t=>{t.time-=this.timeDelta,t.intensity-=this.intensityDelta}),this.scriptManager.script.sort((t,e)=>t.time-e.time)}},k=class extends E{constructor(t,e,i,s){super(),this.scriptManager=t,this.startIndex=e,this.endIndex=i,this.newEvents=s,this.oldEvents=t.script.slice(e,i+1)}execute(){this.scriptManager.script.splice(this.startIndex,this.oldEvents.length,...this.newEvents),this.scriptManager.script.sort((t,e)=>t.time-e.time)}undo(){this.scriptManager.script.splice(this.startIndex,this.newEvents.length,...this.oldEvents),this.scriptManager.script.sort((t,e)=>t.time-e.time)}};var U=class{constructor(t){this.editor=t,this.isDragging=!1,this.isSeeking=!1,this.isSelecting=!1,this.potentialSelection=!1,this.potentialDrag=!1,this.dragType=null,this.dragStartPos={x:0,y:0},this.dragEventStartPositions=[],this.dragThreshold=5,this.dragPreviewElement=null,this.fineScrubbing=!1,this.fineScrubStartTime=0,this.fineScrubStartMouseX=0,this.fineScrubSensitivity=.1,this.hoverTime=null,this.isHoveringWaveform=!1,this.isHoveringTimeline=!1,this.isZooming=!1,this.zoomCenterTime=0,this.zoomTimeout=null,this.selectionAnchor=null,this.initializeEventListeners()}initializeEventListeners(){this.editor.ui.elements.waveformCanvas.addEventListener("mousedown",t=>this.handleCanvasMouseDown(t)),document.addEventListener("mousemove",t=>this.handleDocumentMouseMove(t)),document.addEventListener("mouseup",t=>this.handleDocumentMouseUp(t)),this.editor.ui.elements.waveformCanvas.addEventListener("mouseleave",t=>this.handleCanvasMouseLeave(t)),this.editor.ui.elements.waveformCanvas.addEventListener("wheel",t=>this.handleCanvasWheel(t),{passive:!1}),this.editor.ui.elements.timeline.addEventListener("mousedown",t=>this.handleTimelineMouseDown(t)),this.editor.ui.elements.timeline.addEventListener("mousemove",t=>this.handleTimelineMouseMove(t)),this.editor.ui.elements.timeline.addEventListener("mouseup",t=>this.handleTimelineMouseUp(t)),this.editor.ui.elements.timeline.addEventListener("mouseenter",t=>this.handleTimelineMouseEnter(t)),this.editor.ui.elements.timeline.addEventListener("mouseleave",t=>this.handleTimelineMouseLeave(t)),this.setupDragAndDrop(),document.addEventListener("keydown",t=>this.handleKeyDown(t))}setupDragAndDrop(){let t=this.editor.ui.elements.waveformContainer,e=this.editor.ui.elements.playlistContainer;t.addEventListener("dragover",i=>this.handleWaveformDragOver(i),!1),t.addEventListener("dragenter",i=>this.handleWaveformDragOver(i),!1),t.addEventListener("dragleave",i=>this.handleWaveformDragLeave(i),!1),t.addEventListener("drop",i=>this.handleWaveformDrop(i),!1),e&&(e.addEventListener("dragover",i=>this.handlePlaylistDragOver(i),!1),e.addEventListener("dragenter",i=>this.handlePlaylistDragOver(i),!1),e.addEventListener("dragleave",i=>this.handlePlaylistDragLeave(i),!1),e.addEventListener("drop",i=>this.handlePlaylistDrop(i),!1)),document.addEventListener("dragover",i=>i.preventDefault(),!1),document.addEventListener("drop",i=>i.preventDefault(),!1)}handleWaveformDragOver(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.waveformContainer.classList.add("drag-over")}handleWaveformDragLeave(t){t.preventDefault(),t.stopPropagation(),!(t.relatedTarget&&this.editor.ui.elements.waveformContainer.contains(t.relatedTarget))&&this.editor.ui.elements.waveformContainer.classList.remove("drag-over")}async handleWaveformDrop(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.waveformContainer.classList.remove("drag-over");let e=t.dataTransfer.items;if(!e||e.length===0)return;let i=e[0].webkitGetAsEntry();i.isFile?this.handleFileDrop(i):i.isDirectory&&this.handleDirectoryDrop(i)}handlePlaylistDragOver(t){t.preventDefault(),t.stopPropagation();let e=this.editor.ui.elements.playlistContainer.querySelector(".drag-over-item");if(e&&e.classList.remove("drag-over-item"),t.dataTransfer.types.includes("Files")){let i=t.target.closest(".playlist-item.unlinked");i?(i.classList.add("drag-over-item"),t.dataTransfer.dropEffect="link"):(this.editor.ui.elements.playlistContainer.classList.add("drag-over"),t.dataTransfer.dropEffect="copy")}}handlePlaylistDragLeave(t){t.preventDefault(),t.stopPropagation();let e=this.editor.ui.elements.playlistContainer;if(t.relatedTarget&&e.contains(t.relatedTarget))return;e.classList.remove("drag-over");let i=e.querySelector(".drag-over-item");i&&i.classList.remove("drag-over-item")}async handlePlaylistDrop(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.playlistContainer.classList.remove("drag-over");let e=this.editor.ui.elements.playlistContainer.querySelector(".drag-over-item");e&&e.classList.remove("drag-over-item");let i=t.dataTransfer.items;if(!i||i.length===0)return;let s=t.target.closest(".playlist-item.unlinked"),n=Array.from(t.dataTransfer.files).find(c=>c.name.endsWith(".funscript"));if(s&&n){let c=s.dataset.id;this.editor.playlistManager.linkScriptToItem(c,n);return}let r=[],a=[];for(let c of i){let l=c.webkitGetAsEntry();l&&a.push(this.traverseFileTree(l))}let d=(await Promise.all(a)).flat();d.length>0&&this.editor.playlistManager.addFiles(d)}async traverseFileTree(t){return t.isFile?[await new Promise((e,i)=>t.file(e,i))]:t.isDirectory?new Promise((e,i)=>{t.createReader().readEntries(n=>{let r=n.filter(o=>o.isFile&&!o.name.startsWith("._"));if(r.length>2){this.editor.ui.updateStatus(`Error: Dir "${t.name}" has >2 files.`),e([]);return}let a=r.map(o=>new Promise(d=>o.file(d)));Promise.all(a).then(o=>{let d=o.find(l=>this.isMediaFile(l)),c=o.find(l=>l.name.toLowerCase().endsWith(".funscript"));o.length===1&&(d||c)||o.length===2&&d&&c?e(o):(this.editor.ui.updateStatus(`Error: Dir "${t.name}" has invalid file combination.`),e([]))})},i)}):[]}handleFileDrop(t){t.file(e=>{let i=e.name.toLowerCase();this.isMediaFile(e)?this.editor.loadFile(e):i.endsWith(".funscript")?this.editor.scriptManager.importScript(e):this.editor.ui.updateStatus(`Error: "${e.name}" is not a supported file type.`)})}handleDirectoryDrop(t){t.createReader().readEntries(i=>{if(i=i.filter(n=>!n.name.startsWith("._")),i.length>2){this.editor.ui.updateStatus("Error: Dropped directory should contain at most one media file and one .funscript file.");return}let s=i.map(n=>new Promise((r,a)=>n.file(r,a)));Promise.all(s).then(n=>{let r=n.find(o=>this.isMediaFile(o)),a=n.find(o=>o.name.toLowerCase().endsWith(".funscript"));n.length===2&&r&&a?(this.editor.loadFile(r),this.editor.scriptManager.importScript(a)):n.length===1&&r?this.editor.loadFile(r):n.length===1&&a?this.editor.scriptManager.importScript(a):this.editor.ui.updateStatus("Error: Directory must contain a valid media file and/or a .funscript file.")}).catch(n=>{this.editor.ui.updateStatus(`Error reading directory: ${n.message}`)})})}isMediaFile(t){let e=t.name.toLowerCase();return t.type.startsWith("audio/")||t.type.startsWith("video/")||e.endsWith(".mkv")}getCanvasMousePos(t){let e=this.editor.ui.elements.waveformCanvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}getTimelineMousePos(t){let e=this.editor.ui.elements.timeline.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}handleCanvasMouseDown(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getCanvasMousePos(t),i=this.findEventAtPosition(e.x,e.y);i!==-1?(this.editor.scriptManager.selectedEventIndices.includes(i)?(this.potentialDrag=!0,this.dragStartPos={...e}):(this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey),this.dragStartPos={...e}),t.preventDefault()):(this.potentialSelection=!0,this.dragStartPos=e)}handleDocumentMouseMove(t){let e=this.editor.ui.elements.waveformCanvas.getBoundingClientRect();if(!(t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&t.clientY<=e.bottom)&&!this.isDragging&&!this.isSelecting)return;let s=this.getCanvasMousePos(t);if(this.potentialSelection&&Math.sqrt(Math.pow(s.x-this.dragStartPos.x,2)+Math.pow(s.y-this.dragStartPos.y,2))>this.dragThreshold&&(this.isSelecting=!0,this.potentialSelection=!1,this.editor.ui.elements.selectionBox.style.display="block",!t.ctrlKey&&!t.metaKey&&!t.shiftKey&&(this.editor.scriptManager.selectedEventIndices=[])),this.isSelecting){this.updateSelectionFromBox(s);return}if(!this.isDragging&&(this.potentialDrag||this.dragStartPos)&&this.editor.scriptManager.selectedEventIndices.length>0&&Math.sqrt(Math.pow(s.x-this.dragStartPos.x,2)+Math.pow(s.y-this.dragStartPos.y,2))>this.dragThreshold&&(this.potentialDrag=!1,this.startDrag("canvas",this.dragStartPos)),this.isDragging){this.processDrag(s);return}if(!this.editor.media||!this.editor.media.duration){this.editor.ui.elements.waveformCanvas.style.cursor="default";return}let n=this.findEventAtPosition(s.x,s.y);n!==-1&&this.editor.scriptManager.selectedEventIndices.includes(n)?this.editor.ui.elements.waveformCanvas.style.cursor="grab":this.editor.ui.elements.waveformCanvas.style.cursor="crosshair",this.hoverTime=this.editor.canvas.canvasXToTime(s.x),this.isHoveringWaveform=!0;let r=this.editor.canvas.canvasXToTime(s.x),a=this.editor.canvas.canvasYToIntensity(s.y);this.editor.ui.updateTimeInfo(r,a)}handleDocumentMouseUp(t){if(this.potentialDrag){this.potentialDrag=!1,this.dragStartPos=null;return}if(this.potentialSelection){if(this.potentialSelection=!1,this.editor.scriptManager.selectedEventIndices.length>0&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey)this.editor.scriptManager.selectedEventIndices=[],this.editor.ui.updateStatus("Selection cleared.");else{let e=this.getCanvasMousePos(t),i=this.editor.canvas.canvasXToTime(e.x),s=this.editor.canvas.canvasYToIntensity(e.y);this.editor.scriptManager.addScriptEvent(i,s),this.editor.ui.updateStatus(`Added event at ${this.editor.media.formatTime(i)} with intensity ${s}`)}this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()}this.isSelecting&&(this.isSelecting=!1,this.editor.ui.elements.selectionBox.style.display="none",this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()),this.isDragging&&this.endDrag(),this.dragStartPos=null}handleCanvasMouseLeave(){this.isHoveringWaveform=!1,this.isHoveringTimeline||(this.hoverTime=null)}handleCanvasWheel(t){if(!this.editor.media||!this.editor.media.duration)return;t.preventDefault();let e=.05,i=1.05,s=t.shiftKey?t.deltaY:t.deltaX;if(s!==0){let n=(s>0?1:-1)*(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart)*e;this.editor.canvas.panViewportHorizontally(n)}if(t.deltaY!==0&&!t.shiftKey){if(clearTimeout(this.zoomTimeout),!this.isZooming){this.isZooming=!0;let r=this.editor.ui.elements.waveformCanvas.getBoundingClientRect(),a=t.clientX-r.left;this.zoomCenterTime=this.editor.canvas.canvasXToTime(a)}let n=t.deltaY>0?i:1/i;this.editor.canvas.zoomToPoint(n,this.zoomCenterTime),this.zoomTimeout=setTimeout(()=>{this.isZooming=!1},150)}}handleTimelineMouseDown(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.findTimelineEventAtPosition(e.x);if(i!==-1)this.editor.scriptManager.selectedEventIndices.includes(i)?this.dragStartPos={x:e.x,y:0}:(this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey),this.dragStartPos={x:e.x,y:0}),t.preventDefault(),t.stopPropagation();else{if(this.isSeeking=!0,this.dragStartPos={x:e.x,y:0},t.shiftKey){this.fineScrubbing=!0,this.fineScrubStartMouseX=e.x;let s=this.editor.ui.elements.timeline.getBoundingClientRect().width,n=e.x/s;this.fineScrubStartTime=this.editor.canvas.viewportStart+n*(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart)}else this.fineScrubbing=!1;this.handleTimelineClick(t)}}handleTimelineMouseMove(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.editor.ui.elements.timeline.getBoundingClientRect().width,s=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,n=e.x/i;if(this.hoverTime=this.editor.canvas.viewportStart+n*s,this.isHoveringTimeline=!0,this.isSeeking){let r=this.fineScrubbing,a=t.shiftKey;if(a&&!r&&(this.fineScrubStartMouseX=e.x,this.fineScrubStartTime=this.editor.media.currentTime),this.fineScrubbing=a,this.fineScrubbing){let o=e.x-this.fineScrubStartMouseX,d=s/i,c=o*d*this.fineScrubSensitivity,l=Math.max(0,Math.min(this.editor.media.duration,this.fineScrubStartTime+c));this.editor.media.seekTo(l)}else this.handleTimelineClick(t);return}!this.isDragging&&!this.isSelecting&&this.dragStartPos&&this.editor.scriptManager.selectedEventIndices.length>0&&Math.abs(e.x-this.dragStartPos.x)>this.dragThreshold&&this.startDrag("timeline",this.dragStartPos),this.isDragging&&this.dragType==="timeline"&&this.processDrag({x:e.x,y:0})}handleTimelineMouseUp(){this.isSeeking=!1,this.fineScrubbing=!1,this.dragStartPos=null,this.isDragging&&this.dragType==="timeline"&&this.endDrag()}handleTimelineMouseEnter(){this.isHoveringTimeline=!0}handleTimelineMouseLeave(){this.isHoveringTimeline=!1,this.isHoveringWaveform||(this.hoverTime=null)}handleTimelineClick(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.editor.ui.elements.timeline.getBoundingClientRect().width,s=e.x/i,n=this.editor.canvas.viewportStart+s*(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart);this.editor.media.seekTo(n)}handleEventSelection(t,e,i){if(this.editor.scriptManager.clearPasteState(),i&&this.selectionAnchor!==null){let s=Math.min(this.selectionAnchor,t),n=Math.max(this.selectionAnchor,t);this.editor.scriptManager.selectedEventIndices=[];for(let r=s;r<=n;r++)this.editor.scriptManager.selectedEventIndices.push(r)}else if(e){let s=this.editor.scriptManager.selectedEventIndices.indexOf(t);s!==-1?this.editor.scriptManager.selectedEventIndices.splice(s,1):this.editor.scriptManager.selectedEventIndices.push(t)}else this.editor.scriptManager.selectedEventIndices=[t],this.selectionAnchor=t;this.editor.scriptManager.selectedEventIndices.sort((s,n)=>s-n),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()}findEventAtPosition(t,e){for(let s=0;s<this.editor.scriptManager.script.length;s++){let n=this.editor.scriptManager.script[s],r=this.editor.canvas.timeToCanvasX(n.time),a=this.editor.canvas.intensityToCanvasY(n.intensity);if(Math.sqrt(Math.pow(t-r,2)+Math.pow(e-a,2))<=8)return s}return-1}findTimelineEventAtPosition(t){let e=this.editor.ui.elements.timeline.getBoundingClientRect().width,i=4;for(let s=0;s<this.editor.scriptManager.script.length;s++){let n=this.editor.scriptManager.script[s],r=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,a=(n.time-this.editor.canvas.viewportStart)/r*e;if(Math.abs(t-a)<=i)return s}return-1}startDrag(t,e){return this.editor.scriptManager.selectedEventIndices.length===0?!1:(this.isDragging=!0,this.dragType=t,this.dragStartPos={...e},this.dragEventStartPositions=this.editor.scriptManager.selectedEventIndices.map(i=>({eventObject:this.editor.scriptManager.script[i],originalTime:this.editor.scriptManager.script[i].time,originalIntensity:this.editor.scriptManager.script[i].intensity})),t==="canvas"?this.editor.ui.elements.waveformCanvas.classList.add("dragging"):t==="timeline"&&this.editor.ui.elements.timeline.classList.add("dragging"),!0)}processDrag(t){if(!this.isDragging||this.dragEventStartPositions.length===0)return;let e=t.x-this.dragStartPos.x,i=t.y-this.dragStartPos.y;this.dragType==="canvas"?this.processDragIntensity(i):this.dragType==="timeline"&&this.processDragTime(e),this.editor.ui.updateVisualization()}processDragIntensity(t){let i=20/this.editor.canvas.canvasHeight,s=Math.round(-t*i),n=1/0,r=-1/0;this.dragEventStartPositions.forEach(o=>{n=Math.min(n,o.originalIntensity),r=Math.max(r,o.originalIntensity)});let a=Math.max(-n,Math.min(s,20-r));this.dragEventStartPositions.forEach(o=>{let d=Math.max(0,Math.min(20,o.originalIntensity+a));o.eventObject.intensity=d,o.eventObject.embedded&&d!==o.originalIntensity&&delete o.eventObject.embedded})}processDragTime(t){let i=(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart)/this.editor.canvas.canvasWidth,s=t*i,n=1/0,r=-1/0;this.dragEventStartPositions.forEach(o=>{n=Math.min(n,o.originalTime),r=Math.max(r,o.originalTime)});let a=Math.max(-n,Math.min(s,this.editor.media.duration-r));this.dragEventStartPositions.forEach(o=>{let d=Math.max(0,Math.min(this.editor.media.duration,o.originalTime+a));o.eventObject.time=parseFloat(d.toFixed(3)),o.eventObject.embedded&&d!==o.originalTime&&delete o.eventObject.embedded}),this.editor.scriptManager.script.sort((o,d)=>o.time-d.time),this.updateSelectedIndicesAfterSort()}updateSelectedIndicesAfterSort(){this.editor.scriptManager.selectedEventIndices=this.dragEventStartPositions.map(t=>this.editor.scriptManager.script.indexOf(t.eventObject)).filter(t=>t!==-1),this.editor.scriptManager.selectedEventIndices.sort((t,e)=>t-e)}endDrag(){if(!this.isDragging)return;let t=this.dragEventStartPositions[0].eventObject.time-this.dragEventStartPositions[0].originalTime,e=this.dragEventStartPositions[0].eventObject.intensity-this.dragEventStartPositions[0].originalIntensity,i=new F(this.editor.scriptManager,this.dragEventStartPositions.map(n=>n.eventObject),t,e);this.editor.history.execute(i),this.isDragging=!1,this.dragType=null,this.dragEventStartPositions=[],this.editor.ui.elements.waveformCanvas.classList.remove("dragging"),this.editor.ui.elements.timeline.classList.remove("dragging"),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData();let s=this.editor.scriptManager.selectedEventIndices.length;this.editor.ui.updateStatus(`Moved ${s} event${s>1?"s":""}`)}updateSelectionFromBox(t){let e=this.editor.ui.elements.waveformCanvas,i=this.editor.ui.elements.selectionBox,s=this.dragStartPos.x,n=this.dragStartPos.y,r=Math.max(0,Math.min(e.clientWidth,t.x)),a=Math.max(0,Math.min(e.clientHeight,t.y)),o=Math.min(s,r),d=Math.min(n,a),c=Math.abs(s-r),l=Math.abs(n-a);i.style.left=`${o+e.offsetLeft}px`,i.style.top=`${d+e.offsetTop}px`,i.style.width=`${c}px`,i.style.height=`${l}px`;let h=[];this.editor.scriptManager.script.forEach((p,g)=>{let v=this.editor.canvas.timeToCanvasX(p.time),y=this.editor.canvas.intensityToCanvasY(p.intensity);v>=o&&v<=o+c&&y>=d&&y<=d+l&&h.push(g)});let u=new Set(this.editor.scriptManager.selectedEventIndices),m=new Set(h);(u.size!==m.size||![...u].every(p=>m.has(p)))&&(this.editor.scriptManager.selectedEventIndices=h,this.editor.ui.updateVisualization())}handleKeyDown(t){if(t.target.tagName!=="TEXTAREA")switch(t.key){case" ":t.preventDefault(),this.editor.media.togglePlayPause();break;case"Delete":case"Backspace":this.editor.scriptManager.removeSelectedEvents();break;case"c":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.copySelectedEvents();break;case"x":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.cutSelectedEvents();break;case"v":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.pasteEvents();break;case"z":(t.ctrlKey||t.metaKey)&&(t.shiftKey?this.editor.history.redo():this.editor.history.undo());break;case"y":(t.ctrlKey||t.metaKey)&&this.editor.history.redo();break}}};var M=class{constructor(t){this.editor=t,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.originalFileName="",this.audioContext=null,this.audioBuffer=null}async initializeAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),await this.audioContext.resume())}async loadFile(t){try{this.editor.ui.showLoadingOverlay(),this.editor.scriptManager.clipboard=[],this.editor.scriptManager.clearPasteState(),this.editor.ui.updateLoadingStage("Loading file...",!1),this.editor.ui.updateLoadingProgress(0),await this.initializeAudioContext(),this.originalFileName=t.name,await this._loadSpecifics(t);let e=await t.arrayBuffer();this.editor.ui.updateLoadingStage("Decoding audio...",!0),this.audioBuffer=await this.audioContext.decodeAudioData(e.slice(0)),this.duration=this.audioBuffer.duration,this.editor.canvas.updateViewport(),this.editor.ui.updateLoadingStage("Generating waveform...",!1),await this.editor.canvas.generateWaveformDataChunked(),this.editor.ui.updateLoadingStage("Complete!",!1),this.editor.ui.updateLoadingProgress(100),await new Promise(i=>setTimeout(i,300)),this.editor.ui.hideLoadingOverlay(),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.ui.updateStatus(`Loaded: ${t.name} (${this.formatTime(this.duration)})`),document.getElementById("media-fname").textContent=t.name,this.editor.ui.elements.playPauseBtn.disabled=!1,this.editor.ui.elements.zoomInBtn.disabled=!1,this.editor.ui.elements.zoomOutBtn.disabled=!1,this.editor.ui.elements.zoomFitBtn.disabled=!1,this.editor.ui.updateEventList(),this.editor.ui.updateScriptData()}catch(e){this.editor.ui.hideLoadingOverlay(),this.editor.ui.updateStatus(`Error loading file: ${e.message}`),console.error("Error in loadFile:",e)}}async _loadSpecifics(t){throw new Error("Method '_loadSpecifics()' must be implemented.")}play(){this.isPlaying||(this.editor.ui.elements.softModeCheckbox.checked&&this.editor.scriptManager.updateSoftScript(),this.isPlaying=!0,this.editor.ui.elements.playPauseBtn.textContent="Pause",this.editor.ui.elements.stopBtn.disabled=!1,this.editor.ui.updateStatus("Playing"),this._specificPlay(),this.playbackLoop())}_specificPlay(){throw new Error("Method '_specificPlay()' must be implemented.")}pause(){this.isPlaying&&(this.isPlaying=!1,this.editor.ui.elements.playPauseBtn.textContent="Play",this.editor.ui.updateStatus("Paused"),this._specificPause())}_specificPause(){throw new Error("Method '_specificPause()' must be implemented.")}stop(){this.isPlaying&&this._specificStop(),this.isPlaying=!1,this.currentTime=0,this.editor.ui.elements.playPauseBtn.textContent="Play",this.editor.ui.elements.stopBtn.disabled=!0,this.editor.ui.updateStatus("Stopped"),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.ui.updateGlow(0),setTimeout(()=>this.editor.bluetooth.sendVibration(0),190),this.editor.scriptManager.resetPlaybackTracking()}_specificStop(){throw new Error("Method '_specificStop()' must be implemented.")}seekTo(t){this.currentTime=t,this._specificSeek(t),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.scriptManager.resetPlaybackTracking()}_specificSeek(t){throw new Error("Method '_specificSeek()' must be implemented.")}setPlaybackRate(t){throw new Error("Method 'setPlaybackRate()' must be implemented.")}togglePlayPause(){this.isPlaying?this.pause():this.play()}playbackLoop(){if(!this.isPlaying)return;if(this.updateCurrentTime(),this.isFinished()){this.handleFinished();return}this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo();let t=this.editor.scriptManager.getIntensityAtTime(this.currentTime);t!==this.editor.bluetooth.activeIntensity&&(this.editor.bluetooth.sendVibration(t),this.editor.ui.updateGlow(t)),requestAnimationFrame(()=>this.playbackLoop())}updateCurrentTime(){throw new Error("Method 'updateCurrentTime()' must be implemented.")}isFinished(){throw new Error("Method 'isFinished()' must be implemented.")}handleFinished(){this.pause(),this.currentTime=0,this.editor.ui.updateStatus("Finished"),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.ui.updateGlow(0),this.editor.onMediaFinished()}formatTime(t){if(isNaN(t)||t<0)return"00:00.000";let e=Math.round(t*1e3),i=Math.floor(e/6e4),s=Math.floor(e%6e4/1e3),n=e%1e3;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}.${n.toString().padStart(3,"0")}`}async downloadSynced(){throw new Error("Method 'downloadSynced()' must be implemented.")}destroy(){}};var I=class extends M{constructor(t){super(t),this.source=null,this.pauseTime=0,this.startTime=0,this.originalFileBuffer=null,this.isMP3File=!1}async _loadSpecifics(t){this.isMP3File=t.name.toLowerCase().endsWith(".mp3")||t.type==="audio/mpeg",this.editor.ui.updateLoadingStage("Reading file data...",!1),this.editor.ui.updateLoadingProgress(10);let e=await t.arrayBuffer();this.isMP3File&&(this.originalFileBuffer=e.slice(0)),this.editor.ui.elements.waveformContainer.classList.remove("video-active"),setTimeout(()=>this.editor.canvas.setupCanvas(),222);let i=null;if(this.isMP3File){this.editor.ui.updateLoadingStage("Checking for embedded script...",!1),this.editor.ui.updateLoadingProgress(15);let s=await this.editor.id3Handler.extractScript(e);s&&s.script&&(i=s.script)}if(i&&this.editor.scriptManager.script.length>0){this.editor.ui.hideLoadingOverlay();let s=confirm(`This MP3 contains ${i.length} embedded script events.
You currently have ${this.editor.scriptManager.script.length} events in the editor.

Would you like to keep the current script events?

OK = Merge both scripts
Cancel = Replace with embedded script only`);this.editor.ui.showLoadingOverlay(),s?(this.editor.scriptManager.script.forEach(n=>{n.embedded||(n.embedded=!1)}),i.forEach(n=>{this.editor.scriptManager.script.push({time:n.time,intensity:n.intensity,embedded:!0})}),this.editor.scriptManager.script.sort((n,r)=>n.time-r.time),this.editor.ui.updateStatus(`Merged ${i.length} embedded events with existing script`)):(this.editor.scriptManager.script=i.map(n=>({time:n.time,intensity:n.intensity,embedded:!0})),this.editor.ui.updateStatus(`Loaded ${i.length} embedded events`))}else i&&this.editor.scriptManager.script.length===0&&(this.editor.scriptManager.script=i.map(s=>({time:s.time,intensity:s.intensity,embedded:!0})),this.editor.ui.updateStatus(`Loaded ${t.name} with ${i.length} embedded events`));this.isMP3File&&(this.editor.ui.elements.downloadSyncedBtn.disabled=!1,this.editor.ui.elements.downloadSyncedBtn.textContent="Save Synced MP3")}_specificPlay(){if(this.audioBuffer)try{this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.audioContext.destination),this.startTime=this.audioContext.currentTime,this.source.start(0,this.pauseTime%this.duration)}catch(t){this.editor.ui.updateStatus(`Playback error: ${t.message}`)}}_specificPause(){this.source.stop(),this.pauseTime+=this.audioContext.currentTime-this.startTime}_specificStop(){this.source.stop(),this.pauseTime=0}_specificSeek(t){this.isPlaying?(this.pause(),this.pauseTime=t,this.play()):this.pauseTime=t}updateCurrentTime(){this.isPlaying?this.currentTime=this.pauseTime+(this.audioContext.currentTime-this.startTime):this.currentTime=this.pauseTime}isFinished(){return this.currentTime>=this.duration}async downloadSynced(){if(!this.originalFileBuffer||!this.isMP3File){this.editor.ui.updateStatus("Cannot download: No MP3 file loaded.");return}if(!(this.editor.scriptManager.script.length===0&&!confirm("The script is empty. Do you still want to download the audio without any vibration events?"))){this.editor.ui.updateStatus("Embedding script and preparing download...");try{let t=this.editor.scriptManager.getFunscript(),e=await this.editor.id3Handler.embedScript(this.originalFileBuffer,t);if(e){let i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=this.originalFileName.replace(/(\.mp3)$/i,"_synced$1"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),this.editor.ui.updateStatus("Synced audio downloaded successfully.")}else throw new Error("Failed to embed the script.")}catch(t){this.editor.ui.updateStatus(`Error during download: ${t.message}`),console.error("Download error:",t)}}}destroy(){super.destroy(),this.source&&(this.source.disconnect(),this.source=null),this.originalFileBuffer=null}};var T=class extends M{constructor(t){super(t),this.videoUrl=null}async _loadSpecifics(t){this.editor.ui.elements.waveformContainer.classList.add("video-active"),setTimeout(()=>this.editor.canvas.setupCanvas(),222),this.editor.ui.elements.videoElement.style.display="block",this.editor.ui.elements.fullscreenBtn.style.display="block",this.editor.ui.elements.speedBtn.style.display="block",this.editor.ui.elements.volumeBtn.style.display="block",this.videoUrl=URL.createObjectURL(t),this.editor.ui.elements.downloadSyncedBtn.disabled=!1,this.editor.ui.elements.downloadSyncedBtn.textContent="Save Synced LSX File",this.editor.ui.elements.videoElement.src=this.videoUrl,this.rawFile=t}_specificPlay(){this.editor.ui.elements.videoElement.play()}_specificPause(){this.editor.ui.elements.videoElement.pause()}_specificStop(){this.editor.ui.elements.videoElement.pause(),this.editor.ui.elements.videoElement.currentTime=0}_specificSeek(t){this.editor.ui.elements.videoElement.currentTime=t}setPlaybackRate(t){this.editor.ui.elements.videoElement.playbackRate=t}setVolume(t){this.editor.ui.elements.videoElement.volume=t,this.editor.ui.elements.videoElement.muted=t===0,this.updateVolumeIcon()}toggleMute(){this.editor.ui.elements.videoElement.muted=!this.editor.ui.elements.videoElement.muted,this.updateVolumeIcon()}updateVolumeIcon(){let t=this.editor.ui.elements.videoElement.muted,e=this.editor.ui.elements.volumeBtn;t?e.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-mute" viewBox="0 0 16 16">
                <path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zm7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/>
              </svg>`:e.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16">
                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
              </svg>`}updateCurrentTime(){this.currentTime=this.editor.ui.elements.videoElement.currentTime}isFinished(){return this.editor.ui.elements.videoElement.ended}async downloadSynced(){if(!this.rawFile){alert("No media file loaded.");return}this.editor.ui.showLoadingOverlay(),this.editor.ui.updateLoadingStage("Packaging video and script...",!0);try{let t=this.editor.scriptManager.getFunscript(),e=this.rawFile.name.replace(/\.[^/.]+$/,"")+".funscript",i=new File([JSON.stringify(t,null,2)],e,{type:"application/json"}),s=await x.create(this.rawFile,i),n=document.createElement("a"),r=this.rawFile.name.replace(/\.[^/.]+$/,"")+".lsx";n.href=URL.createObjectURL(s),n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n)}catch(t){console.error("Error creating LSX package:",t),alert("Failed to create LSX package. See console for details.")}finally{this.editor.ui.hideLoadingOverlay()}}destroy(){super.destroy(),this.videoUrl&&(URL.revokeObjectURL(this.videoUrl),this.videoUrl=null);let t=this.editor.ui.elements.videoElement;t.src="",t.removeAttribute("src"),t.load(),t.style.display="none",this.editor.ui.elements.fullscreenBtn.style.display="none",this.editor.ui.elements.speedBtn.style.display="none",this.editor.ui.elements.volumeBtn.style.display="none",this.editor.ui.elements.waveformContainer.classList.remove("video-active"),setTimeout(()=>this.editor.canvas.setupCanvas(),0)}};var A=class{constructor(t){this.editor=t,this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.activeIntensity=0}async handleDeviceConnection(){let t=this.editor.ui.elements.connectDeviceBtn;if(this.device&&this.device.gatt.connected)try{this.device.gatt.disconnect(),this.editor.ui.updateStatus("Device disconnected")}catch(e){this.editor.ui.updateStatus(`Disconnect error: ${e.message}`)}else{t.disabled=!0,t.textContent="Connecting...",this.editor.ui.updateStatus("Connecting to device...");try{await this.connectToDevice()?(this.editor.ui.updateConnectionStatus(!0,this.device.name||"Unknown Device"),this.editor.ui.updateStatus(`Connected to ${this.device.name||"Lovense device"}`)):(this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus("Failed to connect to device"))}catch(e){this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus(`Connection error: ${e.message}`)}t.disabled=!1}}generateLovenseServices(){return["0000fff0-0000-1000-8000-00805f9b34fb","6e400001-b5a3-f393-e0a9-e50e24dcca9e","50300001-0024-4bd4-bbd5-a6920e4c5653","57300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0024-4bd4-bbd5-a6920e4c5653","50300001-0023-4bd4-bbd5-a6920e4c5653","53300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0023-4bd4-bbd5-a6920e4c5653","4f300001-0023-4bd4-bbd5-a6920e4c5653","42300001-0023-4bd4-bbd5-a6920e4c5653","43300001-0023-4bd4-bbd5-a6920e4c5653","4c300001-0023-4bd4-bbd5-a6920e4c5653","4c410001-0023-4bd4-bbd5-a6920e4c5653","56300001-0023-4bd4-bbd5-a6920e4c5653","58300001-0023-4bd4-bbd5-a6920e4c5653","52300001-0023-4bd4-bbd5-a6920e4c5653","46300001-0023-4bd4-bbd5-a6920e4c5653","50300011-0023-4bd4-bbd5-a6920e4c5653","4a300001-0023-4bd4-bbd5-a6920e4c5653","45440001-0023-4bd4-bbd5-a6920e4c5653","45420001-0023-4bd4-bbd5-a6920e4c5653","54300001-0023-4bd4-bbd5-a6920e4c5653","45490001-0023-4bd4-bbd5-a6920e4c5653","4e300001-0023-4bd4-bbd5-a6920e4c5653","45410001-0023-4bd4-bbd5-a6920e4c5653","51300001-0023-4bd4-bbd5-a6920e4c5653","45460001-0023-4bd4-bbd5-a6920e4c5653","454c0001-0023-4bd4-bbd5-a6920e4c5653","55300001-0023-4bd4-bbd5-a6920e4c5653","53440001-0023-4bd4-bbd5-a6920e4c5653","48300001-0023-4bd4-bbd5-a6920e4c5653","46530001-0023-4bd4-bbd5-a6920e4c5653","43410001-0023-4bd4-bbd5-a6920e4c5653","4f430001-0023-4bd4-bbd5-a6920e4c5653","455a0001-0023-4bd4-bbd5-a6920e4c5653"]}async connectToDevice(){try{let t=this.generateLovenseServices();return this.device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"lvs"},{namePrefix:"LVS"},{namePrefix:"lovense"},{namePrefix:"Lovense"},{namePrefix:"LOVENSE"}],optionalServices:t}),this.gattServer=await this.device.gatt.connect(),this.device.addEventListener("gattserverdisconnected",this.onDisconnected.bind(this)),await this.setupCommandChannel(),!0}catch(t){return console.error(`Connection error: ${t.message}`),!1}}async setupCommandChannel(){let t=this.generateLovenseServices();for(let e of t)try{let s=await(await this.gattServer.getPrimaryService(e)).getCharacteristics();for(let n of s)if(n.properties.write||n.properties.writeWithoutResponse){this.commandCharacteristic=n,console.log(`Command characteristic found in service: ${e}`);return}}catch{}console.warn("No command characteristic found in any service")}async sendCommand(t){if(!this.device||!this.device.gatt.connected||!this.commandCharacteristic)return console.warn("Device not connected or characteristic not available"),!1;try{let i=new TextEncoder().encode(t);return await this.commandCharacteristic.writeValueWithoutResponse(i),!0}catch(e){return console.error(`Failed to send command "${t}":`,e),this.editor.ui.updateStatus(`Bluetooth command failed: ${e.message}`),!1}}onDisconnected(){console.log("Device disconnected"),this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus("Device disconnected")}sendVibration(t){t!==this.activeIntensity&&(this.sendCommand(`Vibrate:${t};`),this.activeIntensity=t)}};var $=class{constructor(t){this.editor=t,this.script=[],this.softScript=[],this.selectedEventIndices=[],this.clipboard=[],this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.lastIndex=0,this.isDirty=!0}updateSoftScript(){this.isDirty&&(this.softScript=this.script.map(t=>{let{intensity:e}=t,i;return e<=3?i=e:e>=4&&e<=10?i=Math.floor(3+(e-4)/3):i=Math.floor(4+(e-11)*2/9),{...t,intensity:i}}),this.isDirty=!1)}_syncScript(){console.log("syncing script"),this.isDirty=!0,this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData()}resetPlaybackTracking(){this.lastIndex=0}addScriptEvent(t,e){let i={time:parseFloat(t.toFixed(3)),intensity:e},s=new D(this,i);this.editor.history.execute(s),this._syncScript(),this.editor.ui.updateStatus(`Added event at ${this.editor.media.formatTime(t)} with intensity ${e}`)}removeScriptEvent(t){t>=0&&t<this.script.length&&(this.script.splice(t,1),this.selectedEventIndices=this.selectedEventIndices.map(e=>e>t?e-1:e).filter(e=>e!==t),this._syncScript(),this.editor.ui.showHideInterpolationPanel(),this.editor.ui.updateStatus("Event removed"))}removeSelectedEvents(){if(this.selectedEventIndices.length===0||this.selectedEventIndices.length>3&&!confirm(`Are you sure you want to delete ${this.selectedEventIndices.length} events?`))return;let t=this.selectedEventIndices.map(s=>this.script[s]),e=new B(this,t);this.editor.history.execute(e),this.selectedEventIndices=[],this._syncScript(),this.editor.ui.showHideInterpolationPanel();let i=t.length;this.editor.ui.updateStatus(`Removed ${i} event${i>1?"s":""}`)}copySelectedEvents(){if(this.selectedEventIndices.length===0){this.editor.ui.updateStatus("No events selected to copy");return}let t=this.selectedEventIndices.map(i=>this.script[i]).sort((i,s)=>i.time-s.time),e=t[0].time;this.clipboard=t.map(i=>({time:i.time-e,intensity:i.intensity})),this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.editor.ui.updateStatus(`Copied ${this.clipboard.length} event${this.clipboard.length>1?"s":""}`)}cutSelectedEvents(){if(this.selectedEventIndices.length===0){this.editor.ui.updateStatus("No events selected to cut");return}this.copySelectedEvents();let t=this.selectedEventIndices.length;this.removeSelectedEvents(),this.clipboardFromCut=!0,this.editor.ui.updateStatus(`Cut ${t} event${t>1?"s":""}`)}pasteEvents(){if(!this.editor.media.audioBuffer){this.editor.ui.updateStatus("Load audio file first");return}if(this.clipboard.length===0){this.editor.ui.updateStatus("No events in clipboard");return}let t=this.calculatePastePosition(),e=this.clipboard[this.clipboard.length-1].time;if(t+e>this.editor.media.duration)if(this.clipboardFromCut&&this.lastPasteEndTime===null&&this.editor.input.hoverTime!==null&&(this.editor.input.isHoveringWaveform||this.editor.input.isHoveringTimeline)){if(t=Math.max(0,this.editor.media.duration-e-.1),t<0){this.editor.ui.updateStatus("Cannot paste: clipboard duration exceeds audio length");return}}else{this.editor.ui.updateStatus("Cannot paste: would exceed audio duration");return}this.selectedEventIndices=[];let i=[];this.clipboard.forEach(n=>{let r={time:parseFloat((t+n.time).toFixed(3)),intensity:n.intensity};this.script.push(r),i.push(r)}),this.script.sort((n,r)=>n.time-r.time),this.selectedEventIndices=i.map(n=>this.script.findIndex(r=>r===n)).filter(n=>n!==-1);let s=this.calculateEventSpacing();this.lastPasteEndTime=t+e+s,this.pasteCount++,this.clipboardFromCut=!1,this._syncScript(),this.editor.ui.showHideInterpolationPanel(),this.editor.ui.updateStatus(`Pasted ${this.clipboard.length} event${this.clipboard.length>1?"s":""} at ${this.editor.media.formatTime(t)}`)}calculatePastePosition(){if(this.lastPasteEndTime!==null)return Math.min(this.lastPasteEndTime,this.editor.media.duration);if(this.pasteCount=0,this.selectedEventIndices.length>0){let i=this.selectedEventIndices.map(n=>this.script[n]).sort((n,r)=>r.time-n.time)[0].time,s=this.calculateEventSpacing();return Math.min(i+s,this.editor.media.duration)}if(this.editor.media.isPlaying){let e=this.calculateEventSpacing();return Math.min(this.editor.media.currentTime+e,this.editor.media.duration)}if(this.clipboardFromCut&&this.editor.input.hoverTime!==null&&(this.editor.input.isHoveringWaveform||this.editor.input.isHoveringTimeline))return this.editor.input.hoverTime;let t=(this.editor.canvas.viewportStart+this.editor.canvas.viewportEnd)/2;return Math.min(t,this.editor.media.duration)}calculateEventSpacing(){let t=.5;if(this.clipboard.length>1){let s=this.clipboard[this.clipboard.length-1].time;t=Math.max(.1,s*.1)}let e=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,i=this.editor.media.duration/e;return i>10?t*=.5:i<2&&(t*=2),this.editor.media.duration>300?t*=1.5:this.editor.media.duration<60&&(t*=.5),Math.max(.05,Math.min(2,t))}clearPasteState(){this.lastPasteEndTime=null,this.pasteCount=0}updateScriptData(){this.editor.ui.elements.scriptData.value=JSON.stringify(this.getFunscript(),null,2)}clearScript(){confirm("Clear all script events?")&&(this.script=[],this.selectedEventIndices=[],this.clipboard=[],this.clearPasteState(),this._syncScript(),this.editor.ui.updateStatus("Script cleared"))}exportFunscript(){if(this.script.length===0){alert("No script events to export");return}let t=this.getFunscript(),e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");if(n.href=s,this.editor.media.originalFileName){let r=this.editor.media.originalFileName.replace(/\.[^/.]+$/,"");n.download=`${r}.funscript`}else n.download="lovense_script.funscript";n.click(),URL.revokeObjectURL(s),this.editor.ui.updateStatus("Funscript exported")}getFunscript(){let t=this.script.map(e=>({time:e.time,intensity:e.intensity}));for(;t.length>0&&t[0].intensity===0;)t.shift();return t=t.filter((e,i,s)=>i===0||e.intensity!==s[i-1].intensity),{actions:t.map(e=>({at:Math.round(e.time*1e3),pos:Math.round(100-e.intensity/20*100)}))}}validateScript(t){if(!Array.isArray(t))throw new Error("Invalid script format. Expected an array of events.");for(let e of t){if(typeof e.time!="number"||typeof e.intensity!="number")throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}importScript(t){if(!t)return;let e=new FileReader;e.onload=i=>{try{let s=JSON.parse(i.target.result),n;s.actions?n=s.actions.map(r=>({time:r.at/1e3,intensity:Math.round((100-r.pos)/100*20),embedded:!0})):(this.validateScript(s),n=s),this.script=n.sort((r,a)=>r.time-a.time),this.selectedEventIndices=[],this._syncScript(),this.editor.ui.updateStatus(`Imported ${this.script.length} events from ${t.name}`)}catch(s){alert(`Error importing script file: ${s.message}`)}},e.readAsText(t)}updateScriptFromTextarea(){try{let t=this.editor.ui.elements.scriptData.value,e=JSON.parse(t),i;e.actions?i=e.actions.map(s=>({time:s.at/1e3,intensity:Math.round((100-s.pos)/100*20)})):(this.validateScript(e),i=e),this.script=i.sort((s,n)=>s.time-n.time),this.selectedEventIndices=[],this._syncScript(),this.editor.ui.updateStatus(`Imported ${this.script.length} events`)}catch(t){alert(`Error importing script: ${t.message}`)}}getIntensityAtTime(t){let e=this.editor.ui.elements.softModeCheckbox.checked?this.softScript:this.script;if(e.length===0)return 0;for(this.lastIndex>0&&t<e[this.lastIndex-1].time&&(this.lastIndex=0);this.lastIndex<e.length&&e[this.lastIndex].time<=t;)this.lastIndex++;return this.lastIndex>0?e[this.lastIndex-1].intensity:0}generateInterpolation(){if(this.selectedEventIndices.length!==2)return;this.selectedEventIndices.sort((h,u)=>h-u);let[t,e]=this.selectedEventIndices,i={...this.script[t]},s={...this.script[e]},n=document.getElementById("interpolationType").value,r=s.time-i.time,a=s.intensity-i.intensity,o=.04,d=[];if(r>o){let h=Math.floor(r/o)-1;if(h>0){let u=h+1,m=i.intensity;for(let p=1;p<=h;p++){let g=p/u,v=i.time+r*g,y;if(n==="linear")y=Math.round(i.intensity+a*g);else{let w=this.applyEasing(g,n);y=Math.round(i.intensity+a*w)}let S=Math.max(0,Math.min(20,y));S!==m&&(d.push({time:parseFloat(v.toFixed(3)),intensity:S}),m=S)}d.length>0&&d[d.length-1].intensity===s.intensity&&d.pop()}}let c=[i,...d,s],l=new k(this,t,e,c);this.editor.history.execute(l),this.selectedEventIndices=[],this.editor.ui.closeInterpolationPanel(),this._syncScript(),this.editor.ui.updateStatus(`Generated ${c.length-2} new events between ${this.editor.media.formatTime(i.time)} and ${this.editor.media.formatTime(s.time)}`)}applyEasing(t,e){switch(e){case"easeIn":return t*t;case"easeOut":return 1-Math.pow(1-t,2);case"easeInOut":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"linear":default:return t}}};var z=class{constructor(t){this.editor=t,this.undoStack=[],this.redoStack=[]}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],this.editor.ui.updateVisualization()}undo(){if(this.undoStack.length>0){let t=this.undoStack.pop();t.undo(),this.redoStack.push(t),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData()}}redo(){if(this.redoStack.length>0){let t=this.redoStack.pop();t.execute(),this.undoStack.push(t),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData()}}};var O=class{constructor(){this.SCRIPT_TAG_DESCRIPTION="LVS_SCRIPT",this.SCRIPT_VERSION="0.1"}async extractScript(t){try{let e=new DataView(t),i=this.parseID3Header(e);if(!i)return console.log("No ID3v2 header found"),null;console.log(`Found ID3v2.${i.majorVersion}.${i.revision}, size: ${i.size}`);let s=this.findScriptFrame(e,i);return s?(console.log("Found embedded script data"),this.parseScriptData(s)):(console.log("No embedded script found"),null)}catch(e){return console.error("Error extracting script from ID3 tags:",e),null}}parseID3Header(t){if(t.getUint8(0)!==73||t.getUint8(1)!==68||t.getUint8(2)!==51)return null;let e=t.getUint8(3),i=t.getUint8(4),s=t.getUint8(5),n=this.parseSynchsafeInt(t,6);return e<3||e>4?(console.warn(`Unsupported ID3v2 version: ${e}.${i}`),null):{majorVersion:e,revision:i,flags:s,size:n,headerSize:10}}findScriptFrame(t,e){let i=e.headerSize,s=e.headerSize+e.size;for(;i<s-10;)try{let n=this.parseFrameHeader(t,i,e.majorVersion);if(!n)break;if(n.id==="TXXX"){let r=this.parseTXXXFrame(t,i+n.headerSize,n.size);if(r&&r.description===this.SCRIPT_TAG_DESCRIPTION)return r.text}i+=n.headerSize+n.size}catch(n){console.warn("Error parsing frame at offset",i,n);break}return null}parseFrameHeader(t,e,i){if(t.getUint8(e)===0)return null;let s=String.fromCharCode(t.getUint8(e),t.getUint8(e+1),t.getUint8(e+2),t.getUint8(e+3)),n,r,a;return i===4?(n=this.parseSynchsafeInt(t,e+4),r=t.getUint16(e+8),a=10):(n=t.getUint32(e+4),r=t.getUint16(e+8),a=10),n<0||n>1e6?null:{id:s,size:n,flags:r,headerSize:a}}parseTXXXFrame(t,e,i){if(i<2)return null;let s=t.getUint8(e),n=e+1,r=this.readNullTerminatedString(t,n,s);n+=r.byteLength+(s===0||s===3?1:2);let a=i-(n-e);if(a<=0)return null;let o=this.readString(t,n,a,s);return{description:r.text,text:o}}readNullTerminatedString(t,e,i){let s=e,n=[];if(i===0||i===3){for(;s<t.byteLength&&t.getUint8(s)!==0;)n.push(t.getUint8(s)),s++;return{text:new TextDecoder(i===0?"iso-8859-1":"utf-8").decode(new Uint8Array(n)),byteLength:n.length}}else{for(;s<t.byteLength-1;){let a=t.getUint8(s),o=t.getUint8(s+1);if(a===0&&o===0)break;n.push(a),n.push(o),s+=2}return{text:new TextDecoder("utf-16").decode(new Uint8Array(n)),byteLength:n.length}}}readString(t,e,i,s){let n=new Uint8Array(i);for(let r=0;r<i;r++)n[r]=t.getUint8(e+r);switch(s){case 0:return new TextDecoder("iso-8859-1").decode(n);case 1:return new TextDecoder("utf-16").decode(n);case 2:return new TextDecoder("utf-16be").decode(n);case 3:return new TextDecoder("utf-8").decode(n);default:return new TextDecoder("utf-8").decode(n)}}parseSynchsafeInt(t,e){return t.getUint8(e)<<21|t.getUint8(e+1)<<14|t.getUint8(e+2)<<7|t.getUint8(e+3)}parseScriptData(t){try{let e=JSON.parse(t);if(e.actions&&Array.isArray(e.actions)){let i=e.actions.map(s=>({time:s.at/1e3,intensity:Math.round((100-s.pos)/100*20)}));return this.validateScript(i),{version:e.version||"funscript",script:i}}else{if(e.version&&Array.isArray(e.script))return this.validateScript(e.script),e;if(Array.isArray(e))return this.validateScript(e),{version:"1.0",script:e};throw new Error("Invalid or unsupported script format")}}catch(e){return console.error("Error parsing embedded script:",e),null}}validateScript(t){for(let e of t){if(typeof e.time!="number"||typeof e.intensity!="number")throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}async embedScript(t,e){try{let i=new DataView(t),s=JSON.stringify(e,null,2),n=this.parseID3Header(i),r;n?r=n.headerSize+n.size:r=0;let a=this.createID3Tag(s),o=t.slice(r),d=new ArrayBuffer(a.byteLength+o.byteLength),c=new Uint8Array(d);return c.set(new Uint8Array(a),0),c.set(new Uint8Array(o),a.byteLength),new Blob([d],{type:"audio/mpeg"})}catch(i){return console.error("Error embedding script in MP3:",i),null}}createID3Tag(t){let e=this.createTXXXFrame(this.SCRIPT_TAG_DESCRIPTION,t),i=e.byteLength,s=new ArrayBuffer(10),n=new DataView(s);n.setUint8(0,73),n.setUint8(1,68),n.setUint8(2,51),n.setUint8(3,3),n.setUint8(4,0),n.setUint8(5,0),this.writeSynchsafeInt(n,6,i);let r=new ArrayBuffer(10+i),a=new Uint8Array(r);return a.set(new Uint8Array(s),0),a.set(new Uint8Array(e),10),r}createTXXXFrame(t,e){let s=new TextEncoder().encode(t),n=new TextEncoder().encode(e),r=1+s.length+1+n.length,a=new ArrayBuffer(10+r),o=new DataView(a),d=new Uint8Array(a);o.setUint8(0,84),o.setUint8(1,88),o.setUint8(2,88),o.setUint8(3,88),o.setUint32(4,r),o.setUint16(8,0);let c=10;return d[c++]=3,d.set(s,c),c+=s.length,d[c++]=0,d.set(n,c),a}writeSynchsafeInt(t,e,i){t.setUint8(e,i>>21&127),t.setUint8(e+1,i>>14&127),t.setUint8(e+2,i>>7&127),t.setUint8(e+3,i&127)}};var W=class{constructor(t,e){this.ui=t,this.loadMediaCallback=e,this.playlist=[],this.currentItemId=null,this.nextItemId=1,this.loopState="none",this.autoplay=!0,this.render()}setAutoplay(t){this.autoplay=t}addFiles(t){let e=Array.from(t).filter(s=>s.type.startsWith("audio/")||s.type.startsWith("video/")),i=Array.from(t).filter(s=>s.name.endsWith(".funscript"));e.forEach(s=>{let n=s.name.substring(0,s.name.lastIndexOf(".")),r=i.find(a=>a.name.substring(0,a.name.lastIndexOf("."))===n);this.addItem(s,r||null),r&&i.splice(i.indexOf(r),1)}),i.forEach(s=>{}),this.render()}linkScriptToItem(t,e){let i=this.playlist.find(s=>s.id===t);i&&!i.scriptFile&&(i.scriptFile=e,this.render())}addItem(t,e){let i={id:`item-${this.nextItemId++}`,mediaFile:t,scriptFile:e};this.playlist.push(i)}removeItem(t){this.playlist=this.playlist.filter(e=>e.id!==t),this.currentItemId===t&&(this.currentItemId=null),this.render()}playItem(t){let e=this.playlist.find(i=>i.id===t);e&&(this.currentItemId=t,this.loadMediaCallback({mediaFile:e.mediaFile,scriptFile:e.scriptFile}),this.render())}handleClick(t){let e=t.target.closest(".playlist-item");if(!e)return;let i=e.dataset.id;t.target.closest(".playlist-item-remove")?this.removeItem(i):this.playItem(i)}toggleLoopState(){let t=["none","single","list"],e=t.indexOf(this.loopState);this.loopState=t[(e+1)%t.length];let i={none:"No Loop",single:"Loop 1",list:"Loop All"},s={none:"Looping is off",single:"Looping current item",list:"Looping playlist"};this.ui.elements.loopBtn.textContent=i[this.loopState],this.ui.elements.loopBtn.title=s[this.loopState]}onMediaFinished(){if(this.loopState==="single"&&this.currentItemId){this.playItem(this.currentItemId);return}if(!this.autoplay)return;let t=this.playlist.findIndex(i=>i.id===this.currentItemId);if(t===-1)return;let e=t+1;e<this.playlist.length?this.playItem(this.playlist[e].id):this.loopState==="list"&&this.playlist.length>0?this.playItem(this.playlist[0].id):(this.currentItemId=null,this.render())}render(){if(this.playlist.length===0){this.ui.elements.playlistContainer.innerHTML='<div class="playlist-drop-target">Drag media and script files here</div>';return}this.ui.elements.playlistContainer.innerHTML=this.playlist.map(t=>`
            <div class="playlist-item ${this.currentItemId===t.id?"playing":""} ${t.scriptFile?"":"unlinked"}" data-id="${t.id}">
                <div class="playlist-item-details">
                    <span class="playlist-item-icon">${this.currentItemId===t.id?"\u25B6\uFE0F":"\u{1F3B5}"}</span>
                    <span class="playlist-item-name">${t.mediaFile.name}</span>
                    ${t.scriptFile?"":'<span class="playlist-item-status">(Missing Script)</span>'}
                </div>
                <button class="playlist-item-remove" title="Remove from playlist">\xD7</button>
            </div>
        `).join("")}};var H=class{constructor(){this.ui=new C(this),this.media=null,this.canvas=new L(this),this.input=new U(this),this.bluetooth=new A(this),this.scriptManager=new $(this),this.history=new z(this),this.id3Handler=new O,this.playlistManager=new W(this.ui,t=>this.loadPlaylistItem(t)),this.ui.updateStatus("Ready - Load a media file to begin")}async loadFile(t){try{if(this.media&&(this.media.destroy(),this.media=null),t.name.toLowerCase().endsWith(".lsx"))await this.loadLsxFile(t);else if(t.type.startsWith("video/"))this.media=new T(this),await this.media.loadFile(t);else if(t.type.startsWith("audio/"))this.media=new I(this),await this.media.loadFile(t);else throw new Error("Unsupported file type")}catch(e){this.ui.updateStatus(`Error: ${e.message}`),console.error(e)}}async loadLsxFile(t){this.ui.showLoadingOverlay(),this.ui.updateLoadingStage("Unpacking LSX file...",!0);try{let{videoFile:e,scriptFile:i}=await x.load(t);if(!e)throw new Error("No video file found in the LSX package.");if(!i)throw new Error("No script file found in the LSX package.");this.ui.updateLoadingStage("Loading video...",!0),this.media=new T(this),await this.media.loadFile(e),this.ui.updateLoadingStage("Loading script...",!0),this.scriptManager.importScript(i,!0)}catch(e){console.error("Error loading LSX file:",e),this.ui.updateStatus(`Error: ${e.message}`)}finally{this.ui.hideLoadingOverlay()}}findFileByExtension(t,e){for(let i of e){let s=t.file(new RegExp(`\\.${i}, 'i'`));if(s.length>0)return s[0]}return null}onMediaFinished(){this.playlistManager&&this.playlistManager.onMediaFinished()}async loadPlaylistItem(t){try{this.media&&(this.media.destroy(),this.media=null);let{mediaFile:e,scriptFile:i}=t;if(e.type.startsWith("video/"))this.media=new T(this),await this.media.loadFile(e);else if(e.type.startsWith("audio/"))this.media=new I(this),await this.media.loadFile(e);else throw new Error("Unsupported file type in playlist");i?this.scriptManager.importScript(i,!0):this.scriptManager.clearScript()}catch(e){this.ui.updateStatus(`Error loading playlist item: ${e.message}`),console.error(e)}}};new H;})();
/*
 * CRC-32 implementation taken from https://github.com/SheetJS/js-crc32
 * (C) 2014-present SheetJS -- http://sheetjs.com
 * @license Apache-2.0
 */
</script>
</body>

</html>