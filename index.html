<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lovense Script Editor</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 6px;
        }

        button {
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #106ebe;
        }

        button:disabled {
            background: #404040;
            cursor: not-allowed;
        }

        button.danger {
            background: #d13438;
        }

        button.danger:hover:not(:disabled) {
            background: #b71c1c;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            padding: 8px 16px;
            background: #6b46c1;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-block;
        }

        .file-label:hover {
            background: #553c9a;
        }

        .waveform-container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            /* Ensure content stays above glow */
        }

        .waveform-container::before {
            content: '';
            position: absolute;
            top: 45px;
            left: -30px;
            right: -30px;
            bottom: -15px;
            background: linear-gradient(45deg,
                    rgba(255, 107, 53, 0.8) 30%,
                    rgba(255, 107, 53, 0.8) 60%,
                    rgba(255, 107, 53, 0.8) 100%,
                    transparent 100%);
            border-radius: 16px;
            opacity: 0;
            transform: scale(0.95);
            filter: blur(8px);
            pointer-events: none;
            transition: all 0.3s ease;
            will-change: transform, opacity, filter;
            z-index: -1;
        }

        .waveform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-info {
            font-family: monospace;
            color: #888;
        }

        .waveform-canvas {
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            border-radius: 4px;
            cursor: crosshair;
            display: block;
            transition: all 0.2s ease;
        }

        .waveform-canvas.drag-over {
            background: #2a3f5f;
            border: 2px dashed #0078d4;
            cursor: copy;
        }

        .waveform-canvas.dragging {
            cursor: ns-resize !important;
        }

        .timeline {
            position: relative;
            height: 30px;
            background: #333;
            border-radius: 4px;
            margin-top: 10px;
            cursor: pointer;
        }

        .timeline.dragging {
            cursor: ew-resize !important;
        }

        .playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #ff4444;
            pointer-events: none;
            z-index: 2;
        }

        .script-events {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
        }

        .script-event {
            position: absolute;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            height: 100%;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #000;
            min-width: 3px;
        }

        .script-event:hover {
            opacity: 0.8;
            box-shadow: 0 0 5px rgba(255, 107, 53, 0.8);
        }

        .script-event.selected {
            outline: 2px solid #fff;
            z-index: 1;
        }

        .script-event.embedded {
            background: linear-gradient(45deg, #6b46c1, #9333ea);
        }

        .script-event.dragging {
            opacity: 0.7;
            z-index: 3;
        }

        .script-panel {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .event-list {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: #333;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-item:hover {
            background: #404040;
        }

        .event-item.selected {
            background: #0078d4;
        }

        .event-details {
            font-family: monospace;
            font-size: 12px;
        }

        .event-actions {
            display: flex;
            gap: 5px;
        }

        .export-import {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .script-textarea {
            width: 100%;
            height: 200px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .status {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            color: #ccc;
        }

        .instructions {
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0078d4;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .instructions-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s ease;
        }

        .instructions-header:hover {
            background: #333;
        }

        .instructions-header h3 {
            margin: 0;
            color: #0078d4;
        }

        .instructions-toggle {
            color: #0078d4;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .instructions-toggle.expanded {
            transform: rotate(180deg);
        }

        .instructions-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .instructions-content.expanded {
            max-height: 500px;
        }

        .instructions-list {
            padding: 0 15px 15px 15px;
        }

        .instruction-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #1e1e1e;
        }

        .instruction-number {
            color: #0078d4;
            font-weight: bold;
            margin-right: 8px;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .loading-content {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            min-width: 300px;
            border: 2px solid #0078d4;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        }

        .loading-stage {
            font-size: 18px;
            color: #fff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0078d4, #00a1f1);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-fill.indeterminate {
            width: 30%;
            animation: indeterminateProgress 2s ease-in-out infinite;
        }

        @keyframes indeterminateProgress {
            0% {
                transform: translateX(-100%);
            }

            50% {
                transform: translateX(350%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .progress-text {
            font-family: monospace;
            color: #ccc;
            font-size: 14px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
            border-top-color: #0078d4;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .intensity-1::before {
            opacity: 0.15;
            filter: blur(6px);
        }

        .intensity-2::before {
            opacity: 0.20;
            filter: blur(7px);
        }

        .intensity-3::before {
            opacity: 0.25;
            filter: blur(8px);
        }

        .intensity-4::before {
            opacity: 0.30;
            filter: blur(9px);
        }

        .intensity-5::before {
            opacity: 0.35;
            filter: blur(10px);
        }

        .intensity-6::before {
            opacity: 0.40;
            filter: blur(11px);
        }

        .intensity-7::before {
            opacity: 0.45;
            filter: blur(12px);
        }

        .intensity-8::before {
            opacity: 0.50;
            filter: blur(13px);
        }

        .intensity-9::before {
            opacity: 0.55;
            filter: blur(14px);
        }

        .intensity-10::before {
            opacity: 0.60;
            filter: blur(15px);
        }

        .intensity-11::before {
            opacity: 0.65;
            filter: blur(16px);
        }

        .intensity-12::before {
            opacity: 0.70;
            filter: blur(17px);
        }

        .intensity-13::before {
            opacity: 0.75;
            filter: blur(18px);
        }

        .intensity-14::before {
            opacity: 0.80;
            filter: blur(19px);
        }

        .intensity-15::before {
            opacity: 0.85;
            filter: blur(20px);
        }

        .intensity-16::before {
            opacity: 0.90;
            filter: blur(21px);
        }

        .intensity-17::before {
            opacity: 0.95;
            filter: blur(22px);
        }

        .intensity-18::before {
            opacity: 1.00;
            filter: blur(23px);
        }

        .intensity-19::before {
            opacity: 1.00;
            filter: blur(24px);
        }

        .intensity-20::before {
            opacity: 1.00;
            filter: blur(25px);
        }

        /* Drag preview styles */
        .drag-preview {
            position: absolute;
            background: rgba(0, 255, 136, 0.6);
            border: 2px dashed #00ff88;
            border-radius: 4px;
            pointer-events: none;
            z-index: 100;
            font-size: 11px;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Lovense Script Editor</h1>
            <p>Create precise haptic scripts synchronized to audio</p>
        </div>

        <div class="instructions">
            <div class="instructions-header" onclick="toggleInstructions()">
                <h3>How to Use</h3>
                <span class="instructions-toggle" id="instructionsToggle">▼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <div class="instructions-list">
                    <div class="instruction-item">
                        <span class="instruction-number">0.</span>
                        Put your device in pairing mode, hit "connect device" button and connect it
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">1.</span>
                        Load an audio file or drag & drop onto waveform
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">2.</span>
                        Click on waveform: X-axis = time, Y-axis = intensity (0-20)
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">3.</span>
                        Mouse wheel to zoom, Shift+wheel to pan left and right
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">4.</span>
                        Click timeline to seek
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">5.</span>
                        Events hold intensity until next event
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">6.</span>
                        Play/pause to test sync (or spacebar)
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">7.</span>
                        Click event to select, ctrl+click for multi-select, shift+click for range select, delete to
                        remove
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">8.</span>
                        Select two events, use interpolation panel to ramp up/down smoothly
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">9.</span>
                        Drag selected events on the waveform (intensity) or timeline (time)
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">10.</span>
                        Download the synced mp3 for later use, or export the script if another format was used
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="audioFile" class="file-label">Load Audio File</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>

            <div class="control-group">
                <button id="playPauseBtn" disabled>Play</button>
                <button id="stopBtn" disabled>Stop</button>
            </div>

            <div class="control-group">
                <button id="connectDeviceBtn">Connect Device</button>
                <span id="connectionStatus" style="font-size: 12px; color: #666; margin-left: 8px;">Not connected</span>
            </div>

            <div class="control-group">
                <button id="zoomInBtn" disabled>Zoom In</button>
                <button id="zoomOutBtn" disabled>Zoom Out</button>
                <button id="zoomFitBtn" disabled>Zoom Fit</button>
            </div>

            <div class="control-group">
                <button id="clearScript" class="danger">Clear Script</button>
            </div>
            <div style="margin-left: auto;">
                <button id="downloadSyncedBtn" disabled>Download Synced Audio File (.mp3 only)</button>
            </div>
        </div>
        <div class="status" id="status">
            Ready - Load an audio file to begin
        </div>

        <div id="waveform" class="waveform-container">
            <div class="waveform-header">
                <h3>Waiting for media file...</h3>
                <div class="time-info" id="timeInfo">00:00 / 00:00 | Hover for intensity preview</div>
            </div>
            <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
            <div id="timeline" class="timeline">
                <div class="playhead" id="playhead"></div>
                <div class="script-events" id="scriptEvents"></div>
            </div>
        </div>

        <div class="script-panel">
            <div class="event-list">
                <h3>Script Events</h3>
                <div id="eventList"></div>
            </div>

            <div class="export-import">
                <h3>Script Data</h3>
                <textarea id="scriptData" class="script-textarea"
                    placeholder="Script data will appear here..."></textarea>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button id="exportBtn">Export Script</button>
                    <label for="scriptFile" class="file-label">Load Script</label>
                    <input type="file" id="scriptFile" accept=".json">
                    <button id="importBtn">Update Script</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div id="loadingStage" class="loading-stage">Loading file...</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">Preparing...</div>
                </div>
            </div>
        </div>
    </div>
        <script>
function toggleInstructions(){const t=document.getElementById("instructionsContent"),e=document.getElementById("instructionsToggle");t.classList.contains("expanded")?(t.classList.remove("expanded"),e.classList.remove("expanded")):(t.classList.add("expanded"),e.classList.add("expanded"))}class ID3ScriptHandler{constructor(){this.SCRIPT_TAG_DESCRIPTION="LVS_SCRIPT",this.SCRIPT_VERSION="0.1"}async extractScript(t){try{const e=new DataView(t),i=this.parseID3Header(e);if(!i)return console.log("No ID3v2 header found"),null;console.log(`Found ID3v2.${i.majorVersion}.${i.revision}, size: ${i.size}`);const s=this.findScriptFrame(e,i);return s?(console.log("Found embedded script data"),this.parseScriptData(s)):(console.log("No embedded script found"),null)}catch(t){return console.error("Error extracting script from ID3 tags:",t),null}}parseID3Header(t){if(73!==t.getUint8(0)||68!==t.getUint8(1)||51!==t.getUint8(2))return null;const e=t.getUint8(3),i=t.getUint8(4),s=t.getUint8(5),n=this.parseSynchsafeInt(t,6);return e<3||e>4?(console.warn(`Unsupported ID3v2 version: ${e}.${i}`),null):{majorVersion:e,revision:i,flags:s,size:n,headerSize:10}}findScriptFrame(t,e){let i=e.headerSize;const s=e.headerSize+e.size;for(;i<s-10;)try{const s=this.parseFrameHeader(t,i,e.majorVersion);if(!s)break;if("TXXX"===s.id){const e=this.parseTXXXFrame(t,i+s.headerSize,s.size);if(e&&e.description===this.SCRIPT_TAG_DESCRIPTION)return e.text}i+=s.headerSize+s.size}catch(t){console.warn("Error parsing frame at offset",i,t);break}return null}parseFrameHeader(t,e,i){if(0===t.getUint8(e))return null;const s=String.fromCharCode(t.getUint8(e),t.getUint8(e+1),t.getUint8(e+2),t.getUint8(e+3));let n,a,o;return 4===i?(n=this.parseSynchsafeInt(t,e+4),a=t.getUint16(e+8),o=10):(n=t.getUint32(e+4),a=t.getUint16(e+8),o=10),n<0||n>1e6?null:{id:s,size:n,flags:a,headerSize:o}}parseTXXXFrame(t,e,i){if(i<2)return null;const s=t.getUint8(e);let n=e+1;const a=this.readNullTerminatedString(t,n,s);n+=a.byteLength+(0===s||3===s?1:2);const o=i-(n-e);if(o<=0)return null;const r=this.readString(t,n,o,s);return{description:a.text,text:r}}readNullTerminatedString(t,e,i){let s=e;const n=[];if(0===i||3===i){for(;s<t.byteLength&&0!==t.getUint8(s);)n.push(t.getUint8(s)),s++;return{text:new TextDecoder(0===i?"iso-8859-1":"utf-8").decode(new Uint8Array(n)),byteLength:n.length}}for(;s<t.byteLength-1;){const e=t.getUint8(s),i=t.getUint8(s+1);if(0===e&&0===i)break;n.push(e),n.push(i),s+=2}return{text:new TextDecoder("utf-16").decode(new Uint8Array(n)),byteLength:n.length}}readString(t,e,i,s){const n=new Uint8Array(i);for(let s=0;s<i;s++)n[s]=t.getUint8(e+s);switch(s){case 0:return new TextDecoder("iso-8859-1").decode(n);case 1:return new TextDecoder("utf-16").decode(n);case 2:return new TextDecoder("utf-16be").decode(n);default:return new TextDecoder("utf-8").decode(n)}}parseSynchsafeInt(t,e){return t.getUint8(e)<<21|t.getUint8(e+1)<<14|t.getUint8(e+2)<<7|t.getUint8(e+3)}parseScriptData(t){try{const e=JSON.parse(t);if(e.version&&Array.isArray(e.script))return this.validateScript(e.script),e;if(Array.isArray(e))return this.validateScript(e),{version:"1.0",script:e};throw new Error("Invalid script format")}catch(t){return console.error("Error parsing embedded script:",t),null}}validateScript(t){for(const e of t){if("number"!=typeof e.time||"number"!=typeof e.intensity)throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}async embedScript(t,e){try{const i=new DataView(t),s=JSON.stringify({version:this.SCRIPT_VERSION,script:e}),n=this.parseID3Header(i);let a;a=n?n.headerSize+n.size:0;const o=this.createID3Tag(s),r=t.slice(a),h=new ArrayBuffer(o.byteLength+r.byteLength),d=new Uint8Array(h);return d.set(new Uint8Array(o),0),d.set(new Uint8Array(r),o.byteLength),new Blob([h],{type:"audio/mpeg"})}catch(t){return console.error("Error embedding script in MP3:",t),null}}createID3Tag(t){const e=this.createTXXXFrame(this.SCRIPT_TAG_DESCRIPTION,t),i=e.byteLength,s=new ArrayBuffer(10),n=new DataView(s);n.setUint8(0,73),n.setUint8(1,68),n.setUint8(2,51),n.setUint8(3,3),n.setUint8(4,0),n.setUint8(5,0),this.writeSynchsafeInt(n,6,i);const a=new ArrayBuffer(10+i),o=new Uint8Array(a);return o.set(new Uint8Array(s),0),o.set(new Uint8Array(e),10),a}createTXXXFrame(t,e){const i=(new TextEncoder).encode(t),s=(new TextEncoder).encode(e),n=1+i.length+1+s.length,a=new ArrayBuffer(10+n),o=new DataView(a),r=new Uint8Array(a);o.setUint8(0,84),o.setUint8(1,88),o.setUint8(2,88),o.setUint8(3,88),o.setUint32(4,n),o.setUint16(8,0);let h=10;return r[h++]=3,r.set(i,h),h+=i.length,r[h++]=0,r.set(s,h),a}writeSynchsafeInt(t,e,i){t.setUint8(e,i>>21&127),t.setUint8(e+1,i>>14&127),t.setUint8(e+2,i>>7&127),t.setUint8(e+3,127&i)}}class LovenseScriptEditor{constructor(){this.audioContext=null,this.audioBuffer=null,this.source=null,this.isPlaying=!1,this.startTime=0,this.pauseTime=0,this.currentTime=0,this.duration=0,this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.originalFileBuffer=null,this.isMP3File=!1,this.originalFileName="",this.id3Handler=new ID3ScriptHandler,this.canvas=document.getElementById("waveformCanvas"),this.timeline=document.getElementById("timeline"),this.scriptTextarea=document.getElementById("scriptData"),this.ctx=this.canvas.getContext("2d"),this.waveformContainer=document.getElementById("waveform"),this.waveformData=null,this.statusDiv=document.getElementById("status"),this.script=[],this.selectedEventIndices=[],this.currentIntensity=10,this.activeIntensity=0,this.clipboard=[],this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.hoverTime=null,this.isHoveringWaveform=!1,this.isHoveringTimeline=!1,this.viewportStart=0,this.viewportEnd=0,this.zoomLevel=1,this.lastScrollTime=0,this.scrollVelocity=0,this.baseZoomFactor=1.08,this.maxZoomFactor=1.3,this.velocityThreshold=100,this.canvasWidth=0,this.canvasHeight=0,this.canvasTopPadding=20,this.canvasBottomPadding=5,this.isDragging=!1,this.dragType=null,this.dragStartPos={x:0,y:0},this.dragEventStartPositions=[],this.dragThreshold=5,this.dragPreviewElement=null,this.setupCanvas(),this.setupDragAndDrop(),this.initializeEventListeners(),this.updateStatus("Ready - Load an audio file to begin")}canvasXToTime(t){if(!this.duration)return 0;const e=t/this.canvasWidth,i=this.viewportEnd-this.viewportStart;return this.viewportStart+e*i}timeToCanvasX(t){if(!this.duration)return 0;const e=this.viewportEnd-this.viewportStart;return(t-this.viewportStart)/e*this.canvasWidth}canvasYToIntensity(t){const e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;if(t<=this.canvasTopPadding)return 20;if(t>=this.canvasHeight-this.canvasBottomPadding)return 0;const i=(t-this.canvasTopPadding)/e;return Math.round(20*(1-i))}intensityToCanvasY(t){const e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding,i=t/20;return this.canvasTopPadding+(1-i)*e}getCanvasMousePos(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}getTimelineMousePos(t){const e=this.timeline.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}updateViewport(){if(!this.duration)return this.viewportStart=0,void(this.viewportEnd=0);const t=this.duration/this.zoomLevel,e=(this.viewportStart+this.viewportEnd)/2;this.viewportStart=Math.max(0,e-t/2),this.viewportEnd=Math.min(this.duration,this.viewportStart+t),this.viewportEnd===this.duration&&(this.viewportStart=Math.max(0,this.duration-t))}zoomToPoint(t,e){if(!this.duration)return;const i=this.zoomLevel;if(this.zoomLevel=Math.max(1,Math.min(100,this.zoomLevel*t)),this.zoomLevel===i)return;const s=this.duration/this.zoomLevel;this.viewportStart=Math.max(0,e-s/2),this.viewportEnd=Math.min(this.duration,this.viewportStart+s),this.viewportEnd===this.duration&&(this.viewportStart=Math.max(0,this.duration-s)),0===this.viewportStart&&(this.viewportEnd=Math.min(this.duration,s)),this.generateWaveformData(),this.drawWaveform(),this.updateTimeline();const n=Math.round(100*this.zoomLevel);this.updateStatus(`Zoom: ${n}% | Viewing: ${this.formatTime(this.viewportStart)} - ${this.formatTime(this.viewportEnd)}`)}zoomFit(){this.duration&&(this.zoomLevel=1,this.viewportStart=0,this.viewportEnd=this.duration,this.generateWaveformData(),this.drawWaveform(),this.updateTimeline(),this.updateStatus(`Zoom: 100% | Showing full duration: ${this.formatTime(this.duration)}`))}panViewportHorizontally(t){if(!this.duration)return;const e=this.viewportEnd-this.viewportStart;this.viewportStart=Math.max(0,Math.min(this.duration-e,this.viewportStart+t)),this.viewportEnd=this.viewportStart+e,this.generateWaveformData(),this.drawWaveform(),this.updateTimeline();const i=Math.round(100*this.zoomLevel);this.updateStatus(`Zoom: ${i}% | Viewing: ${this.formatTime(this.viewportStart)} - ${this.formatTime(this.viewportEnd)}`)}updateCanvasDimensions(){const t=this.canvas.getBoundingClientRect();this.canvasWidth=t.width,this.canvasHeight=t.height}setupCanvas(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width-40,this.canvas.height=300;const e=window.devicePixelRatio||1,i=this.canvas.width,s=this.canvas.height;this.canvas.width=i*e,this.canvas.height=s*e,this.canvas.style.width=i+"px",this.canvas.style.height=s+"px",this.ctx.scale(e,e),this.updateCanvasDimensions(),this.drawPlaceholder()}drawPlaceholder(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight);const t=this.canvasWidth/2,e=this.canvasHeight/2;this.ctx.fillStyle="#888",this.ctx.font="18px Arial",this.ctx.textAlign="center",this.ctx.fillText("Load or drag-and-drop an audio file here",t,e-10),this.ctx.fillStyle="#666",this.ctx.font="14px Arial",this.ctx.fillText(".mp3, .wav, .m4a, and others...",t,e+20),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="#444",this.ctx.font="10px Arial",this.ctx.textAlign="right";const i=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;for(let t=0;t<=20;t+=5){const e=this.canvasTopPadding+(1-t/20)*i;this.ctx.fillText(t.toString(),this.canvasWidth-10,e+3)}this.ctx.restore()}showLoadingOverlay(){document.getElementById("loadingOverlay").style.display="flex"}hideLoadingOverlay(){document.getElementById("loadingOverlay").style.display="none"}updateLoadingStage(t,e=!1){document.getElementById("loadingStage").textContent=t;const i=document.getElementById("progressFill"),s=document.getElementById("progressText");e?(i.classList.add("indeterminate"),i.style.width="30%",s.textContent="Processing..."):(i.classList.remove("indeterminate"),i.style.width="0%",s.textContent="0%")}updateLoadingProgress(t){const e=document.getElementById("progressFill"),i=document.getElementById("progressText");e.classList.remove("indeterminate"),e.style.width=`${t}%`,i.textContent=`${Math.round(t)}%`}handleDragOver(t){t.preventDefault(),t.stopPropagation(),this.canvas.classList.add("drag-over")}handleDragLeave(t){t.preventDefault(),t.stopPropagation(),this.canvas.classList.remove("drag-over")}handleDrop(t){t.preventDefault(),t.stopPropagation(),this.canvas.classList.remove("drag-over");const e=t.dataTransfer.files;if(e.length>0){const t=e[0];if(!t.type.startsWith("audio/"))return void this.updateStatus(`Error: "${t.name}" is not an audio file`);this.loadAudioFile(t)}}setupDragAndDrop(){this.canvas.addEventListener("dragover",t=>this.handleDragOver(t),!1),this.canvas.addEventListener("dragenter",t=>this.handleDragOver(t),!1),this.canvas.addEventListener("dragleave",t=>this.handleDragLeave(t),!1),this.canvas.addEventListener("drop",t=>this.handleDrop(t),!1),document.addEventListener("dragover",t=>t.preventDefault(),!1),document.addEventListener("drop",t=>t.preventDefault(),!1)}async initializeAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),await this.audioContext.resume())}async handleDeviceConnection(){const t=document.getElementById("connectDeviceBtn");if(this.device&&this.device.gatt.connected)try{this.device.gatt.disconnect(),this.updateStatus("Device disconnected")}catch(t){this.updateStatus(`Disconnect error: ${t.message}`)}else{t.disabled=!0,t.textContent="Connecting...",this.updateStatus("Connecting to device...");try{await this.connectToDevice()?(this.updateConnectionStatus(!0,this.device.name||"Unknown Device"),this.updateStatus(`Connected to ${this.device.name||"Lovense device"}`)):(this.updateConnectionStatus(!1),this.updateStatus("Failed to connect to device"))}catch(t){this.updateConnectionStatus(!1),this.updateStatus(`Connection error: ${t.message}`)}t.disabled=!1}}updateConnectionStatus(t,e=""){const i=document.getElementById("connectDeviceBtn"),s=document.getElementById("connectionStatus");t?(i.textContent="Disconnect",i.style.background="#d13438",s.textContent=`Connected: ${e}`,s.style.color="#00ff88"):(i.textContent="Connect Device",i.style.background="#0078d4",s.textContent="Not connected",s.style.color="#666")}generateLovenseServices(){return["0000fff0-0000-1000-8000-00805f9b34fb","6e400001-b5a3-f393-e0a9-e50e24dcca9e","50300001-0024-4bd4-bbd5-a6920e4c5653","57300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0024-4bd4-bbd5-a6920e4c5653","50300001-0023-4bd4-bbd5-a6920e4c5653","53300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0023-4bd4-bbd5-a6920e4c5653","4f300001-0023-4bd4-bbd5-a6920e4c5653","42300001-0023-4bd4-bbd5-a6920e4c5653","43300001-0023-4bd4-bbd5-a6920e4c5653","4c300001-0023-4bd4-bbd5-a6920e4c5653","4c410001-0023-4bd4-bbd5-a6920e4c5653","56300001-0023-4bd4-bbd5-a6920e4c5653","58300001-0023-4bd4-bbd5-a6920e4c5653","52300001-0023-4bd4-bbd5-a6920e4c5653","46300001-0023-4bd4-bbd5-a6920e4c5653","50300011-0023-4bd4-bbd5-a6920e4c5653","4a300001-0023-4bd4-bbd5-a6920e4c5653","45440001-0023-4bd4-bbd5-a6920e4c5653","45420001-0023-4bd4-bbd5-a6920e4c5653","54300001-0023-4bd4-bbd5-a6920e4c5653","45490001-0023-4bd4-bbd5-a6920e4c5653","4e300001-0023-4bd4-bbd5-a6920e4c5653","45410001-0023-4bd4-bbd5-a6920e4c5653","51300001-0023-4bd4-bbd5-a6920e4c5653","45460001-0023-4bd4-bbd5-a6920e4c5653","454c0001-0023-4bd4-bbd5-a6920e4c5653","55300001-0023-4bd4-bbd5-a6920e4c5653","53440001-0023-4bd4-bbd5-a6920e4c5653","48300001-0023-4bd4-bbd5-a6920e4c5653","46530001-0023-4bd4-bbd5-a6920e4c5653","42410001-0023-4bd4-bbd5-a6920e4c5653","43410001-0023-4bd4-bbd5-a6920e4c5653","4f430001-0023-4bd4-bbd5-a6920e4c5653","455a0001-0023-4bd4-bbd5-a6920e4c5653"]}async connectToDevice(){try{const t=this.generateLovenseServices();return this.device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"lvs"},{namePrefix:"LVS"},{namePrefix:"lovense"},{namePrefix:"Lovense"},{namePrefix:"LOVENSE"}],optionalServices:t}),this.gattServer=await this.device.gatt.connect(),this.device.addEventListener("gattserverdisconnected",this.onDisconnected.bind(this)),await this.setupCommandChannel(),!0}catch(t){return console.error(`Connection error: ${t.message}`),!1}}async setupCommandChannel(){const t=this.generateLovenseServices();for(const e of t)try{const t=await this.gattServer.getPrimaryService(e),i=await t.getCharacteristics();for(const t of i)if(t.properties.write||t.properties.writeWithoutResponse)return this.commandCharacteristic=t,void console.log(`Command characteristic found in service: ${e}`)}catch(t){}console.warn("No command characteristic found in any service")}async sendCommand(t){if(!this.device||!this.device.gatt.connected||!this.commandCharacteristic)return console.warn("Device not connected or characteristic not available"),!1;try{const e=(new TextEncoder).encode(t);return await this.commandCharacteristic.writeValue(e),console.log(`📡 BT Command sent: ${t}`),!0}catch(e){return console.error(`Failed to send command "${t}":`,e),this.updateStatus(`Bluetooth command failed: ${e.message}`),!1}}onDisconnected(){console.log("Device disconnected"),this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.updateConnectionStatus(!1),this.updateStatus("Device disconnected")}async loadAudioFile(t){try{this.showLoadingOverlay(),this.clipboard=[],this.clearPasteState(),this.updateLoadingStage("Loading file...",!1),this.updateLoadingProgress(0),await this.initializeAudioContext(),this.originalFileName=t.name,this.isMP3File=t.name.toLowerCase().endsWith(".mp3")||"audio/mpeg"===t.type,this.updateLoadingStage("Reading file data...",!1),this.updateLoadingProgress(10);const e=await t.arrayBuffer();this.isMP3File&&(this.originalFileBuffer=e.slice(0));let i=null;if(this.isMP3File){this.updateLoadingStage("Checking for embedded script...",!1),this.updateLoadingProgress(15);const t=await this.id3Handler.extractScript(e);t&&t.script&&(i=t.script)}if(i&&this.script.length>0){this.hideLoadingOverlay();const t=confirm(`This MP3 contains ${i.length} embedded script events.\nYou currently have ${this.script.length} events in the editor.\n\nWould you like to keep the current script events?\n\nOK = Merge both scripts\nCancel = Replace with embedded script only`);this.showLoadingOverlay(),t?(this.script.forEach(t=>{t.embedded||(t.embedded=!1)}),i.forEach(t=>{this.script.push({time:t.time,intensity:t.intensity,embedded:!0})}),this.script.sort((t,e)=>t.time-e.time),this.updateStatus(`Merged ${i.length} embedded events with existing script`)):(this.script=i.map(t=>({time:t.time,intensity:t.intensity,embedded:!0})),this.updateStatus(`Loaded ${i.length} embedded events`))}else i&&0===this.script.length&&(this.script=i.map(t=>({time:t.time,intensity:t.intensity,embedded:!0})),this.updateStatus(`Loaded ${i.length} embedded events`));this.updateLoadingStage("Decoding audio...",!0),this.audioBuffer=await this.audioContext.decodeAudioData(e),this.duration=this.audioBuffer.duration,this.updateViewport(),this.updateLoadingStage("Generating waveform...",!1),await this.generateWaveformDataChunked(),this.updateLoadingStage("Complete!",!1),this.updateLoadingProgress(100),await new Promise(t=>setTimeout(t,300)),this.hideLoadingOverlay(),this.drawWaveform(),this.updateTimeInfo(),i||this.updateStatus(`Loaded: ${t.name} (${this.formatTime(this.duration)})`),document.querySelector(".waveform-header h3").textContent=t.name,document.getElementById("playPauseBtn").disabled=!1,document.getElementById("zoomInBtn").disabled=!1,document.getElementById("zoomOutBtn").disabled=!1,document.getElementById("zoomFitBtn").disabled=!1,this.isMP3File&&(document.getElementById("downloadSyncedBtn").disabled=!1),this.updateEventList(),this.updateScriptData()}catch(t){this.hideLoadingOverlay(),this.updateStatus(`Error loading audio: ${t.message}`)}}generateWaveformData(){const t=this.audioBuffer.getChannelData(0),e=t.length,i=this.audioBuffer.sampleRate,s=(this.viewportEnd,this.viewportStart,Math.floor(this.viewportStart*i)),n=Math.min(e,Math.floor(this.viewportEnd*i)),a=n-s,o=this.canvas.width/(window.devicePixelRatio||1),r=Math.max(1,Math.floor(a/o));this.waveformData=[];for(let i=0;i<o;i++){const a=s+i*r,o=Math.min(n,a+r);let h=0,d=0;if(a<e&&o>a)for(let e=a;e<o;e++){const i=t[e];i<h&&(h=i),i>d&&(d=i)}this.waveformData.push({min:h,max:d})}}async generateWaveformDataChunked(){const t=this.audioBuffer.getChannelData(0),e=t.length,i=this.audioBuffer.sampleRate,s=(this.viewportEnd,this.viewportStart,Math.floor(this.viewportStart*i)),n=Math.min(e,Math.floor(this.viewportEnd*i)),a=n-s,o=this.canvas.width/(window.devicePixelRatio||1),r=Math.max(1,Math.floor(a/o));this.waveformData=[];const h=Math.ceil(o/500);for(let i=0;i<h;i++){const a=500*i,d=Math.min(a+500,o);for(let i=a;i<d;i++){const a=s+i*r,o=Math.min(n,a+r);let h=0,d=0;if(a<e&&o>a)for(let e=a;e<o;e++){const i=t[e];i<h&&(h=i),i>d&&(d=i)}this.waveformData.push({min:h,max:d})}const c=(i+1)/h*100;this.updateLoadingProgress(c),i<h-1&&await new Promise(t=>requestAnimationFrame(t))}}drawWaveform(){if(this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),!this.waveformData)return;this.drawIntensityZones(),this.ctx.strokeStyle="#4a9eff",this.ctx.lineWidth=1,this.ctx.beginPath();const t=this.canvasHeight/2,e=.35*(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding);for(let i=0;i<this.waveformData.length;i++){const{min:s,max:n}=this.waveformData[i],a=i,o=t+s*e,r=t+n*e;this.ctx.moveTo(a,o),this.ctx.lineTo(a,r)}this.ctx.stroke(),this.drawScriptEventsOnWaveform()}drawIntensityZones(){const t=(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding)/21;this.ctx.save(),this.ctx.globalAlpha=.1;for(let e=0;e<=20;e++){const i=this.intensityToCanvasY(e),s=e/20;e%2==0&&(this.ctx.fillStyle=`rgba(255, 107, 53, ${.1+.1*s})`,this.ctx.fillRect(0,i-t/2,this.canvasWidth,t)),e%5==0&&(this.ctx.fillStyle="#949494",this.ctx.font="10px Arial",this.ctx.textAlign="right",this.ctx.globalAlpha=.8,this.ctx.fillText(e.toString(),this.canvasWidth-5,i+3),this.ctx.globalAlpha=.1)}this.ctx.restore();const e=this.intensityToCanvasY(10);this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.canvasWidth,e),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.save(),this.ctx.globalAlpha=.05,this.ctx.fillStyle="#666",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasTopPadding),this.ctx.fillRect(0,this.canvasHeight-this.canvasBottomPadding,this.canvasWidth,this.canvasBottomPadding),this.ctx.restore()}drawScriptEventsOnWaveform(){this.duration&&(this.script.forEach((t,e)=>{const i=this.timeToCanvasX(t.time),s=this.intensityToCanvasY(t.intensity),n=this.selectedEventIndices.includes(e),a=this.isDragging&&n;this.ctx.strokeStyle=n?"#00ff88":t.embedded?"#6b46c1":"#ff6b35",this.ctx.lineWidth=n?4:3,this.ctx.beginPath(),this.ctx.moveTo(i,this.canvasHeight),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.fillStyle=n?"#00ff88":t.embedded?"#6b46c1":"#ff6b35",this.ctx.beginPath(),this.ctx.arc(i,s,n?6:4,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=n?"#00ff88":"#fff",this.ctx.font=n?"bold 12px Arial":"12px Arial",this.ctx.textAlign="center",this.ctx.fillText(t.intensity.toString(),i,s-(n?12:10)),n&&!a&&(this.ctx.strokeStyle="#00ff88",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(i,s,10,0,2*Math.PI),this.ctx.stroke()),a&&(this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=3,this.ctx.setLineDash([4,4]),this.ctx.beginPath(),this.ctx.arc(i,s,12,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([]))}),this.isDragging||this.drawInterpolationPreview())}drawInterpolationPreview(){if(2!==this.selectedEventIndices.length)return;const[t,e]=this.selectedEventIndices,i=this.script[t],s=this.script[e],n=this.timeToCanvasX(i.time),a=this.intensityToCanvasY(i.intensity),o=this.timeToCanvasX(s.time),r=this.intensityToCanvasY(s.intensity),h=document.getElementById("interpolationType"),d=h?h.value:"linear";this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([8,4]),this.ctx.beginPath();for(let t=0;t<=50;t++){const e=t/50,i=n+(o-n)*e,s=a+(r-a)*this.applyEasing(e,d);0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(0, 255, 136, 0.6)";for(let t=5;t<=45;t+=5){const e=t/50,i=n+(o-n)*e,s=a+(r-a)*this.applyEasing(e,d);this.ctx.beginPath(),this.ctx.arc(i,s,2,0,2*Math.PI),this.ctx.fill()}if(h){const t=(n+o)/2,e=a+(r-a)*this.applyEasing(.5,d);this.ctx.fillStyle="rgba(0, 255, 136, 0.9)",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText(d.replace(/([A-Z])/g," $1"),t,e-15)}}showHideInterpolationPanel(){let t=document.getElementById("interpolationPanel");2===this.selectedEventIndices.length?t?t.style.display="block":this.createInterpolationPanel():t&&(t.style.display="none")}createInterpolationPanel(){const t=document.createElement("div");t.id="interpolationPanel",t.style.cssText="\n                    position: fixed;\n                    top: 200px;\n                    right: 30px;\n                    background: #2a2a2a;\n                    border: 2px solid #0078d4;\n                    border-radius: 8px;\n                    padding: 15px;\n                    z-index: 1000;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n                    color: #fff;\n                    min-width: 250px;\n                ",t.innerHTML='\n                    <h4 style="margin: 0 0 10px 0; color: #0078d4;">Interpolation</h4>\n                    <div style="margin-bottom: 15px;">\n                        <label>Easing Type:</label>\n                        <select id="interpolationType" style="width: 100%; padding: 4px; margin-top: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444;">\n                            <option value="linear">Linear</option>\n                            <option value="easeIn">Ease In</option>\n                            <option value="easeOut">Ease Out</option>\n                            <option value="easeInOut">Ease In/Out</option>\n                        </select>\n                    </div>\n                    <div style="display: flex; gap: 8px;">\n                        <button id="generateInterpolation" style="flex: 1; padding: 8px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">Generate</button>\n                        <button id="closeInterpolation" style="padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">×</button>\n                    </div>\n                ',document.body.appendChild(t),document.getElementById("generateInterpolation").onclick=()=>this.generateInterpolation(),document.getElementById("closeInterpolation").onclick=()=>this.closeInterpolationPanel(),document.getElementById("interpolationType").onchange=()=>{this.updateVisualization()}}closeInterpolationPanel(){const t=document.getElementById("interpolationPanel");t&&(t.style.display="none"),this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList()}generateInterpolation(){if(2!==this.selectedEventIndices.length)return;const[t,e]=this.selectedEventIndices,i=this.script[t],s=this.script[e],n=document.getElementById("interpolationType").value,a=s.time-i.time,o=s.intensity-i.intensity,r=Math.max(100,Math.floor(50*a)),h=[];let d=i.intensity;for(let t=1;t<r;t++){const e=t/r,s=this.applyEasing(e,n),c=Math.round(i.intensity+o*s),l=Math.max(0,Math.min(20,c));if(l!==d){const t=i.time+a*e;h.push({time:parseFloat(t.toFixed(3)),intensity:l}),d=l}}this.script=this.script.concat(h),this.script.sort((t,e)=>t.time-e.time),this.selectedEventIndices=[],this.closeInterpolationPanel(),this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.updateStatus(`Generated ${h.length} intensity changes between ${this.formatTime(i.time)} and ${this.formatTime(s.time)}`)}applyEasing(t,e){switch(e){case"easeIn":return t*t;case"easeOut":return 1-Math.pow(1-t,2);case"easeInOut":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;default:return t}}startDrag(t,e){return 0!==this.selectedEventIndices.length&&(this.isDragging=!0,this.dragType=t,this.dragStartPos={...e},this.dragEventStartPositions=this.selectedEventIndices.map(t=>({eventObject:this.script[t],originalTime:this.script[t].time,originalIntensity:this.script[t].intensity})),"canvas"===t?this.canvas.classList.add("dragging"):"timeline"===t&&this.timeline.classList.add("dragging"),!0)}processDrag(t){if(!this.isDragging||0===this.dragEventStartPositions.length)return;const e=t.x-this.dragStartPos.x,i=t.y-this.dragStartPos.y;"canvas"===this.dragType?this.processDragIntensity(i):"timeline"===this.dragType&&this.processDragTime(e),this.updateVisualization()}processDragIntensity(t){const e=20/this.canvasHeight,i=Math.round(-t*e);let s=1/0,n=-1/0;this.dragEventStartPositions.forEach(t=>{s=Math.min(s,t.originalIntensity),n=Math.max(n,t.originalIntensity)});const a=Math.max(-s,Math.min(i,20-n));this.dragEventStartPositions.forEach(t=>{const e=Math.max(0,Math.min(20,t.originalIntensity+a));t.eventObject.intensity=e,t.eventObject.embedded&&e!==t.originalIntensity&&delete t.eventObject.embedded})}processDragTime(t){const e=t*((this.viewportEnd-this.viewportStart)/this.canvasWidth);let i=1/0,s=-1/0;this.dragEventStartPositions.forEach(t=>{i=Math.min(i,t.originalTime),s=Math.max(s,t.originalTime)});const n=Math.max(-i,Math.min(e,this.duration-s));this.dragEventStartPositions.forEach(t=>{const e=Math.max(0,Math.min(this.duration,t.originalTime+n));t.eventObject.time=parseFloat(e.toFixed(3)),t.eventObject.embedded&&e!==t.originalTime&&delete t.eventObject.embedded}),this.script.sort((t,e)=>t.time-e.time),this.updateSelectedIndicesAfterSort()}updateSelectedIndicesAfterSort(){this.selectedEventIndices=this.dragEventStartPositions.map(t=>this.script.indexOf(t.eventObject)).filter(t=>-1!==t),this.selectedEventIndices.sort((t,e)=>t-e)}endDrag(){if(!this.isDragging)return;this.isDragging=!1,this.dragType=null,this.dragEventStartPositions=[],this.canvas.classList.remove("dragging"),this.timeline.classList.remove("dragging"),this.updateVisualization(),this.updateEventList(),this.updateScriptData();const t=this.selectedEventIndices.length;this.updateStatus(`Moved ${t} event${t>1?"s":""}`)}handleCanvasClick(t){if(!this.duration)return;const e=this.getCanvasMousePos(t),i=this.canvasXToTime(e.x),s=this.canvasYToIntensity(e.y),n=this.findEventAtPosition(e.x,e.y);return-1!==n?(this.handleEventSelection(n,t.ctrlKey||t.metaKey,t.shiftKey),void this.updateStatus(`Selected event: ${this.formatTime(i)}, intensity ${this.script[n].intensity}`)):this.selectedEventIndices.length>0?(this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList(),this.showHideInterpolationPanel(),void this.updateStatus("Selection cleared - click again to add new event")):(this.addScriptEvent(i,s),void this.updateStatus(`Added event at ${this.formatTime(i)} with intensity ${s}`))}handleCanvasMouseDown(t){if(!this.duration)return;const e=this.getCanvasMousePos(t),i=this.findEventAtPosition(e.x,e.y);if(-1!==i&&this.selectedEventIndices.includes(i))return this.dragStartPos={...e},void t.preventDefault();this.handleCanvasClick(t)}handleCanvasMouseMove(t){if(!this.duration)return;const e=this.getCanvasMousePos(t);if(this.hoverTime=this.canvasXToTime(e.x),this.isHoveringWaveform=!0,!this.isDragging&&this.dragStartPos&&this.selectedEventIndices.length>0&&Math.sqrt(Math.pow(e.x-this.dragStartPos.x,2)+Math.pow(e.y-this.dragStartPos.y,2))>this.dragThreshold&&this.startDrag("canvas",this.dragStartPos),this.isDragging)return void this.processDrag(e);const i=this.canvasXToTime(e.x),s=this.canvasYToIntensity(e.y);this.updateTimeInfo(i,s)}handleCanvasMouseUp(t){this.dragStartPos=null,this.isDragging&&this.endDrag()}handleTimelineMouseDown(t){if(!this.duration)return;const e=this.getTimelineMousePos(t),i=this.findTimelineEventAtPosition(e.x);if(-1!==i&&this.selectedEventIndices.includes(i))return this.dragStartPos={x:e.x,y:0},t.preventDefault(),void t.stopPropagation();this.handleTimelineClick(t)}handleTimelineMouseEnter(t){this.isHoveringTimeline=!0}handleTimelineMouseLeave(t){this.isHoveringTimeline=!1,this.isHoveringWaveform||(this.hoverTime=null)}handleTimelineMouseMove(t){if(!this.duration)return;const e=this.getTimelineMousePos(t),i=this.timeline.getBoundingClientRect().width,s=this.viewportEnd-this.viewportStart,n=e.x/i;this.hoverTime=this.viewportStart+n*s,this.isHoveringTimeline=!0,!this.isDragging&&this.dragStartPos&&this.selectedEventIndices.length>0&&Math.abs(e.x-this.dragStartPos.x)>this.dragThreshold&&this.startDrag("timeline",this.dragStartPos),this.isDragging&&"timeline"===this.dragType&&this.processDrag({x:e.x,y:0})}handleTimelineMouseUp(t){this.dragStartPos=null,this.isDragging&&"timeline"===this.dragType&&this.endDrag()}findTimelineEventAtPosition(t){const e=this.timeline.getBoundingClientRect().width;for(let i=0;i<this.script.length;i++){const s=this.script[i],n=this.viewportEnd-this.viewportStart,a=(s.time-this.viewportStart)/n*e;if(Math.abs(t-a)<=10)return i}return-1}handleEventSelection(t,e,i){if(this.clearPasteState(),i&&null!==this.selectionAnchor){const e=Math.min(this.selectionAnchor,t),i=Math.max(this.selectionAnchor,t);this.selectedEventIndices=[];for(let t=e;t<=i;t++)this.selectedEventIndices.push(t)}else if(e){const e=this.selectedEventIndices.indexOf(t);-1!==e?this.selectedEventIndices.splice(e,1):this.selectedEventIndices.push(t)}else this.selectedEventIndices=[t],this.selectionAnchor=t;this.selectedEventIndices.sort((t,e)=>t-e),this.updateVisualization(),this.updateEventList(),this.showHideInterpolationPanel()}findEventAtPosition(t,e){for(let i=0;i<this.script.length;i++){const s=this.script[i],n=this.timeToCanvasX(s.time),a=this.intensityToCanvasY(s.intensity);if(Math.sqrt(Math.pow(t-n,2)+Math.pow(e-a,2))<=10)return i}return-1}addScriptEvent(t,e){const i={time:parseFloat(t.toFixed(3)),intensity:e};this.script.push(i),this.script.sort((t,e)=>t.time-e.time),this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.updateStatus(`Added event at ${this.formatTime(t)} with intensity ${e}`)}removeScriptEvent(t){t>=0&&t<this.script.length&&(this.script.splice(t,1),this.selectedEventIndices=this.selectedEventIndices.map(e=>e>t?e-1:e).filter(e=>e!==t),this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.showHideInterpolationPanel(),this.updateStatus("Event removed"))}removeSelectedEvents(){if(0===this.selectedEventIndices.length)return;if(this.selectedEventIndices.length>3&&!confirm(`Are you sure you want to delete ${this.selectedEventIndices.length} events?`))return;const t=[...this.selectedEventIndices].sort((t,e)=>e-t);t.forEach(t=>{this.script.splice(t,1)}),this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.showHideInterpolationPanel();const e=t.length;this.updateStatus(`Removed ${e} event${e>1?"s":""}`)}selectEvent(t){this.selectedEventIndices=[t],this.updateVisualization(),this.updateEventList(),this.showHideInterpolationPanel()}copySelectedEvents(){if(0===this.selectedEventIndices.length)return void this.updateStatus("No events selected to copy");const t=this.selectedEventIndices.map(t=>this.script[t]).sort((t,e)=>t.time-e.time),e=t[0].time;this.clipboard=t.map(t=>({time:t.time-e,intensity:t.intensity})),this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.updateStatus(`Copied ${this.clipboard.length} event${this.clipboard.length>1?"s":""}`)}cutSelectedEvents(){if(0===this.selectedEventIndices.length)return void this.updateStatus("No events selected to cut");this.copySelectedEvents();const t=this.selectedEventIndices.length;this.removeSelectedEvents(),this.clipboardFromCut=!0,this.updateStatus(`Cut ${t} event${t>1?"s":""}`)}pasteEvents(){if(!this.audioBuffer)return void this.updateStatus("Load audio file first");if(0===this.clipboard.length)return void this.updateStatus("No events in clipboard");let t=this.calculatePastePosition();const e=this.calculateEventSpacing(),i=this.clipboard[this.clipboard.length-1].time;if(t+i>this.duration){if(!this.clipboardFromCut||null!==this.lastPasteEndTime||null===this.hoverTime||!this.isHoveringWaveform&&!this.isHoveringTimeline)return void this.updateStatus("Cannot paste: would exceed audio duration");{const e=.1;if(t=Math.max(0,this.duration-i-e),t<0)return void this.updateStatus("Cannot paste: clipboard duration exceeds audio length")}}this.selectedEventIndices=[];const s=[];this.clipboard.forEach(e=>{const i={time:parseFloat((t+e.time).toFixed(3)),intensity:e.intensity};this.script.push(i),s.push(i)}),this.script.sort((t,e)=>t.time-e.time),this.selectedEventIndices=s.map(t=>this.script.findIndex(e=>e===t)).filter(t=>-1!==t),this.lastPasteEndTime=t+i+e,this.pasteCount++,this.clipboardFromCut=!1,this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.showHideInterpolationPanel(),this.updateStatus(`Pasted ${this.clipboard.length} event${this.clipboard.length>1?"s":""} at ${this.formatTime(t)}`)}calculatePastePosition(){if(null!==this.lastPasteEndTime)return Math.min(this.lastPasteEndTime,this.duration);if(this.pasteCount=0,this.selectedEventIndices.length>0){const t=this.selectedEventIndices.map(t=>this.script[t]).sort((t,e)=>e.time-t.time)[0].time,e=this.calculateEventSpacing();return Math.min(t+e,this.duration)}if(this.isPlaying){const t=this.calculateEventSpacing();return Math.min(this.currentTime+t,this.duration)}if(this.clipboardFromCut&&null!==this.hoverTime&&(this.isHoveringWaveform||this.isHoveringTimeline))return this.hoverTime;const t=(this.viewportStart+this.viewportEnd)/2;return Math.min(t,this.duration)}calculateEventSpacing(){let t=.5;if(this.clipboard.length>1){const e=this.clipboard[this.clipboard.length-1].time;t=Math.max(.1,.1*e)}const e=this.viewportEnd-this.viewportStart,i=this.duration/e;return i>10?t*=.5:i<2&&(t*=2),this.duration>300?t*=1.5:this.duration<60&&(t*=.5),Math.max(.05,Math.min(2,t))}clearPasteState(){this.lastPasteEndTime=null,this.pasteCount=0}updateVisualization(){this.drawWaveform(),this.updateTimeline()}updateTimeline(){const t=document.getElementById("scriptEvents");t.innerHTML="",this.duration&&this.script.forEach((e,i)=>{const s=document.createElement("div");s.className="script-event",this.selectedEventIndices.includes(i)&&s.classList.add("selected"),e.embedded&&s.classList.add("embedded"),this.isDragging&&this.selectedEventIndices.includes(i)&&s.classList.add("dragging");const n=this.viewportEnd-this.viewportStart,a=(e.time-this.viewportStart)/n*100;a>=0&&a<=100&&(s.style.left=`${a}%`,s.style.width="0.2%",s.title=`Time: ${this.formatTime(e.time)}, Intensity: ${e.intensity}`,s.onclick=t=>{t.stopPropagation(),this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey)},t.appendChild(s))})}updateEventList(){const t=document.getElementById("eventList");t.innerHTML="",this.script.forEach((e,i)=>{const s=document.createElement("div");s.className="event-item",this.selectedEventIndices.includes(i)&&s.classList.add("selected"),s.innerHTML=`\n                        <div class="event-details">\n                            ${this.formatTime(e.time)} | Intensity: ${e.intensity}\n                        </div>\n                        <div class="event-actions">\n                            <button class="danger" onclick="scriptEditor.removeScriptEvent(${i})" style="padding: 4px 8px; font-size: 12px;">×</button>\n                        </div>\n                    `,s.onclick=t=>{t.target.matches("button")||(this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey),1===this.selectedEventIndices.length&&this.seekTo(e.time))},t.appendChild(s)}),0===this.script.length&&(t.innerHTML='<div style="color: #666; text-align: center; padding: 20px;">No events yet<br>Click on waveform to add</div>')}updateScriptData(){const t=this.script.map(t=>({time:t.time,intensity:t.intensity}));this.scriptTextarea.value=JSON.stringify(t,null,2)}clearScript(){confirm("Clear all script events?")&&(this.script=[],this.selectedEventIndices=[],this.clipboard=[],this.clearPasteState(),this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.updateStatus("Script cleared"))}exportScript(){if(0===this.script.length)return void alert("No script events to export");const t=this.script.map(t=>({time:t.time,intensity:t.intensity})),e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");if(n.href=s,this.originalFileName){const t=this.originalFileName.replace(/\.[^/.]+$/,"");n.download=`${t}.json`}else n.download="lovense_script.json";n.click(),URL.revokeObjectURL(s),this.updateStatus("Script exported")}validateScript(t){for(const e of t){if("number"!=typeof e.time||"number"!=typeof e.intensity)throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}handleScriptFileImport(t){const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const i=JSON.parse(t.target.result);if(!Array.isArray(i))throw new Error("Script must be an array");this.validateScript(i),this.script=i.sort((t,e)=>t.time-e.time),this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList(),this.updateScriptData(),this.updateStatus(`Imported ${this.script.length} events from ${e.name}`)}catch(t){alert(`Error importing script file: ${t.message}`)}},i.readAsText(e)}updateScript(){try{const t=this.scriptTextarea.value,e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Script must be an array");this.validateScript(e),this.script=e.sort((t,e)=>t.time-e.time),this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList(),this.updateStatus(`Imported ${this.script.length} events`)}catch(t){alert(`Error importing script: ${t.message}`)}}async play(){if(this.audioBuffer&&!this.isPlaying)try{await this.initializeAudioContext(),this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.audioContext.destination);const t=this.pauseTime||0;this.startTime=this.audioContext.currentTime-t,this.isPlaying=!0,this.source.start(0,t),this.startPlaybackLoop(),this.source.onended=()=>{this.stop()},document.getElementById("playPauseBtn").textContent="Pause",document.getElementById("stopBtn").disabled=!1,this.updateStatus("Playing with haptic sync")}catch(t){this.updateStatus(`Error playing: ${t.message}`)}}pause(){this.source&&this.isPlaying&&(this.source.onended=null,this.pauseTime=this.audioContext.currentTime-this.startTime,this.source.stop(),this.source=null,this.isPlaying=!1,this.stopHapticOutput(),document.getElementById("playPauseBtn").textContent="Play",this.updateStatus("Paused"))}stop(){this.source&&(this.source.onended=null,this.source.stop(),this.source=null),this.isPlaying=!1,this.pauseTime=0,this.currentTime=0,this.stopHapticOutput(),document.getElementById("playPauseBtn").textContent="Play",document.getElementById("stopBtn").disabled=!0,this.updatePlayhead(),this.updateTimeInfo(),this.updateStatus("Stopped")}seekTo(t){const e=this.isPlaying;e&&this.pause(),this.pauseTime=Math.max(0,Math.min(t,this.duration)),this.currentTime=this.pauseTime,this.updatePlayhead(),this.updateTimeInfo(),e&&this.play()}startPlaybackLoop(){const t=()=>{this.isPlaying&&(this.currentTime=this.audioContext.currentTime-this.startTime,this.updatePlayhead(),this.updateTimeInfo(),this.processHapticEvents(),this.currentTime<this.duration&&requestAnimationFrame(t))};t()}processHapticEvents(){let t=null,e=null;for(let i=0;i<this.script.length;i++){const s=this.script[i];if(!(s.time<=this.currentTime+.01)){e=s;break}t=s}t&&t.time>this.currentTime-.02?this.activeIntensity!==t.intensity&&(this.triggerHapticEvent(t),this.activeIntensity=t.intensity):t||0===this.activeIntensity||(this.stopHapticOutput(),this.activeIntensity=0)}async triggerHapticEvent(t){console.log(`🎮 Haptic Event: Setting intensity to ${t.intensity}/20 at ${this.formatTime(t.time)}`),await this.sendCommand(`Vibrate:${t.intensity};`),this.waveformContainer.className=this.waveformContainer.className.replace(/\bintensity-\d+\b/g,""),t.intensity>0&&this.waveformContainer.classList.add(`intensity-${t.intensity}`)}async stopHapticOutput(){console.log("🛑 Haptic Stop: Setting intensity to 0"),await this.sendCommand("Vibrate:0;"),this.waveformContainer.className=this.waveformContainer.className.replace(/\bintensity-\d+\b/g,"")}updatePlayhead(){const t=document.getElementById("playhead");if(!this.duration)return void(t.style.left="0%");const e=this.viewportEnd-this.viewportStart,i=(this.currentTime-this.viewportStart)/e,s=Math.min(100,Math.max(0,100*i));t.style.left=`${s}%`}updateTimeInfo(t=null,e=null){const i=document.getElementById("timeInfo"),s=`${this.formatTime(this.currentTime)} / ${this.formatTime(this.duration)}`;null!==t&&null!==e?i.textContent=`${s} | ${this.formatTime(t)} @ intensity ${e}`:this.isPlaying?i.textContent=`${s} | Audio playing...`:i.textContent=`${s} | Hover for intensity preview`}formatTime(t){if(!t||isNaN(t))return"00:00";const e=Math.floor(t/60),i=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}handleCanvasMouseLeave(){this.updateTimeInfo(),this.dragStartPos=null,this.isHoveringWaveform=!1,this.hoverTime=null,this.isDragging&&this.endDrag()}handleCanvasWheel(t){if(!this.duration)return;t.preventDefault();const e=Date.now(),i=e-this.lastScrollTime;this.scrollVelocity=i<this.velocityThreshold?this.scrollVelocity+1:1,this.lastScrollTime=e;const s=this.getCanvasMousePos(t),n=this.canvasXToTime(s.x);if(t.shiftKey){const e=this.viewportEnd-this.viewportStart,i=(t.deltaY>0?1:-1)*e*.1;this.panViewportHorizontally(i)}else{const e=Math.max(.3,1/Math.sqrt(this.zoomLevel)),i=Math.min(1.5,1+.1*this.scrollVelocity),s=this.baseZoomFactor+i*e*.05,a=t.deltaY>0?1/s:s;this.zoomToPoint(a,n)}}handleTimelineClick(t){if(!this.duration)return;const e=t.currentTarget.getBoundingClientRect(),i=t.clientX-e.left,s=e.width,n=this.viewportEnd-this.viewportStart,a=i/s,o=this.viewportStart+a*n;this.seekTo(o),this.updateStatus(`Seeked to ${this.formatTime(o)}`)}async downloadSyncedAudio(){if(this.isMP3File&&this.originalFileBuffer)if(0!==this.script.length)try{this.updateStatus("Creating synced audio file...");const t=this.script.map(t=>({time:t.time,intensity:t.intensity})),e=await this.id3Handler.embedScript(this.originalFileBuffer,t);if(!e)return void this.updateStatus("Error: Failed to create synced file");const i=URL.createObjectURL(e),s=document.createElement("a");s.href=i;const n=this.originalFileName.replace(/\.mp3$/i,"");s.download=`${n}_lvs-synced.mp3`,s.click(),URL.revokeObjectURL(i),this.updateStatus(`Downloaded synced audio: ${s.download}`)}catch(t){this.updateStatus(`Error creating synced audio: ${t.message}`),console.error("Sync error:",t)}else this.updateStatus("Error: No script events to embed");else this.updateStatus("Error: No MP3 file loaded")}updateStatus(t){this.statusDiv.textContent=t,console.log(t)}initializeEventListeners(){document.getElementById("audioFile").onchange=t=>{const e=t.target.files[0];e&&this.loadAudioFile(e)},document.getElementById("playPauseBtn").onclick=()=>{this.isPlaying?this.pause():this.play()},document.getElementById("stopBtn").onclick=()=>this.stop(),document.getElementById("connectDeviceBtn").onclick=()=>this.handleDeviceConnection(),document.getElementById("zoomInBtn").onclick=()=>{const t=(this.viewportStart+this.viewportEnd)/2;this.zoomToPoint(1.25,t)},document.getElementById("zoomOutBtn").onclick=()=>{const t=(this.viewportStart+this.viewportEnd)/2;this.zoomToPoint(.8,t)},document.getElementById("zoomFitBtn").onclick=()=>this.zoomFit(),this.canvas.onmousedown=t=>this.handleCanvasMouseDown(t),this.canvas.onmousemove=t=>this.handleCanvasMouseMove(t),this.canvas.onmouseup=t=>this.handleCanvasMouseUp(t),this.canvas.onmouseleave=()=>this.handleCanvasMouseLeave(),this.canvas.onwheel=t=>this.handleCanvasWheel(t),this.timeline.onmousedown=t=>this.handleTimelineMouseDown(t),this.timeline.onmousemove=t=>this.handleTimelineMouseMove(t),this.timeline.onmouseup=t=>this.handleTimelineMouseUp(t),this.timeline.onmouseenter=t=>this.handleTimelineMouseEnter(t),this.timeline.onmouseleave=t=>this.handleTimelineMouseLeave(t),document.onmousemove=t=>{this.isDragging&&"canvas"===this.dragType?this.handleCanvasMouseMove(t):this.isDragging&&"timeline"===this.dragType&&this.handleTimelineMouseMove(t)},document.onmouseup=()=>{this.isDragging&&this.endDrag(),this.dragStartPos=null},document.getElementById("clearScript").onclick=()=>this.clearScript(),document.getElementById("exportBtn").onclick=()=>this.exportScript(),document.getElementById("importBtn").onclick=()=>this.updateScript(),document.getElementById("scriptFile").onchange=t=>this.handleScriptFileImport(t),document.getElementById("downloadSyncedBtn").onclick=()=>this.downloadSyncedAudio(),window.onresize=()=>{setTimeout(()=>{this.setupCanvas(),this.drawWaveform()},100)},document.onkeydown=t=>{if("TEXTAREA"!==t.target.tagName){if((t.ctrlKey||t.metaKey)&&"KeyC"===t.code)return t.preventDefault(),void this.copySelectedEvents();if((t.ctrlKey||t.metaKey)&&"KeyX"===t.code)return t.preventDefault(),void this.cutSelectedEvents();if((t.ctrlKey||t.metaKey)&&"KeyV"===t.code)return t.preventDefault(),void this.pasteEvents();switch(t.code){case"Space":t.preventDefault(),this.isPlaying?this.pause():this.play();break;case"Delete":case"Backspace":t.preventDefault(),this.selectedEventIndices.length>0&&this.removeSelectedEvents();break;case"Escape":this.isDragging?this.endDrag():this.selectedEventIndices.length>0&&(this.selectedEventIndices=[],this.updateVisualization(),this.updateEventList(),this.showHideInterpolationPanel())}}}}}const scriptEditor=new LovenseScriptEditor;
</script>
</body>

</html>