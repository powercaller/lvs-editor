<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVS Media Script Editor</title>
    <style>*{box-sizing:border-box}body{background:#1e1e1e;color:#fff;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;min-height:100vh;padding:20px}.container{margin:0 auto;max-width:1400px}.header{margin-bottom:30px;text-align:center}.controls{flex-wrap:wrap;gap:15px;margin-bottom:20px}.control-group,.controls{align-items:center;display:flex}.control-group{background:#2a2a2a;border-radius:6px;gap:8px;padding:8px 12px}button{background:#0078d4;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:14px;padding:8px 16px;transition:background .2s}button:hover:not(:disabled){background:#106ebe}button:disabled{background:#404040;cursor:not-allowed}button.danger{background:#d13438}button.danger:hover:not(:disabled){background:#b71c1c}input[type=file]{display:none}.file-label{background:#6b46c1;border-radius:4px;color:#fff;cursor:pointer;display:inline-block;font-size:14px;padding:8px 16px}.file-label:hover{background:#553c9a}.waveform-container{background:#2a2a2a;border-radius:8px;margin-bottom:20px;padding:20px;position:relative;text-align:center;z-index:1}.waveform-container:before{background:linear-gradient(45deg,rgba(255,107,53,.8) 30%,rgba(255,107,53,.8) 60%,rgba(255,107,53,.8) 100%,transparent 0);border-radius:16px;bottom:-15px;content:"";filter:blur(8px);left:-30px;opacity:0;pointer-events:none;position:absolute;right:-30px;top:45px;transform:scale(.95);transition:all .3s ease;will-change:transform,opacity,filter;z-index:-1}.waveform-header{align-items:center;display:flex;justify-content:space-between;margin-bottom:15px}.time-info{color:#888;font-family:monospace}.waveform-canvas{background:#1a1a1a;border-radius:4px;cursor:crosshair;display:block;height:300px;transition:all .2s ease;width:100%}.waveform-canvas.drag-over{background:#2a3f5f;border:2px dashed #0078d4;cursor:copy}.waveform-canvas.dragging{cursor:grabbing!important}.timeline{background:#333;border-radius:4px;cursor:pointer;height:30px;margin-top:10px;position:relative}.timeline.dragging{cursor:grabbing!important}.timeline.dragging .script-event{cursor:grabbing}.playhead{background:#f44;pointer-events:none;width:2px;z-index:2}.playhead,.script-events{height:100%;position:absolute;top:0}.script-events{width:100%}.script-event{align-items:center;background:linear-gradient(45deg,#ff6b35,#f7931e);border-radius:2px;color:#000;cursor:pointer;display:flex;font-size:10px;font-weight:700;height:100%;justify-content:center;min-width:3px;position:absolute;transition:opacity .2s}.script-event:hover{box-shadow:0 0 5px rgba(255,107,53,.8);opacity:.8}.script-event.selected{outline:2px solid #fff;z-index:1}.script-event.grabbable{cursor:grab}.script-event.embedded{background:linear-gradient(45deg,#6b46c1,#9333ea)}.script-event.dragging{opacity:.7;z-index:3}.script-panel{display:grid;gap:20px;grid-template-columns:2fr 1fr}.event-list{background:#2a2a2a;border-radius:8px;max-height:400px;overflow-y:auto;padding:20px}.event-item{align-items:center;background:#333;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;margin-bottom:8px;padding:12px;transition:background .2s}.event-item:hover{background:#404040}.event-item.selected{background:#0078d4}.event-details{font-family:monospace;font-size:12px}.event-actions{display:flex;gap:5px}.export-import{background:#2a2a2a;border-radius:8px;padding:20px}.script-textarea{background:#1a1a1a;border:1px solid #444;border-radius:4px;color:#fff;height:200px;padding:10px;resize:vertical;width:100%}.script-textarea,.status{font-family:monospace;font-size:12px}.status{background:#333;border-radius:8px;color:#ccc;padding:15px}.instructions{background:#2a2a2a;border-left:4px solid #0078d4;border-radius:8px;margin-bottom:20px;overflow:hidden;transition:all .3s ease}.instructions-header{align-items:center;cursor:pointer;display:flex;justify-content:space-between;padding:15px;transition:background .2s ease;user-select:none}.instructions-header:hover{background:#333}.instructions-header h3{color:#0078d4;margin:0}.instructions-toggle{color:#0078d4;font-size:18px;font-weight:700;transition:transform .3s ease}.instructions-toggle.expanded{transform:rotate(180deg)}.instructions-content{max-height:0;overflow:hidden;transition:max-height .3s ease}.instructions-content.expanded{max-height:500px}.instructions-list{padding:0 15px 15px}.instruction-item{background:#1e1e1e;margin-bottom:8px;padding:8px 12px}.instruction-number{color:#0078d4;font-weight:700;margin-right:8px}.loading-overlay{align-items:center;backdrop-filter:blur(4px);background:rgba(0,0,0,.8);display:flex;height:100%;justify-content:center;left:0;position:fixed;top:0;width:100%;z-index:10000}.loading-content{background:#2a2a2a;border:2px solid #0078d4;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.6);min-width:300px;padding:30px;text-align:center}.loading-stage{color:#fff;font-size:18px;font-weight:600;margin-bottom:20px}.progress-container{margin-bottom:15px}.progress-bar{background:#1a1a1a;border-radius:4px;height:8px;margin-bottom:10px;overflow:hidden;position:relative;width:100%}.progress-fill{background:linear-gradient(90deg,#0078d4,#00a1f1);border-radius:4px;height:100%;transition:width .3s ease;width:0}.progress-fill.indeterminate{animation:indeterminateProgress 2s ease-in-out infinite;width:30%}@keyframes indeterminateProgress{0%{transform:translateX(-100%)}50%{transform:translateX(350%)}to{transform:translateX(-100%)}}.progress-text{color:#ccc;font-family:monospace;font-size:14px}.loading-spinner{animation:spin 1s ease-in-out infinite;border:2px solid #666;border-radius:50%;border-top-color:#0078d4;display:inline-block;height:20px;margin-left:10px;width:20px}@keyframes spin{to{transform:rotate(1turn)}}.intensity-1:before{filter:blur(6px);opacity:.15}.intensity-2:before{filter:blur(7px);opacity:.2}.intensity-3:before{filter:blur(8px);opacity:.25}.intensity-4:before{filter:blur(9px);opacity:.3}.intensity-5:before{filter:blur(10px);opacity:.35}.intensity-6:before{filter:blur(11px);opacity:.4}.intensity-7:before{filter:blur(12px);opacity:.45}.intensity-8:before{filter:blur(13px);opacity:.5}.intensity-9:before{filter:blur(14px);opacity:.55}.intensity-10:before{filter:blur(15px);opacity:.6}.intensity-11:before{filter:blur(16px);opacity:.65}.intensity-12:before{filter:blur(17px);opacity:.7}.intensity-13:before{filter:blur(18px);opacity:.75}.intensity-14:before{filter:blur(19px);opacity:.8}.intensity-15:before{filter:blur(20px);opacity:.85}.intensity-16:before{filter:blur(21px);opacity:.9}.intensity-17:before{filter:blur(22px);opacity:.95}.intensity-18:before{filter:blur(23px);opacity:1}.intensity-19:before{filter:blur(24px);opacity:1}.intensity-20:before{filter:blur(25px);opacity:1}.drag-preview{align-items:center;background:rgba(0,255,136,.6);border:2px dashed #0f8;border-radius:4px;color:#000;display:flex;font-size:11px;font-weight:700;justify-content:center}.drag-preview,.selection-box{pointer-events:none;position:absolute;z-index:100}.selection-box{background-color:rgba(0,255,136,.2);border:1px solid #0f8;display:none}.mobile-warning{backdrop-filter:blur(4px);background:rgba(0,0,0,.8);color:#fff;display:none;height:100%;left:0;padding:20px;position:fixed;text-align:center;top:0;width:100%;z-index:20000}.mobile-warning .message{background:#2a2a2a;border:2px solid #0078d4;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.6);left:50%;padding:30px;position:absolute;top:50%;transform:translate(-50%,-50%)}@media (max-width:767px){.mobile-warning{align-items:center;display:flex;justify-content:center}}.video-element{border-radius:4px;display:none;max-height:400px;object-fit:contain;width:100%}.waveform-container.video-active .waveform-canvas{height:150px}.video-container{display:inline-block;margin-bottom:10px;position:relative}.fullscreen-btn{background:rgba(0,0,0,.6);border:none;border-radius:4px;bottom:10px;color:#fff;cursor:pointer;opacity:0;padding:8px 8px 4px;position:absolute;right:10px;transition:opacity .3s}.video-container:hover .fullscreen-btn{opacity:1}</style>
</head>

<body>
    <div class="mobile-warning">
        <div class="message">
            <h1>Desktop only...</h1>
            <p>This app was tested on and built for larger screens, you can still use it, but may not work as intended!</p>
            <button id="continue-anyway">Yea I get it, let me in!</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>LVS Media Script Editor</h1>
            <p>Create precise haptic scripts synchronized to media</p>
        </div>

        <div class="instructions">
            <div class="instructions-header" id="instructions">
                <h3>How to Use</h3>
                <span class="instructions-toggle" id="instructionsToggle">â–¼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <div class="instructions-list">
                    <div class="instruction-item">
                        <span class="instruction-number">0.</span>
                        (Optional) Put your device in pairing mode, then click "Connect Device".
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">1.</span>
                        Load an audio or mp4 video file or drag and drop it onto the waveform.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">2.</span>
                        Click on the waveform to add an event (X-axis for time, Y-axis for intensity 0-20). Click the timeline to seek.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">3.</span>
                        Use the mouse wheel to zoom. Scroll horizontally to pan, or hold Shift and use the mouse wheel.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">4.</span>
                        Events hold their intensity until the next one.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">5.</span>
                        Press the spacebar or the play/pause button to test the media-haptic sync.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">6.</span>
                        Select events by clicking them. Use Ctrl+click for multi-select, Shift+click for range-select, or drag a box over the waveform. Press Delete to remove selected events.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">7.</span>
                        Use Ctrl+C, Ctrl+X, and Ctrl+V to copy, cut, and paste.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">8.</span>
                        Undo with Ctrl+Z and redo with Ctrl+Shift+Z.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">9.</span>
                        Drag selected events on the waveform to adjust intensity, or on the timeline to adjust time.
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">10.</span>
                        Download the synced MP3 or export the script for other formats.
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="loadMedia" class="file-label">Load Media File</label>
                <input type="file" id="loadMedia" accept="audio/*,video/mp4,video/x-matroska,.mkv">
            </div>

            <div class="control-group">
                <button id="playPauseBtn" disabled>Play</button>
                <button id="stopBtn" disabled>Stop</button>
            </div>

            <div class="control-group">
                <button id="connectDeviceBtn">Connect Device</button>
                <span id="connectionStatus" style="font-size: 12px; color: #666; margin-left: 8px;">Not connected</span>
            </div>

            <div class="control-group">
                <button id="zoomInBtn" disabled>Zoom In</button>
                <button id="zoomOutBtn" disabled>Zoom Out</button>
                <button id="zoomFitBtn" disabled>Zoom Fit</button>
            </div>

            <div class="control-group">
                <button id="clearScript" class="danger">Clear Script</button>
            </div>
            <div style="margin-left: auto;">
                <button id="downloadSyncedBtn" disabled>Save Synced MP3</button>
            </div>
        </div>
        <div class="status" id="status">
            Ready - Load a media file to begin
        </div>

        <div id="waveform" class="waveform-container">
            <div class="waveform-header">
                <h3>Waiting for media file...</h3>
                <div class="time-info" id="timeInfo">00:00 / 00:00 | Hover for intensity preview</div>
            </div>
            <div class="video-container">
                <video id="videoElement" class="video-element"></video>
                <button id="fullscreenBtn" class="fullscreen-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </button>
            </div>
            <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
            <div id="selectionBox" class="selection-box"></div>
            <div id="timeline" class="timeline">
                <div class="playhead" id="playhead"></div>
                <div class="script-events" id="scriptEvents"></div>
            </div>
        </div>

        <div class="script-panel">
            <div class="event-list">
                <h3>Script Events</h3>
                <div id="eventList"></div>
            </div>

            <div class="export-import">
                <h3>Funscript Data</h3>
                <textarea id="scriptData" class="script-textarea"
                    placeholder="Script data will appear here..."></textarea>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button id="exportBtn">Export Script</button>
                    <label for="scriptFile" class="file-label">Load Script</label>
                    <input type="file" id="scriptFile" accept=".json,.funscript">
                    <button id="importBtn">Update Script</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div id="loadingStage" class="loading-stage">Loading file...</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">Preparing...</div>
                </div>
            </div>
        </div>
    </div>
    <script>(()=>{var E=class{constructor(t){this.editor=t,this.elements={instructions:document.getElementById("instructions"),instructionsContent:document.getElementById("instructionsContent"),instructionsToggle:document.getElementById("instructionsToggle"),waveformCanvas:document.getElementById("waveformCanvas"),timeline:document.getElementById("timeline"),scriptData:document.getElementById("scriptData"),waveformContainer:document.getElementById("waveform"),status:document.getElementById("status"),loadingOverlay:document.getElementById("loadingOverlay"),loadingStage:document.getElementById("loadingStage"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText"),connectDeviceBtn:document.getElementById("connectDeviceBtn"),connectionStatus:document.getElementById("connectionStatus"),playPauseBtn:document.getElementById("playPauseBtn"),stopBtn:document.getElementById("stopBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomFitBtn:document.getElementById("zoomFitBtn"),downloadSyncedBtn:document.getElementById("downloadSyncedBtn"),eventList:document.getElementById("eventList"),exportBtn:document.getElementById("exportBtn"),scriptFile:document.getElementById("scriptFile"),importBtn:document.getElementById("importBtn"),selectionBox:document.getElementById("selectionBox"),timeInfo:document.getElementById("timeInfo"),loadMediaBtn:document.getElementById("loadMedia"),playhead:document.getElementById("playhead"),clearScript:document.getElementById("clearScript"),videoElement:document.getElementById("videoElement"),fullscreenBtn:document.getElementById("fullscreenBtn")},this.elements.playPauseBtn.addEventListener("click",()=>this.editor.media.togglePlayPause()),this.elements.stopBtn.addEventListener("click",()=>this.editor.media.stop()),this.elements.exportBtn.addEventListener("click",()=>this.editor.scriptManager.exportFunscript()),this.elements.importBtn.addEventListener("click",()=>this.editor.scriptManager.updateScriptFromTextarea()),this.elements.scriptFile.addEventListener("change",i=>this.editor.scriptManager.importScript(i.target.files[0])),this.elements.loadMediaBtn.addEventListener("change",i=>this.editor.loadFile(i.target.files[0])),this.elements.clearScript.addEventListener("click",()=>this.editor.scriptManager.clearScript()),this.elements.instructions.addEventListener("click",()=>this.toggleInstructions()),this.elements.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.elements.connectDeviceBtn.addEventListener("click",()=>this.editor.bluetooth.handleDeviceConnection());let e=document.getElementById("continue-anyway");e&&e.addEventListener("click",()=>{document.querySelector(".mobile-warning").style.display="none"})}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.elements.videoElement.requestFullscreen().catch(t=>{alert(`Error attempting to enable full-screen mode: ${t.message} (${t.name})`)})}toggleInstructions(){let t=this.elements.instructionsContent,e=this.elements.instructionsToggle;t.classList.contains("expanded")?(t.classList.remove("expanded"),e.classList.remove("expanded")):(t.classList.add("expanded"),e.classList.add("expanded"))}updateStatus(t){this.elements.status.textContent=t}showLoadingOverlay(){this.elements.loadingOverlay.style.display="flex"}hideLoadingOverlay(){this.elements.loadingOverlay.style.display="none"}updateLoadingStage(t,e=!1){this.elements.loadingStage.textContent=t,e?(this.elements.progressFill.classList.add("indeterminate"),this.elements.progressFill.style.width="30%",this.elements.progressText.textContent="Processing..."):(this.elements.progressFill.classList.remove("indeterminate"),this.elements.progressFill.style.width="0%",this.elements.progressText.textContent="0%")}updateLoadingProgress(t){this.elements.progressFill.classList.remove("indeterminate"),this.elements.progressFill.style.width=`${t}%`,this.elements.progressText.textContent=`${Math.round(t)}%`}updateConnectionStatus(t,e=""){t?(this.elements.connectDeviceBtn.textContent="Disconnect",this.elements.connectDeviceBtn.style.background="#d13438",this.elements.connectionStatus.textContent=`Connected: ${e}`,this.elements.connectionStatus.style.color="#00ff88"):(this.elements.connectDeviceBtn.textContent="Connect Device",this.elements.connectDeviceBtn.style.background="#0078d4",this.elements.connectionStatus.textContent="Not connected",this.elements.connectionStatus.style.color="#666")}updateEventList(){let t=this.elements.eventList;t.innerHTML="",this.editor.scriptManager.script.forEach((e,i)=>{let s=document.createElement("div");s.className="event-item",this.editor.scriptManager.selectedEventIndices.includes(i)&&s.classList.add("selected"),s.innerHTML=`
                <div class="event-details">
                    ${this.editor.media.formatTime(e.time)} | Intensity: ${e.intensity}
                </div>
                <div class="event-actions">
                    <button class="danger" style="padding: 4px 8px; font-size: 12px;">\xD7</button>
                </div>
            `;let n=s.querySelector(".danger");n.onclick=()=>{this.editor.scriptManager.removeScriptEvent(i)},s.onclick=a=>{a.target.matches("button")||(this.editor.input.handleEventSelection(i,a.ctrlKey||a.metaKey,a.shiftKey),this.editor.scriptManager.selectedEventIndices.length===1&&this.editor.media.seekTo(e.time))},t.appendChild(s)}),this.editor.scriptManager.script.length===0&&(t.innerHTML='<div style="color: #666; text-align: center; padding: 20px;">No events yet<br>Click on waveform to add</div>')}updateScriptData(){this.elements.scriptData.value=JSON.stringify(this.editor.scriptManager.getFunscript(),null,2)}updateTimeline(){let t=this.elements.timeline.querySelector("#scriptEvents");t.innerHTML="",this.editor.media.duration&&this.editor.scriptManager.script.forEach((e,i)=>{let s=document.createElement("div");s.className="script-event",this.editor.scriptManager.selectedEventIndices.includes(i)&&(s.classList.add("selected"),s.classList.add("grabbable")),e.embedded&&s.classList.add("embedded"),this.editor.input.isDragging&&this.editor.scriptManager.selectedEventIndices.includes(i)&&s.classList.add("dragging");let n=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,a=(e.time-this.editor.canvas.viewportStart)/n*100,o=.2;a>=0&&a<=100&&(s.style.left=`${a}%`,s.style.width=`${o}%`,s.title=`Time: ${this.editor.media.formatTime(e.time)}, Intensity: ${e.intensity}`,t.appendChild(s))})}updateVisualization(){this.editor.canvas.drawWaveform(),this.updateTimeline(),this.updatePlayhead()}updatePlayhead(){if(!this.editor.media.duration)return;let t=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,e=(this.editor.media.currentTime-this.editor.canvas.viewportStart)/t*100;e>=0&&e<=100?(this.elements.playhead.style.left=`${e}%`,this.elements.playhead.style.display="block"):this.elements.playhead.style.display="none"}updateGlow(t){let e=this.elements.waveformContainer;for(let i=0;i<=20;i++)e.classList.remove(`intensity-${i}`);t>0&&e.classList.add(`intensity-${t}`)}showHideInterpolationPanel(){let t=document.getElementById("interpolationPanel");this.editor.scriptManager.selectedEventIndices.length===2?t?t.style.display="block":this.createInterpolationPanel():t&&(t.style.display="none")}createInterpolationPanel(){let t=document.createElement("div");t.id="interpolationPanel",t.style.cssText=`
                    position: fixed;
                    top: 200px;
                    right: 30px;
                    background: #2a2a2a;
                    border: 2px solid #0078d4;
                    border-radius: 8px;
                    padding: 15px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    color: #fff;
                    min-width: 250px;
                `,t.innerHTML=`
                    <h4 style="margin: 0 0 10px 0; color: #0078d4;">Interpolation</h4>
                    <div style="margin-bottom: 15px;">
                        <label>Easing Type:</label>
                        <select id="interpolationType" style="width: 100%; padding: 4px; margin-top: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444;">
                            <option value="linear">Linear</option>
                            <option value="easeIn">Ease In</option>
                            <option value="easeOut">Ease Out</option>
                            <option value="easeInOut">Ease In/Out</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="generateInterpolation" style="flex: 1; padding: 8px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">Generate</button>
                        <button id="closeInterpolation" style="padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">\xD7</button>
                    </div>
                `,document.body.appendChild(t),document.getElementById("generateInterpolation").onclick=()=>this.editor.scriptManager.generateInterpolation(),document.getElementById("closeInterpolation").onclick=()=>this.closeInterpolationPanel(),document.getElementById("interpolationType").onchange=()=>{this.updateVisualization()}}closeInterpolationPanel(){let t=document.getElementById("interpolationPanel");t&&(t.style.display="none"),this.editor.scriptManager.selectedEventIndices=[],this.updateVisualization(),this.updateEventList()}updateTimeInfo(t,e){if(this.editor.media.duration>0){let i=t||this.editor.media.currentTime,s=this.editor.media.duration,n=`${this.editor.media.formatTime(i)} / ${this.editor.media.formatTime(s)}`;e!==void 0&&(n+=` | Intensity: ${e}`),this.elements.timeInfo.textContent=n}else this.elements.timeInfo.textContent="00:00:000 / 00:00:000 | Hover for intensity preview"}};var b=class{constructor(t){this.editor=t,this.canvas=this.editor.ui.elements.waveformCanvas,this.ctx=this.canvas.getContext("2d"),this.waveformData=null,this.canvasWidth=0,this.canvasHeight=0,this.canvasTopPadding=20,this.canvasBottomPadding=5,this.viewportStart=0,this.viewportEnd=0,this.zoomLevel=1,window.addEventListener("resize",()=>this.setupCanvas()),this.setupCanvas()}setupCanvas(){let t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1;this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.ctx.scale(e,e),this.canvasWidth=t.width,this.canvasHeight=t.height,this.editor.media&&this.editor.media.audioBuffer?this.editor.ui.updateVisualization():this.drawPlaceholder()}drawPlaceholder(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight);let t=this.canvasWidth/2,e=this.canvasHeight/2;this.ctx.fillStyle="#888",this.ctx.font="18px Arial",this.ctx.textAlign="center",this.ctx.fillText("Load or drag-and-drop a media file here",t,e-10),this.ctx.fillStyle="#666",this.ctx.font="14px Arial",this.ctx.fillText("Video: .mp4, .mkv; Audio: .mp3, .wav, .m4a, and others...",t,e+20),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="#444",this.ctx.font="10px Arial",this.ctx.textAlign="right";let i=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;for(let s=0;s<=20;s+=5){let n=this.canvasTopPadding+(1-s/20)*i;this.ctx.fillText(s.toString(),this.canvasWidth-10,n+3)}this.ctx.restore()}canvasXToTime(t){if(!this.editor.media.duration)return 0;let e=t/this.canvasWidth,i=this.viewportEnd-this.viewportStart;return this.viewportStart+e*i}timeToCanvasX(t){if(!this.editor.media.duration)return 0;let e=this.viewportEnd-this.viewportStart;return(t-this.viewportStart)/e*this.canvasWidth}canvasYToIntensity(t){let e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding;if(t<=this.canvasTopPadding)return 20;if(t>=this.canvasHeight-this.canvasBottomPadding)return 0;let i=(t-this.canvasTopPadding)/e;return Math.round((1-i)*20)}intensityToCanvasY(t){let e=this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding,i=t/20;return this.canvasTopPadding+(1-i)*e}updateViewport(){if(!this.editor.media.duration){this.viewportStart=0,this.viewportEnd=0;return}let t=this.editor.media.duration/this.zoomLevel,e=(this.viewportStart+this.viewportEnd)/2;this.viewportStart=Math.max(0,e-t/2),this.viewportEnd=Math.min(this.editor.media.duration,this.viewportStart+t),this.viewportEnd===this.editor.media.duration&&(this.viewportStart=Math.max(0,this.editor.media.duration-t))}zoomToPoint(t,e){if(!this.editor.media.duration)return;let i=this.zoomLevel;if(this.zoomLevel=Math.max(1,Math.min(100,this.zoomLevel*t)),this.zoomLevel===i)return;let s=this.editor.media.duration/this.zoomLevel;this.viewportStart=Math.max(0,e-s/2),this.viewportEnd=Math.min(this.editor.media.duration,this.viewportStart+s),this.viewportEnd===this.editor.media.duration&&(this.viewportStart=Math.max(0,this.editor.media.duration-s)),this.viewportStart===0&&(this.viewportEnd=Math.min(this.editor.media.duration,s)),this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline();let n=Math.round(this.zoomLevel*100);this.editor.ui.updateStatus(`Zoom: ${n}% | Viewing: ${this.editor.media.formatTime(this.viewportStart)} - ${this.editor.media.formatTime(this.viewportEnd)}`)}zoomFit(){this.editor.media.duration&&(this.zoomLevel=1,this.viewportStart=0,this.viewportEnd=this.editor.media.duration,this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline(),this.editor.ui.updateStatus(`Zoom: 100% | Showing full duration: ${this.editor.media.formatTime(this.editor.media.duration)}`))}panViewportHorizontally(t){if(!this.editor.media.duration)return;let e=this.viewportEnd-this.viewportStart;this.viewportStart=Math.max(0,Math.min(this.editor.media.duration-e,this.viewportStart+t)),this.viewportEnd=this.viewportStart+e,this.generateWaveformData(),this.drawWaveform(),this.editor.ui.updateTimeline();let i=Math.round(this.zoomLevel*100);this.editor.ui.updateStatus(`Zoom: ${i}% | Viewing: ${this.editor.media.formatTime(this.viewportStart)} - ${this.editor.media.formatTime(this.viewportEnd)}`)}generateWaveformData(){let t=this.editor.media.audioBuffer.getChannelData(0),e=t.length,i=this.editor.media.audioBuffer.sampleRate,s=this.viewportEnd-this.viewportStart,n=Math.floor(this.viewportStart*i),a=Math.min(e,Math.floor(this.viewportEnd*i)),o=a-n,r=this.canvas.width/(window.devicePixelRatio||1),d=Math.max(1,Math.floor(o/r));this.waveformData=[];for(let c=0;c<r;c++){let h=n+c*d,l=Math.min(a,h+d),v=0,p=0;if(h<e&&l>h)for(let m=h;m<l;m++){let u=t[m];u<v&&(v=u),u>p&&(p=u)}this.waveformData.push({min:v,max:p})}}async generateWaveformDataChunked(){let t=this.editor.media.audioBuffer.getChannelData(0),e=t.length,i=this.editor.media.audioBuffer.sampleRate,s=this.viewportEnd-this.viewportStart,n=Math.floor(this.viewportStart*i),a=Math.min(e,Math.floor(this.viewportEnd*i)),o=a-n,r=this.canvas.width/(window.devicePixelRatio||1),d=Math.max(1,Math.floor(o/r));this.waveformData=[];let c=500,h=Math.ceil(r/c);for(let l=0;l<h;l++){let v=l*c,p=Math.min(v+c,r);for(let u=v;u<p;u++){let f=n+u*d,y=Math.min(a,f+d),A=0,U=0;if(f<e&&y>f)for(let O=f;O<y;O++){let w=t[O];w<A&&(A=w),w>U&&(U=w)}this.waveformData.push({min:A,max:U})}let m=(l+1)/h*100;this.editor.ui.updateLoadingProgress(m),l<h-1&&await new Promise(u=>requestAnimationFrame(u))}}drawWaveform(){if(this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),!this.waveformData)return;this.drawIntensityZones(),this.ctx.strokeStyle="#4a9eff",this.ctx.lineWidth=1,this.ctx.beginPath();let t=this.canvasHeight/2,e=(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding)*.35;for(let i=0;i<this.waveformData.length;i++){let{min:s,max:n}=this.waveformData[i],a=i,o=t+s*e,r=t+n*e;this.ctx.moveTo(a,o),this.ctx.lineTo(a,r)}this.ctx.stroke(),this.drawScriptEventsOnWaveform()}drawIntensityZones(){let e=(this.canvasHeight-this.canvasTopPadding-this.canvasBottomPadding)/21;this.ctx.save(),this.ctx.globalAlpha=.1;for(let s=0;s<=20;s++){let n=this.intensityToCanvasY(s),a=s/20;s%2===0&&(this.ctx.fillStyle=`rgba(255, 107, 53, ${.1+a*.1})`,this.ctx.fillRect(0,n-e/2,this.canvasWidth,e)),s%5===0&&(this.ctx.fillStyle="#949494",this.ctx.font="10px Arial",this.ctx.textAlign="right",this.ctx.globalAlpha=.8,this.ctx.fillText(s.toString(),this.canvasWidth-5,n+3),this.ctx.globalAlpha=.1)}this.ctx.restore();let i=this.intensityToCanvasY(10);this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(this.canvasWidth,i),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.save(),this.ctx.globalAlpha=.05,this.ctx.fillStyle="#666",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasTopPadding),this.ctx.fillRect(0,this.canvasHeight-this.canvasBottomPadding,this.canvasWidth,this.canvasBottomPadding),this.ctx.restore()}drawScriptEventsOnWaveform(){this.editor.media.duration&&(this.editor.scriptManager.script.forEach((t,e)=>{let i=this.timeToCanvasX(t.time),s=this.intensityToCanvasY(t.intensity),n=this.editor.scriptManager.selectedEventIndices.includes(e),a=this.editor.input.isDragging&&n;this.ctx.strokeStyle=n?"#00ff88":t.embedded?"#6b46c1":"#ff6b35",this.ctx.lineWidth=n?4:3,this.ctx.beginPath(),this.ctx.moveTo(i,this.canvasHeight),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.fillStyle=n?"#00ff88":t.embedded?"#6b46c1":"#ff6b35",this.ctx.beginPath(),this.ctx.arc(i,s,n?6:4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=n?"#00ff88":"#fff",this.ctx.font=n?"bold 12px Arial":"12px Arial",this.ctx.textAlign="center",this.ctx.fillText(t.intensity.toString(),i,s-(n?12:10)),n&&!a&&(this.ctx.strokeStyle="#00ff88",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(i,s,10,0,Math.PI*2),this.ctx.stroke()),a&&(this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=3,this.ctx.setLineDash([4,4]),this.ctx.beginPath(),this.ctx.arc(i,s,12,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]))}),this.editor.input.isDragging||this.drawInterpolationPreview())}drawInterpolationPreview(){if(this.editor.scriptManager.selectedEventIndices.length!==2)return;let[t,e]=this.editor.scriptManager.selectedEventIndices,i=this.editor.scriptManager.script[t],s=this.editor.scriptManager.script[e],n=this.timeToCanvasX(i.time),a=this.intensityToCanvasY(i.intensity),o=this.timeToCanvasX(s.time),r=this.intensityToCanvasY(s.intensity),d=document.getElementById("interpolationType"),c=d?d.value:"linear";this.ctx.strokeStyle="rgba(0, 255, 136, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([8,4]),this.ctx.beginPath();let h=50,l=n,v=a;for(let p=0;p<=h;p++){let m=p/h,u=this.editor.scriptManager.applyEasing(m,c),f=n+(o-n)*m,y=a+(r-a)*u;p===0?this.ctx.moveTo(f,y):this.ctx.lineTo(f,y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(0, 255, 136, 0.6)";for(let p=5;p<=h-5;p+=5){let m=p/h,u=this.editor.scriptManager.applyEasing(m,c),f=n+(o-n)*m,y=a+(r-a)*u;this.ctx.beginPath(),this.ctx.arc(f,y,2,0,Math.PI*2),this.ctx.fill()}if(d){let p=(n+o)/2,m=this.editor.scriptManager.applyEasing(.5,c),u=a+(r-a)*m;this.ctx.fillStyle="rgba(0, 255, 136, 0.9)",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText(c.replace(/([A-Z])/g," $1"),p,u-15)}}};var x=class g{constructor(){if(this.constructor===g)throw new Error("Abstract classes can't be instantiated.")}execute(){throw new Error("Method 'execute()' must be implemented.")}undo(){throw new Error("Method 'undo()' must be implemented.")}},T=class extends x{constructor(t,e){super(),this.scriptManager=t,this.event=e,this.index=-1}execute(){this.scriptManager.script.push(this.event),this.scriptManager.script.sort((t,e)=>t.time-e.time),this.index=this.scriptManager.script.indexOf(this.event)}undo(){this.scriptManager.script.splice(this.index,1)}},M=class extends x{constructor(t,e){super(),this.scriptManager=t,this.events=e}execute(){this.events.forEach(t=>{let e=this.scriptManager.script.indexOf(t);e!==-1&&this.scriptManager.script.splice(e,1)})}undo(){this.events.forEach(t=>{this.scriptManager.script.push(t)}),this.scriptManager.script.sort((t,e)=>t.time-e.time)}},I=class extends x{constructor(t,e,i,s){super(),this.scriptManager=t,this.events=e,this.timeDelta=i,this.intensityDelta=s}execute(){this.scriptManager.script.sort((t,e)=>t.time-e.time)}undo(){this.events.forEach(t=>{t.time-=this.timeDelta,t.intensity-=this.intensityDelta}),this.scriptManager.script.sort((t,e)=>t.time-e.time)}},P=class extends x{constructor(t,e,i,s){super(),this.scriptManager=t,this.startIndex=e,this.endIndex=i,this.newEvents=s,this.oldEvents=t.script.slice(e,i+1)}execute(){this.scriptManager.script.splice(this.startIndex,this.oldEvents.length,...this.newEvents),this.scriptManager.script.sort((t,e)=>t.time-e.time)}undo(){this.scriptManager.script.splice(this.startIndex,this.newEvents.length,...this.oldEvents),this.scriptManager.script.sort((t,e)=>t.time-e.time)}};var D=class{constructor(t){this.editor=t,this.isDragging=!1,this.isSeeking=!1,this.isSelecting=!1,this.potentialSelection=!1,this.potentialDrag=!1,this.dragType=null,this.dragStartPos={x:0,y:0},this.dragEventStartPositions=[],this.dragThreshold=5,this.dragPreviewElement=null,this.hoverTime=null,this.isHoveringWaveform=!1,this.isHoveringTimeline=!1,this.selectionAnchor=null,this.initializeEventListeners()}initializeEventListeners(){this.editor.ui.elements.waveformCanvas.addEventListener("mousedown",t=>this.handleCanvasMouseDown(t)),document.addEventListener("mousemove",t=>this.handleDocumentMouseMove(t)),document.addEventListener("mouseup",t=>this.handleDocumentMouseUp(t)),this.editor.ui.elements.waveformCanvas.addEventListener("mouseleave",t=>this.handleCanvasMouseLeave(t)),this.editor.ui.elements.waveformCanvas.addEventListener("wheel",t=>{if(!this.editor.media||!this.editor.media.duration)return;t.preventDefault();let e=this.editor.ui.elements.waveformCanvas.getBoundingClientRect(),i=t.clientX-e.left,s=this.editor.canvas.canvasXToTime(i),n=.05,a=1.05,o=t.shiftKey?t.deltaY:t.deltaX;if(o!==0){let r=(o>0?1:-1)*(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart)*n;this.editor.canvas.panViewportHorizontally(r)}if(t.deltaY!==0&&!t.shiftKey){let r=t.deltaY>0?a:1/a;this.editor.canvas.zoomToPoint(r,s)}},{passive:!1}),this.editor.ui.elements.timeline.addEventListener("mousedown",t=>this.handleTimelineMouseDown(t)),this.editor.ui.elements.timeline.addEventListener("mousemove",t=>this.handleTimelineMouseMove(t)),this.editor.ui.elements.timeline.addEventListener("mouseup",t=>this.handleTimelineMouseUp(t)),this.editor.ui.elements.timeline.addEventListener("mouseenter",t=>this.handleTimelineMouseEnter(t)),this.editor.ui.elements.timeline.addEventListener("mouseleave",t=>this.handleTimelineMouseLeave(t)),this.setupDragAndDrop(),document.addEventListener("keydown",t=>this.handleKeyDown(t))}setupDragAndDrop(){this.editor.ui.elements.waveformCanvas.addEventListener("dragover",t=>this.handleDragOver(t),!1),this.editor.ui.elements.waveformCanvas.addEventListener("dragenter",t=>this.handleDragOver(t),!1),this.editor.ui.elements.waveformCanvas.addEventListener("dragleave",t=>this.handleDragLeave(t),!1),this.editor.ui.elements.waveformCanvas.addEventListener("drop",t=>this.handleDrop(t),!1),document.addEventListener("dragover",t=>t.preventDefault(),!1),document.addEventListener("drop",t=>t.preventDefault(),!1)}handleDragOver(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.waveformCanvas.classList.add("drag-over")}handleDragLeave(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.waveformCanvas.classList.remove("drag-over")}handleDrop(t){t.preventDefault(),t.stopPropagation(),this.editor.ui.elements.waveformCanvas.classList.remove("drag-over");let e=t.dataTransfer.files;if(e.length>0){let i=e[0];if(!i.type.startsWith("audio/")&&!i.type.startsWith("video/")&&!i.name.toLowerCase().endsWith(".mkv")){this.editor.ui.updateStatus(`Error: "${i.name}" is not a supported audio or video file`);return}this.editor.loadFile(i)}}getCanvasMousePos(t){let e=this.editor.ui.elements.waveformCanvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}getTimelineMousePos(t){let e=this.editor.ui.elements.timeline.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}handleCanvasMouseDown(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getCanvasMousePos(t),i=this.findEventAtPosition(e.x,e.y);i!==-1?(this.editor.scriptManager.selectedEventIndices.includes(i)?(this.potentialDrag=!0,this.dragStartPos={...e}):(this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey),this.dragStartPos={...e}),t.preventDefault()):(this.potentialSelection=!0,this.dragStartPos=e)}handleDocumentMouseMove(t){let e=this.editor.ui.elements.waveformCanvas.getBoundingClientRect();if(!(t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&t.clientY<=e.bottom)&&!this.isDragging&&!this.isSelecting)return;let s=this.getCanvasMousePos(t);if(this.potentialSelection&&Math.sqrt(Math.pow(s.x-this.dragStartPos.x,2)+Math.pow(s.y-this.dragStartPos.y,2))>this.dragThreshold&&(this.isSelecting=!0,this.potentialSelection=!1,this.editor.ui.elements.selectionBox.style.display="block",!t.ctrlKey&&!t.metaKey&&!t.shiftKey&&(this.editor.scriptManager.selectedEventIndices=[])),this.isSelecting){this.updateSelectionFromBox(s);return}if(!this.isDragging&&(this.potentialDrag||this.dragStartPos)&&this.editor.scriptManager.selectedEventIndices.length>0&&Math.sqrt(Math.pow(s.x-this.dragStartPos.x,2)+Math.pow(s.y-this.dragStartPos.y,2))>this.dragThreshold&&(this.potentialDrag=!1,this.startDrag("canvas",this.dragStartPos)),this.isDragging){this.processDrag(s);return}if(!this.editor.media||!this.editor.media.duration){this.editor.ui.elements.waveformCanvas.style.cursor="default";return}let n=this.findEventAtPosition(s.x,s.y);n!==-1&&this.editor.scriptManager.selectedEventIndices.includes(n)?this.editor.ui.elements.waveformCanvas.style.cursor="grab":this.editor.ui.elements.waveformCanvas.style.cursor="crosshair",this.hoverTime=this.editor.canvas.canvasXToTime(s.x),this.isHoveringWaveform=!0;let a=this.editor.canvas.canvasXToTime(s.x),o=this.editor.canvas.canvasYToIntensity(s.y);this.editor.ui.updateTimeInfo(a,o)}handleDocumentMouseUp(t){if(this.potentialDrag){this.potentialDrag=!1,this.dragStartPos=null;return}if(this.potentialSelection){if(this.potentialSelection=!1,this.editor.scriptManager.selectedEventIndices.length>0&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey)this.editor.scriptManager.selectedEventIndices=[],this.editor.ui.updateStatus("Selection cleared.");else{let e=this.getCanvasMousePos(t),i=this.editor.canvas.canvasXToTime(e.x),s=this.editor.canvas.canvasYToIntensity(e.y);this.editor.scriptManager.addScriptEvent(i,s),this.editor.ui.updateStatus(`Added event at ${this.editor.media.formatTime(i)} with intensity ${s}`)}this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()}this.isSelecting&&(this.isSelecting=!1,this.editor.ui.elements.selectionBox.style.display="none",this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()),this.isDragging&&this.endDrag(),this.dragStartPos=null}handleCanvasMouseLeave(t){this.isHoveringWaveform=!1,this.isHoveringTimeline||(this.hoverTime=null)}handleTimelineMouseDown(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.findTimelineEventAtPosition(e.x);i!==-1?(this.editor.scriptManager.selectedEventIndices.includes(i)?this.dragStartPos={x:e.x,y:0}:(this.handleEventSelection(i,t.ctrlKey||t.metaKey,t.shiftKey),this.dragStartPos={x:e.x,y:0}),t.preventDefault(),t.stopPropagation()):(this.isSeeking=!0,this.dragStartPos={x:e.x,y:0},this.handleTimelineClick(t))}handleTimelineMouseMove(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.editor.ui.elements.timeline.getBoundingClientRect().width,s=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,n=e.x/i;if(this.hoverTime=this.editor.canvas.viewportStart+n*s,this.isHoveringTimeline=!0,this.isSeeking){this.handleTimelineClick(t);return}!this.isDragging&&this.dragStartPos&&this.editor.scriptManager.selectedEventIndices.length>0&&Math.abs(e.x-this.dragStartPos.x)>this.dragThreshold&&this.startDrag("timeline",this.dragStartPos),this.isDragging&&this.dragType==="timeline"&&this.processDrag({x:e.x,y:0})}handleTimelineMouseUp(t){this.isSeeking=!1,this.dragStartPos=null,this.isDragging&&this.dragType==="timeline"&&this.endDrag()}handleTimelineMouseEnter(t){this.isHoveringTimeline=!0}handleTimelineMouseLeave(t){this.isSeeking=!1,this.isHoveringTimeline=!1,this.isHoveringWaveform||(this.hoverTime=null)}handleCanvasClick(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getCanvasMousePos(t),i=this.editor.canvas.canvasXToTime(e.x),s=this.editor.canvas.canvasYToIntensity(e.y),n=this.findEventAtPosition(e.x,e.y);if(n!==-1){this.handleEventSelection(n,t.ctrlKey||t.metaKey,t.shiftKey),this.editor.ui.updateStatus(`Selected event: ${this.editor.media.formatTime(i)}, intensity ${this.editor.scriptManager.script[n].intensity}`);return}if(this.editor.scriptManager.selectedEventIndices.length>0){this.editor.scriptManager.selectedEventIndices=[],this.editor.ui.updateVisualization(),this.editor.ui.showHideInterpolationPanel(),this.editor.ui.updateStatus("Selection cleared - click again to add new event");return}this.editor.scriptManager.addScriptEvent(i,s),this.editor.ui.updateStatus(`Added event at ${this.editor.media.formatTime(i)} with intensity ${s}`)}handleTimelineClick(t){if(!this.editor.media||!this.editor.media.duration)return;let e=this.getTimelineMousePos(t),i=this.editor.ui.elements.timeline.getBoundingClientRect().width,s=e.x/i,n=this.editor.canvas.viewportStart+s*(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart);this.editor.media.seekTo(n)}handleEventSelection(t,e,i){if(this.editor.scriptManager.clearPasteState(),i&&this.selectionAnchor!==null){let s=Math.min(this.selectionAnchor,t),n=Math.max(this.selectionAnchor,t);this.editor.scriptManager.selectedEventIndices=[];for(let a=s;a<=n;a++)this.editor.scriptManager.selectedEventIndices.push(a)}else if(e){let s=this.editor.scriptManager.selectedEventIndices.indexOf(t);s!==-1?this.editor.scriptManager.selectedEventIndices.splice(s,1):this.editor.scriptManager.selectedEventIndices.push(t)}else this.editor.scriptManager.selectedEventIndices=[t],this.selectionAnchor=t;this.editor.scriptManager.selectedEventIndices.sort((s,n)=>s-n),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.ui.showHideInterpolationPanel()}findEventAtPosition(t,e){for(let s=0;s<this.editor.scriptManager.script.length;s++){let n=this.editor.scriptManager.script[s],a=this.editor.canvas.timeToCanvasX(n.time),o=this.editor.canvas.intensityToCanvasY(n.intensity);if(Math.sqrt(Math.pow(t-a,2)+Math.pow(e-o,2))<=10)return s}return-1}findTimelineEventAtPosition(t){let e=this.editor.ui.elements.timeline.getBoundingClientRect().width,i=10;for(let s=0;s<this.editor.scriptManager.script.length;s++){let n=this.editor.scriptManager.script[s],a=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,o=(n.time-this.editor.canvas.viewportStart)/a*e;if(Math.abs(t-o)<=i)return s}return-1}startDrag(t,e){return this.editor.scriptManager.selectedEventIndices.length===0?!1:(this.isDragging=!0,this.dragType=t,this.dragStartPos={...e},this.dragEventStartPositions=this.editor.scriptManager.selectedEventIndices.map(i=>({eventObject:this.editor.scriptManager.script[i],originalTime:this.editor.scriptManager.script[i].time,originalIntensity:this.editor.scriptManager.script[i].intensity})),t==="canvas"?this.editor.ui.elements.waveformCanvas.classList.add("dragging"):t==="timeline"&&this.editor.ui.elements.timeline.classList.add("dragging"),!0)}processDrag(t){if(!this.isDragging||this.dragEventStartPositions.length===0)return;let e=t.x-this.dragStartPos.x,i=t.y-this.dragStartPos.y;this.dragType==="canvas"?this.processDragIntensity(i):this.dragType==="timeline"&&this.processDragTime(e),this.editor.ui.updateVisualization()}processDragIntensity(t){let i=20/this.editor.canvas.canvasHeight,s=Math.round(-t*i),n=1/0,a=-1/0;this.dragEventStartPositions.forEach(r=>{n=Math.min(n,r.originalIntensity),a=Math.max(a,r.originalIntensity)});let o=Math.max(-n,Math.min(s,20-a));this.dragEventStartPositions.forEach(r=>{let d=Math.max(0,Math.min(20,r.originalIntensity+o));r.eventObject.intensity=d,r.eventObject.embedded&&d!==r.originalIntensity&&delete r.eventObject.embedded})}processDragTime(t){let i=(this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart)/this.editor.canvas.canvasWidth,s=t*i,n=1/0,a=-1/0;this.dragEventStartPositions.forEach(r=>{n=Math.min(n,r.originalTime),a=Math.max(a,r.originalTime)});let o=Math.max(-n,Math.min(s,this.editor.media.duration-a));this.dragEventStartPositions.forEach(r=>{let d=Math.max(0,Math.min(this.editor.media.duration,r.originalTime+o));r.eventObject.time=parseFloat(d.toFixed(3)),r.eventObject.embedded&&d!==r.originalTime&&delete r.eventObject.embedded}),this.editor.scriptManager.script.sort((r,d)=>r.time-d.time),this.updateSelectedIndicesAfterSort()}updateSelectedIndicesAfterSort(){this.editor.scriptManager.selectedEventIndices=this.dragEventStartPositions.map(t=>this.editor.scriptManager.script.indexOf(t.eventObject)).filter(t=>t!==-1),this.editor.scriptManager.selectedEventIndices.sort((t,e)=>t-e)}endDrag(){if(!this.isDragging)return;let t=this.dragEventStartPositions[0].eventObject.time-this.dragEventStartPositions[0].originalTime,e=this.dragEventStartPositions[0].eventObject.intensity-this.dragEventStartPositions[0].originalIntensity,i=new I(this.editor.scriptManager,this.dragEventStartPositions.map(n=>n.eventObject),t,e);this.editor.history.execute(i),this.isDragging=!1,this.dragType=null,this.dragEventStartPositions=[],this.editor.ui.elements.waveformCanvas.classList.remove("dragging"),this.editor.ui.elements.timeline.classList.remove("dragging"),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData();let s=this.editor.scriptManager.selectedEventIndices.length;this.editor.ui.updateStatus(`Moved ${s} event${s>1?"s":""}`)}updateSelectionFromBox(t){let e=this.editor.ui.elements.waveformCanvas,i=this.editor.ui.elements.selectionBox,s=this.dragStartPos.x,n=this.dragStartPos.y,a=Math.max(0,Math.min(e.clientWidth,t.x)),o=Math.max(0,Math.min(e.clientHeight,t.y)),r=Math.min(s,a),d=Math.min(n,o),c=Math.abs(s-a),h=Math.abs(n-o);i.style.left=`${r+e.offsetLeft}px`,i.style.top=`${d+e.offsetTop}px`,i.style.width=`${c}px`,i.style.height=`${h}px`;let l=[];this.editor.scriptManager.script.forEach((m,u)=>{let f=this.editor.canvas.timeToCanvasX(m.time),y=this.editor.canvas.intensityToCanvasY(m.intensity);f>=r&&f<=r+c&&y>=d&&y<=d+h&&l.push(u)});let v=new Set(this.editor.scriptManager.selectedEventIndices),p=new Set(l);(v.size!==p.size||![...v].every(m=>p.has(m)))&&(this.editor.scriptManager.selectedEventIndices=l,this.editor.ui.updateVisualization())}handleKeyDown(t){if(t.target.tagName!=="TEXTAREA")switch(t.key){case" ":t.preventDefault(),this.editor.media.togglePlayPause();break;case"Delete":case"Backspace":this.editor.scriptManager.removeSelectedEvents();break;case"c":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.copySelectedEvents();break;case"x":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.cutSelectedEvents();break;case"v":(t.ctrlKey||t.metaKey)&&this.editor.scriptManager.pasteEvents();break;case"z":(t.ctrlKey||t.metaKey)&&(t.shiftKey?this.editor.history.redo():this.editor.history.undo());break;case"y":(t.ctrlKey||t.metaKey)&&this.editor.history.redo();break}}};var S=class{constructor(t){this.editor=t,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.originalFileName="",this.audioContext=null,this.audioBuffer=null}async initializeAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),await this.audioContext.resume())}async loadFile(t){try{this.editor.ui.showLoadingOverlay(),this.editor.scriptManager.clipboard=[],this.editor.scriptManager.clearPasteState(),this.editor.ui.updateLoadingStage("Loading file...",!1),this.editor.ui.updateLoadingProgress(0),await this.initializeAudioContext(),this.originalFileName=t.name,await this._loadSpecifics(t);let e=await t.arrayBuffer();this.editor.ui.updateLoadingStage("Decoding audio...",!0),this.audioBuffer=await this.audioContext.decodeAudioData(e.slice(0)),this.duration=this.audioBuffer.duration,this.editor.canvas.updateViewport(),this.editor.ui.updateLoadingStage("Generating waveform...",!1),await this.editor.canvas.generateWaveformDataChunked(),this.editor.ui.updateLoadingStage("Complete!",!1),this.editor.ui.updateLoadingProgress(100),await new Promise(i=>setTimeout(i,300)),this.editor.ui.hideLoadingOverlay(),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.ui.updateStatus(`Loaded: ${t.name} (${this.formatTime(this.duration)})`),document.querySelector(".waveform-header h3").textContent=t.name,this.editor.ui.elements.playPauseBtn.disabled=!1,this.editor.ui.elements.zoomInBtn.disabled=!1,this.editor.ui.elements.zoomOutBtn.disabled=!1,this.editor.ui.elements.zoomFitBtn.disabled=!1,this.editor.ui.updateEventList(),this.editor.ui.updateScriptData()}catch(e){this.editor.ui.hideLoadingOverlay(),this.editor.ui.updateStatus(`Error loading file: ${e.message}`),console.error("Error in loadFile:",e)}}async _loadSpecifics(t){throw new Error("Method '_loadSpecifics()' must be implemented.")}play(){this.isPlaying||(this.isPlaying=!0,this.editor.ui.elements.playPauseBtn.textContent="Pause",this.editor.ui.elements.stopBtn.disabled=!1,this.editor.ui.updateStatus("Playing"),this._specificPlay(),this.playbackLoop())}_specificPlay(){throw new Error("Method '_specificPlay()' must be implemented.")}pause(){this.isPlaying&&(this.isPlaying=!1,this.editor.ui.elements.playPauseBtn.textContent="Play",this.editor.ui.updateStatus("Paused"),this._specificPause())}_specificPause(){throw new Error("Method '_specificPause()' must be implemented.")}stop(){this.isPlaying&&this._specificStop(),this.isPlaying=!1,this.currentTime=0,this.editor.ui.elements.playPauseBtn.textContent="Play",this.editor.ui.elements.stopBtn.disabled=!0,this.editor.ui.updateStatus("Stopped"),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.bluetooth.sendVibration(0),this.editor.scriptManager.resetPlaybackTracking()}_specificStop(){throw new Error("Method '_specificStop()' must be implemented.")}seekTo(t){this.currentTime=t,this._specificSeek(t),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo(),this.editor.scriptManager.resetPlaybackTracking()}_specificSeek(t){throw new Error("Method '_specificSeek()' must be implemented.")}togglePlayPause(){this.isPlaying?this.pause():this.play()}playbackLoop(){if(!this.isPlaying)return;if(this.updateCurrentTime(),this.isFinished()){this.handleFinished();return}this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo();let t=this.editor.scriptManager.getIntensityAtTime(this.currentTime);t!==this.editor.bluetooth.activeIntensity&&(this.editor.bluetooth.sendVibration(t),this.editor.ui.updateGlow(t)),requestAnimationFrame(()=>this.playbackLoop())}updateCurrentTime(){throw new Error("Method 'updateCurrentTime()' must be implemented.")}isFinished(){throw new Error("Method 'isFinished()' must be implemented.")}handleFinished(){this.pause(),this.currentTime=0,this.editor.ui.updateStatus("Finished"),this.editor.ui.updateVisualization(),this.editor.ui.updateTimeInfo()}formatTime(t){let e=Math.floor(t/60),i=Math.floor(t%60),s=Math.round((t-Math.floor(t))*1e3);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${s.toString().padStart(3,"0")}`}async downloadSyncedAudio(){if(!this.originalFileBuffer||!this.isMP3File){this.editor.ui.updateStatus("Cannot download: No MP3 file loaded.");return}if(!(this.editor.scriptManager.script.length===0&&!confirm("The script is empty. Do you still want to download the audio without any vibration events?"))){this.editor.ui.updateStatus("Embedding script and preparing download...");try{let t=this.editor.scriptManager.getFunscript(),e=await this.editor.id3Handler.embedScript(this.originalFileBuffer,t);if(e){let i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=this.originalFileName.replace(/(\.mp3)$/i,"_synced$1"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),this.editor.ui.updateStatus("Synced audio downloaded successfully.")}else throw new Error("Failed to embed the script.")}catch(t){this.editor.ui.updateStatus(`Error during download: ${t.message}`),console.error("Download error:",t)}}}};var C=class extends S{constructor(t){super(t),this.source=null,this.pauseTime=0,this.startTime=0,this.originalFileBuffer=null,this.isMP3File=!1}async _loadSpecifics(t){this.isMP3File=t.name.toLowerCase().endsWith(".mp3")||t.type==="audio/mpeg",this.editor.ui.updateLoadingStage("Reading file data...",!1),this.editor.ui.updateLoadingProgress(10);let e=await t.arrayBuffer();this.isMP3File&&(this.originalFileBuffer=e.slice(0)),this.editor.ui.elements.waveformContainer.classList.remove("video-active"),setTimeout(()=>this.editor.canvas.setupCanvas(),222),this.editor.ui.elements.videoElement.style.display="none",this.editor.ui.elements.fullscreenBtn.style.display="none",this.editor.ui.elements.videoElement.src&&URL.revokeObjectURL(this.editor.ui.elements.videoElement.src),this.editor.ui.elements.videoElement.src="";let i=null;if(this.isMP3File){this.editor.ui.updateLoadingStage("Checking for embedded script...",!1),this.editor.ui.updateLoadingProgress(15);let s=await this.editor.id3Handler.extractScript(e);s&&s.script&&(i=s.script)}if(i&&this.editor.scriptManager.script.length>0){this.editor.ui.hideLoadingOverlay();let s=confirm(`This MP3 contains ${i.length} embedded script events.
You currently have ${this.editor.scriptManager.script.length} events in the editor.

Would you like to keep the current script events?

OK = Merge both scripts
Cancel = Replace with embedded script only`);this.editor.ui.showLoadingOverlay(),s?(this.editor.scriptManager.script.forEach(n=>{n.embedded||(n.embedded=!1)}),i.forEach(n=>{this.editor.scriptManager.script.push({time:n.time,intensity:n.intensity,embedded:!0})}),this.editor.scriptManager.script.sort((n,a)=>n.time-a.time),this.editor.ui.updateStatus(`Merged ${i.length} embedded events with existing script`)):(this.editor.scriptManager.script=i.map(n=>({time:n.time,intensity:n.intensity,embedded:!0})),this.editor.ui.updateStatus(`Loaded ${i.length} embedded events`))}else i&&this.editor.scriptManager.script.length===0&&(this.editor.scriptManager.script=i.map(s=>({time:s.time,intensity:s.intensity,embedded:!0})),this.editor.ui.updateStatus(`Loaded ${t.name} with ${i.length} embedded events`));this.isMP3File&&(this.editor.ui.elements.downloadSyncedBtn.disabled=!1)}_specificPlay(){if(this.audioBuffer)try{this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.audioContext.destination),this.startTime=this.audioContext.currentTime,this.source.start(0,this.pauseTime%this.duration)}catch(t){this.editor.ui.updateStatus(`Playback error: ${t.message}`)}}_specificPause(){this.source.stop(),this.pauseTime+=this.audioContext.currentTime-this.startTime}_specificStop(){this.source.stop(),this.pauseTime=0}_specificSeek(t){this.isPlaying?(this.pause(),this.pauseTime=t,this.play()):this.pauseTime=t}updateCurrentTime(){this.isPlaying?this.currentTime=this.pauseTime+(this.audioContext.currentTime-this.startTime):this.currentTime=this.pauseTime}isFinished(){return this.currentTime>=this.duration}};var L=class extends S{constructor(t){super(t),this.videoUrl=null}async _loadSpecifics(t){this.editor.ui.elements.waveformContainer.classList.add("video-active"),setTimeout(()=>this.editor.canvas.setupCanvas(),222),this.editor.ui.elements.videoElement.style.display="block",this.editor.ui.elements.fullscreenBtn.style.display="block",this.videoUrl=URL.createObjectURL(t),this.editor.ui.elements.videoElement.src=this.videoUrl}_specificPlay(){this.editor.ui.elements.videoElement.play()}_specificPause(){this.editor.ui.elements.videoElement.pause()}_specificStop(){this.editor.ui.elements.videoElement.pause(),this.editor.ui.elements.videoElement.currentTime=0}_specificSeek(t){this.editor.ui.elements.videoElement.currentTime=t}updateCurrentTime(){this.currentTime=this.editor.ui.elements.videoElement.currentTime}isFinished(){return this.editor.ui.elements.videoElement.ended}};var B=class{constructor(t){this.editor=t,this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.activeIntensity=0}async handleDeviceConnection(){let t=this.editor.ui.elements.connectDeviceBtn;if(this.device&&this.device.gatt.connected)try{this.device.gatt.disconnect(),this.editor.ui.updateStatus("Device disconnected")}catch(e){this.editor.ui.updateStatus(`Disconnect error: ${e.message}`)}else{t.disabled=!0,t.textContent="Connecting...",this.editor.ui.updateStatus("Connecting to device...");try{await this.connectToDevice()?(this.editor.ui.updateConnectionStatus(!0,this.device.name||"Unknown Device"),this.editor.ui.updateStatus(`Connected to ${this.device.name||"Lovense device"}`)):(this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus("Failed to connect to device"))}catch(e){this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus(`Connection error: ${e.message}`)}t.disabled=!1}}generateLovenseServices(){return["0000fff0-0000-1000-8000-00805f9b34fb","6e400001-b5a3-f393-e0a9-e50e24dcca9e","50300001-0024-4bd4-bbd5-a6920e4c5653","57300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0024-4bd4-bbd5-a6920e4c5653","50300001-0023-4bd4-bbd5-a6920e4c5653","53300001-0023-4bd4-bbd5-a6920e4c5653","5a300001-0023-4bd4-bbd5-a6920e4c5653","4f300001-0023-4bd4-bbd5-a6920e4c5653","42300001-0023-4bd4-bbd5-a6920e4c5653","43300001-0023-4bd4-bbd5-a6920e4c5653","4c300001-0023-4bd4-bbd5-a6920e4c5653","4c410001-0023-4bd4-bbd5-a6920e4c5653","56300001-0023-4bd4-bbd5-a6920e4c5653","58300001-0023-4bd4-bbd5-a6920e4c5653","52300001-0023-4bd4-bbd5-a6920e4c5653","46300001-0023-4bd4-bbd5-a6920e4c5653","50300011-0023-4bd4-bbd5-a6920e4c5653","4a300001-0023-4bd4-bbd5-a6920e4c5653","45440001-0023-4bd4-bbd5-a6920e4c5653","45420001-0023-4bd4-bbd5-a6920e4c5653","54300001-0023-4bd4-bbd5-a6920e4c5653","45490001-0023-4bd4-bbd5-a6920e4c5653","4e300001-0023-4bd4-bbd5-a6920e4c5653","45410001-0023-4bd4-bbd5-a6920e4c5653","51300001-0023-4bd4-bbd5-a6920e4c5653","45460001-0023-4bd4-bbd5-a6920e4c5653","454c0001-0023-4bd4-bbd5-a6920e4c5653","55300001-0023-4bd4-bbd5-a6920e4c5653","53440001-0023-4bd4-bbd5-a6920e4c5653","48300001-0023-4bd4-bbd5-a6920e4c5653","46530001-0023-4bd4-bbd5-a6920e4c5653","43410001-0023-4bd4-bbd5-a6920e4c5653","4f430001-0023-4bd4-bbd5-a6920e4c5653","455a0001-0023-4bd4-bbd5-a6920e4c5653"]}async connectToDevice(){try{let t=this.generateLovenseServices();return this.device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"lvs"},{namePrefix:"LVS"},{namePrefix:"lovense"},{namePrefix:"Lovense"},{namePrefix:"LOVENSE"}],optionalServices:t}),this.gattServer=await this.device.gatt.connect(),this.device.addEventListener("gattserverdisconnected",this.onDisconnected.bind(this)),await this.setupCommandChannel(),!0}catch(t){return console.error(`Connection error: ${t.message}`),!1}}async setupCommandChannel(){let t=this.generateLovenseServices();for(let e of t)try{let s=await(await this.gattServer.getPrimaryService(e)).getCharacteristics();for(let n of s)if(n.properties.write||n.properties.writeWithoutResponse){this.commandCharacteristic=n,console.log(`Command characteristic found in service: ${e}`);return}}catch{}console.warn("No command characteristic found in any service")}async sendCommand(t){if(!this.device||!this.device.gatt.connected||!this.commandCharacteristic)return console.warn("Device not connected or characteristic not available"),!1;try{let i=new TextEncoder().encode(t);return await this.commandCharacteristic.writeValue(i),console.log(`\u{1F4E1} BT Command sent: ${t}`),!0}catch(e){return console.error(`Failed to send command "${t}":`,e),this.editor.ui.updateStatus(`Bluetooth command failed: ${e.message}`),!1}}onDisconnected(){console.log("Device disconnected"),this.device=null,this.gattServer=null,this.commandCharacteristic=null,this.editor.ui.updateConnectionStatus(!1),this.editor.ui.updateStatus("Device disconnected")}sendVibration(t){t!==this.activeIntensity&&(this.sendCommand(`Vibrate:${t};`),this.activeIntensity=t)}};var k=class{constructor(t){this.editor=t,this.script=[],this.selectedEventIndices=[],this.clipboard=[],this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.lastIndex=0}resetPlaybackTracking(){this.lastIndex=0}addScriptEvent(t,e){let i={time:parseFloat(t.toFixed(3)),intensity:e},s=new T(this,i);this.editor.history.execute(s),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.updateStatus(`Added event at ${this.editor.media.formatTime(t)} with intensity ${e}`)}removeScriptEvent(t){t>=0&&t<this.script.length&&(this.script.splice(t,1),this.selectedEventIndices=this.selectedEventIndices.map(e=>e>t?e-1:e).filter(e=>e!==t),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.showHideInterpolationPanel(),this.editor.ui.updateStatus("Event removed"))}removeSelectedEvents(){if(this.selectedEventIndices.length===0||this.selectedEventIndices.length>3&&!confirm(`Are you sure you want to delete ${this.selectedEventIndices.length} events?`))return;let t=this.selectedEventIndices.map(s=>this.script[s]),e=new M(this,t);this.editor.history.execute(e),this.selectedEventIndices=[],this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.showHideInterpolationPanel();let i=t.length;this.editor.ui.updateStatus(`Removed ${i} event${i>1?"s":""}`)}copySelectedEvents(){if(this.selectedEventIndices.length===0){this.editor.ui.updateStatus("No events selected to copy");return}let t=this.selectedEventIndices.map(i=>this.script[i]).sort((i,s)=>i.time-s.time),e=t[0].time;this.clipboard=t.map(i=>({time:i.time-e,intensity:i.intensity})),this.lastPasteEndTime=null,this.pasteCount=0,this.clipboardFromCut=!1,this.editor.ui.updateStatus(`Copied ${this.clipboard.length} event${this.clipboard.length>1?"s":""}`)}cutSelectedEvents(){if(this.selectedEventIndices.length===0){this.editor.ui.updateStatus("No events selected to cut");return}this.copySelectedEvents();let t=this.selectedEventIndices.length;this.removeSelectedEvents(),this.clipboardFromCut=!0,this.editor.ui.updateStatus(`Cut ${t} event${t>1?"s":""}`)}pasteEvents(){if(!this.editor.media.audioBuffer){this.editor.ui.updateStatus("Load audio file first");return}if(this.clipboard.length===0){this.editor.ui.updateStatus("No events in clipboard");return}let t=this.calculatePastePosition(),e=this.clipboard[this.clipboard.length-1].time;if(t+e>this.editor.media.duration)if(this.clipboardFromCut&&this.lastPasteEndTime===null&&this.editor.input.hoverTime!==null&&(this.editor.input.isHoveringWaveform||this.editor.input.isHoveringTimeline)){if(t=Math.max(0,this.editor.media.duration-e-.1),t<0){this.editor.ui.updateStatus("Cannot paste: clipboard duration exceeds audio length");return}}else{this.editor.ui.updateStatus("Cannot paste: would exceed audio duration");return}this.selectedEventIndices=[];let i=[];this.clipboard.forEach(n=>{let a={time:parseFloat((t+n.time).toFixed(3)),intensity:n.intensity};this.script.push(a),i.push(a)}),this.script.sort((n,a)=>n.time-a.time),this.selectedEventIndices=i.map(n=>this.script.findIndex(a=>a===n)).filter(n=>n!==-1);let s=this.calculateEventSpacing();this.lastPasteEndTime=t+e+s,this.pasteCount++,this.clipboardFromCut=!1,this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.showHideInterpolationPanel(),this.editor.ui.updateStatus(`Pasted ${this.clipboard.length} event${this.clipboard.length>1?"s":""} at ${this.editor.media.formatTime(t)}`)}calculatePastePosition(){if(this.lastPasteEndTime!==null)return Math.min(this.lastPasteEndTime,this.editor.media.duration);if(this.pasteCount=0,this.selectedEventIndices.length>0){let i=this.selectedEventIndices.map(n=>this.script[n]).sort((n,a)=>a.time-n.time)[0].time,s=this.calculateEventSpacing();return Math.min(i+s,this.editor.media.duration)}if(this.editor.media.isPlaying){let e=this.calculateEventSpacing();return Math.min(this.editor.media.currentTime+e,this.editor.media.duration)}if(this.clipboardFromCut&&this.editor.input.hoverTime!==null&&(this.editor.input.isHoveringWaveform||this.editor.input.isHoveringTimeline))return this.editor.input.hoverTime;let t=(this.editor.canvas.viewportStart+this.editor.canvas.viewportEnd)/2;return Math.min(t,this.editor.media.duration)}calculateEventSpacing(){let t=.5;if(this.clipboard.length>1){let s=this.clipboard[this.clipboard.length-1].time;t=Math.max(.1,s*.1)}let e=this.editor.canvas.viewportEnd-this.editor.canvas.viewportStart,i=this.editor.media.duration/e;return i>10?t*=.5:i<2&&(t*=2),this.editor.media.duration>300?t*=1.5:this.editor.media.duration<60&&(t*=.5),Math.max(.05,Math.min(2,t))}clearPasteState(){this.lastPasteEndTime=null,this.pasteCount=0}updateScriptData(){this.editor.ui.elements.scriptData.value=JSON.stringify(this.getFunscript(),null,2)}clearScript(){confirm("Clear all script events?")&&(this.script=[],this.selectedEventIndices=[],this.clipboard=[],this.clearPasteState(),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.updateStatus("Script cleared"))}exportFunscript(){if(this.script.length===0){alert("No script events to export");return}let t=this.getFunscript(),e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");if(n.href=s,this.editor.media.originalFileName){let a=this.editor.media.originalFileName.replace(/\.[^/.]+$/,"");n.download=`${a}.funscript`}else n.download="lovense_script.funscript";n.click(),URL.revokeObjectURL(s),this.editor.ui.updateStatus("Funscript exported")}getFunscript(){let t=this.script.map(e=>({time:e.time,intensity:e.intensity}));for(;t.length>0&&t[0].intensity===0;)t.shift();return t=t.filter((e,i,s)=>i===0||e.intensity!==s[i-1].intensity),{actions:t.map(e=>({at:Math.round(e.time*1e3),pos:Math.round(100-e.intensity/20*100)}))}}validateScript(t){if(!Array.isArray(t))throw new Error("Invalid script format. Expected an array of events.");for(let e of t){if(typeof e.time!="number"||typeof e.intensity!="number")throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}importScript(t){if(!t)return;let e=new FileReader;e.onload=i=>{try{let s=JSON.parse(i.target.result),n;s.actions?n=s.actions.map(a=>({time:a.at/1e3,intensity:Math.round((100-a.pos)/100*20)})):(this.validateScript(s),n=s),this.script=n.sort((a,o)=>a.time-o.time),this.selectedEventIndices=[],this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.updateStatus(`Imported ${this.script.length} events from ${t.name}`)}catch(s){alert(`Error importing script file: ${s.message}`)}},e.readAsText(t)}updateScriptFromTextarea(){try{let t=this.editor.ui.elements.scriptData.value,e=JSON.parse(t),i;e.actions?i=e.actions.map(s=>({time:s.at/1e3,intensity:Math.round((100-s.pos)/100*20)})):(this.validateScript(e),i=e),this.script=i.sort((s,n)=>s.time-n.time),this.selectedEventIndices=[],this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.updateStatus(`Imported ${this.script.length} events`)}catch(t){alert(`Error importing script: ${t.message}`)}}getIntensityAtTime(t){if(this.script.length===0)return 0;for(this.lastIndex>0&&t<this.script[this.lastIndex-1].time&&(this.lastIndex=0);this.lastIndex<this.script.length&&this.script[this.lastIndex].time<=t;)this.lastIndex++;return this.lastIndex>0?this.script[this.lastIndex-1].intensity:0}generateInterpolation(){if(this.selectedEventIndices.length!==2)return;this.selectedEventIndices.sort((r,d)=>r-d);let[t,e]=this.selectedEventIndices,i={...this.script[t]},s={...this.script[e]},n=document.getElementById("interpolationType").value,a=[i];if(n==="linear"){let r=s.time-i.time,d=s.intensity-i.intensity;if(Math.abs(d)>0){let c=d/r,h=Math.sign(d);for(let l=i.intensity+h;l!==s.intensity;l+=h){let v=i.time+(l-i.intensity)/c;a.push({time:parseFloat(v.toFixed(3)),intensity:l})}}}else{let r=s.time-i.time,d=s.intensity-i.intensity,c=Math.max(20,Math.floor(r*50)),h=i.intensity;for(let l=1;l<c;l++){let v=l/c,p=this.applyEasing(v,n),m=Math.round(i.intensity+d*p),u=Math.max(0,Math.min(20,m));if(u!==h){let f=i.time+r*v;a.push({time:parseFloat(f.toFixed(3)),intensity:u}),h=u}}}a.push(s);let o=new P(this,t,e,a);this.editor.history.execute(o),this.selectedEventIndices=[],this.editor.ui.closeInterpolationPanel(),this.editor.ui.updateEventList(),this.updateScriptData(),this.editor.ui.updateStatus(`Generated ${a.length-2} new events between ${this.editor.media.formatTime(i.time)} and ${this.editor.media.formatTime(s.time)}`)}applyEasing(t,e){switch(e){case"easeIn":return t*t;case"easeOut":return 1-Math.pow(1-t,2);case"easeInOut":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"linear":default:return t}}};var F=class{constructor(t){this.editor=t,this.undoStack=[],this.redoStack=[]}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],this.editor.ui.updateVisualization()}undo(){if(this.undoStack.length>0){let t=this.undoStack.pop();t.undo(),this.redoStack.push(t),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData()}}redo(){if(this.redoStack.length>0){let t=this.redoStack.pop();t.execute(),this.undoStack.push(t),this.editor.ui.updateVisualization(),this.editor.ui.updateEventList(),this.editor.scriptManager.updateScriptData()}}};var $=class{constructor(){this.SCRIPT_TAG_DESCRIPTION="LVS_SCRIPT",this.SCRIPT_VERSION="0.1"}async extractScript(t){try{let e=new DataView(t),i=this.parseID3Header(e);if(!i)return console.log("No ID3v2 header found"),null;console.log(`Found ID3v2.${i.majorVersion}.${i.revision}, size: ${i.size}`);let s=this.findScriptFrame(e,i);return s?(console.log("Found embedded script data"),this.parseScriptData(s)):(console.log("No embedded script found"),null)}catch(e){return console.error("Error extracting script from ID3 tags:",e),null}}parseID3Header(t){if(t.getUint8(0)!==73||t.getUint8(1)!==68||t.getUint8(2)!==51)return null;let e=t.getUint8(3),i=t.getUint8(4),s=t.getUint8(5),n=this.parseSynchsafeInt(t,6);return e<3||e>4?(console.warn(`Unsupported ID3v2 version: ${e}.${i}`),null):{majorVersion:e,revision:i,flags:s,size:n,headerSize:10}}findScriptFrame(t,e){let i=e.headerSize,s=e.headerSize+e.size;for(;i<s-10;)try{let n=this.parseFrameHeader(t,i,e.majorVersion);if(!n)break;if(n.id==="TXXX"){let a=this.parseTXXXFrame(t,i+n.headerSize,n.size);if(a&&a.description===this.SCRIPT_TAG_DESCRIPTION)return a.text}i+=n.headerSize+n.size}catch(n){console.warn("Error parsing frame at offset",i,n);break}return null}parseFrameHeader(t,e,i){if(t.getUint8(e)===0)return null;let s=String.fromCharCode(t.getUint8(e),t.getUint8(e+1),t.getUint8(e+2),t.getUint8(e+3)),n,a,o;return i===4?(n=this.parseSynchsafeInt(t,e+4),a=t.getUint16(e+8),o=10):(n=t.getUint32(e+4),a=t.getUint16(e+8),o=10),n<0||n>1e6?null:{id:s,size:n,flags:a,headerSize:o}}parseTXXXFrame(t,e,i){if(i<2)return null;let s=t.getUint8(e),n=e+1,a=this.readNullTerminatedString(t,n,s);n+=a.byteLength+(s===0||s===3?1:2);let o=i-(n-e);if(o<=0)return null;let r=this.readString(t,n,o,s);return{description:a.text,text:r}}readNullTerminatedString(t,e,i){let s=e,n=[];if(i===0||i===3){for(;s<t.byteLength&&t.getUint8(s)!==0;)n.push(t.getUint8(s)),s++;return{text:new TextDecoder(i===0?"iso-8859-1":"utf-8").decode(new Uint8Array(n)),byteLength:n.length}}else{for(;s<t.byteLength-1;){let o=t.getUint8(s),r=t.getUint8(s+1);if(o===0&&r===0)break;n.push(o),n.push(r),s+=2}return{text:new TextDecoder("utf-16").decode(new Uint8Array(n)),byteLength:n.length}}}readString(t,e,i,s){let n=new Uint8Array(i);for(let a=0;a<i;a++)n[a]=t.getUint8(e+a);switch(s){case 0:return new TextDecoder("iso-8859-1").decode(n);case 1:return new TextDecoder("utf-16").decode(n);case 2:return new TextDecoder("utf-16be").decode(n);case 3:return new TextDecoder("utf-8").decode(n);default:return new TextDecoder("utf-8").decode(n)}}parseSynchsafeInt(t,e){return t.getUint8(e)<<21|t.getUint8(e+1)<<14|t.getUint8(e+2)<<7|t.getUint8(e+3)}parseScriptData(t){try{let e=JSON.parse(t);if(e.actions&&Array.isArray(e.actions)){let i=e.actions.map(s=>({time:s.at/1e3,intensity:Math.round((100-s.pos)/100*20)}));return this.validateScript(i),{version:e.version||"funscript",script:i}}else{if(e.version&&Array.isArray(e.script))return this.validateScript(e.script),e;if(Array.isArray(e))return this.validateScript(e),{version:"1.0",script:e};throw new Error("Invalid or unsupported script format")}}catch(e){return console.error("Error parsing embedded script:",e),null}}validateScript(t){for(let e of t){if(typeof e.time!="number"||typeof e.intensity!="number")throw new Error("Invalid event format - must have time and intensity numbers");if(e.intensity<0||e.intensity>20)throw new Error("Intensity must be between 0 and 20")}}async embedScript(t,e){try{let i=new DataView(t),s=JSON.stringify(e,null,2),n=this.parseID3Header(i),a;n?a=n.headerSize+n.size:a=0;let o=this.createID3Tag(s),r=t.slice(a),d=new ArrayBuffer(o.byteLength+r.byteLength),c=new Uint8Array(d);return c.set(new Uint8Array(o),0),c.set(new Uint8Array(r),o.byteLength),new Blob([d],{type:"audio/mpeg"})}catch(i){return console.error("Error embedding script in MP3:",i),null}}createID3Tag(t){let e=this.createTXXXFrame(this.SCRIPT_TAG_DESCRIPTION,t),i=e.byteLength,s=new ArrayBuffer(10),n=new DataView(s);n.setUint8(0,73),n.setUint8(1,68),n.setUint8(2,51),n.setUint8(3,3),n.setUint8(4,0),n.setUint8(5,0),this.writeSynchsafeInt(n,6,i);let a=new ArrayBuffer(10+i),o=new Uint8Array(a);return o.set(new Uint8Array(s),0),o.set(new Uint8Array(e),10),a}createTXXXFrame(t,e){let s=new TextEncoder().encode(t),n=new TextEncoder().encode(e),a=1+s.length+1+n.length,o=new ArrayBuffer(10+a),r=new DataView(o),d=new Uint8Array(o);r.setUint8(0,84),r.setUint8(1,88),r.setUint8(2,88),r.setUint8(3,88),r.setUint32(4,a),r.setUint16(8,0);let c=10;return d[c++]=3,d.set(s,c),c+=s.length,d[c++]=0,d.set(n,c),o}writeSynchsafeInt(t,e,i){t.setUint8(e,i>>21&127),t.setUint8(e+1,i>>14&127),t.setUint8(e+2,i>>7&127),t.setUint8(e+3,i&127)}};var z=class{constructor(){this.ui=new E(this),this.media=null,this.canvas=new b(this),this.input=new D(this),this.bluetooth=new B(this),this.scriptManager=new k(this),this.history=new F(this),this.id3Handler=new $,this.ui.updateStatus("Ready - Load a media file to begin"),window.canvas=this.canvas}async loadFile(t){try{if(t.type.startsWith("video/"))this.media=new L(this);else if(t.type.startsWith("audio/"))this.media=new C(this);else throw new Error("Unsupported file type");await this.media.loadFile(t)}catch(e){this.ui.updateStatus(`Error: ${e.message}`),console.error(e)}}};new z;})();
</script>
</body>

</html>